<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转 CRM  砖专转 转</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 专转 转 注专 Inter Font  拽 */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #F8FAFC; /* 专拽注 专 注 */
            color: #333333; /* 爪注 拽住 专砖 */
        }

        /*  住驻专 注 */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3B82F6; /*  Tailwind */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 住 专住 住住 */
        .card {
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid #E5E7EB; /*  拽 */
        }

        .card:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        /* 住 驻转专 住住 */
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-align: center;
        }

        .btn-primary {
            background-color: #3B82F6; /*  Tailwind */
            color: #FFFFFF;
        }

        .btn-primary:hover {
            background-color: #2563EB; /*   转专 */
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .btn-secondary {
            background-color: #E5E7EB; /* 驻专 专 */
            color: #4B5563;
        }

        .btn-secondary:hover {
            background-color: #D1D5DB; /* 驻专  转专 */
        }

        .btn-danger {
            background-color: #EF4444; /*  Tailwind */
            color: #FFFFFF;
        }

        .btn-danger:hover {
            background-color: #DC2626; /*   转专 */
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
        }

        /* 住 驻转专 驻注  */
        .action-btn {
            background: none;
            border: none;
            color: #6B7280;
            padding: 0.5rem;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
            border-radius: 6px;
            position: relative; /* 注专 tooltip 转 砖转 */
        }

        .action-btn:hover {
            color: #3B82F6; /*  专 */
            background-color: #EFF6FF; /* 专拽注 专 专 */
        }

        /* 住 转 */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #E5E7EB;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #FFFFFF;
        }

        th, td {
            padding: 1rem 1.25rem;
            text-align: right; /* 砖专  注专 注专转 */
            border-bottom: 1px solid #F3F4F6; /* 拽 驻专 拽 */
            white-space: nowrap; /* 注 砖专转 砖专转 */
        }

        th {
            background-color: #F9FAFB; /* 专拽注 转专转 */
            font-weight: 700;
            color: #4B5563;
            position: sticky; /* 拽转 转专转  */
            top: 0;
            z-index: 10;
        }

        tr:last-child td {
            border-bottom: none; /*  拽 驻专 砖专 专 */
        }

        /* 住转 住驻爪驻 住住 */
        .status-open { color: #22C55E; font-weight: 600; } /* 专拽 */
        .status-closed { color: #6B7280; font-weight: 600; } /* 驻专 */
        .status-overdue { color: #EF4444; font-weight: 600; } /*  */
        .status-warning { color: #F59E0B; font-weight: 600; } /* 转 */
        .status-pending { color: #3B82F6; font-weight: 600; } /*  */

        /* 住 砖专转 专转 110  */
        .overdue-110-days {
            background-color: #FEF2F2; /*  专 */
            color: #EF4444; /* 拽住  */
            font-weight: 600;
        }

        /* 住 砖专转 住专转 */
        .closed-order-row {
            background-color: #F9FAFB; /* 驻专 专  */
            color: #9CA3AF; /* 拽住 驻专  转专 */
            text-decoration: line-through; /* 拽 爪 拽住 */
        }
        .closed-order-row a, .closed-order-row button {
            pointer-events: none; /* 专 爪转 注 拽砖专 驻转专 */
            opacity: 0.7; /* 注注 驻转专 */
        }


        /* 住 Modal (Pop-up) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
            position: relative;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Modal   注专 转 */
        .modal-full-width {
            max-width: 95%; /* 注  专 住 */
            height: 90%;
            display: flex;
            flex-direction: column;
        }
        .modal-full-width .modal-body {
            flex-grow: 1;
            overflow-y: auto; /*  注专 转  */
            margin-top: 1rem;
        }


        .modal-close-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6B7280;
        }

        /* 住 Tooltip (转 砖转 驻转专) */
        .custom-tooltip {
            position: absolute;
            bottom: 125%; /* 注 驻转专 */
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 50; /* 注 砖专  */
        }

        .action-btn:hover .custom-tooltip {
            opacity: 1;
            visibility: visible;
        }


        /* 住 注专 转专砖 (D3) */
        .chart-container {
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            border: 1px solid #E5E7EB;
            height: 400px; /*  专专转  转专砖 */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .chart-container svg {
            width: 100%;
            height: 100%;
        }

        .chart-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.98); /* 专拽注 专 转专 住  */
            z-index: 99;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .chart-fullscreen svg {
            max-width: 90%;
            max-height: 90%;
            width: auto;
            height: auto;
        }

        .chart-fullscreen .close-fullscreen-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #4B5563;
            z-index: 10;
        }

        /* Pop-up 转专转 (toast messages) */
        #alert-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 110;
            display: flex;
            flex-direction: column-reverse; /* 爪 砖 注 */
            gap: 10px;
        }

        .alert-item {
            background-color: #FFFFFF;
            padding: 1rem 1.25rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* 爪 注拽 转专 */
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 350px;
            opacity: 0;
            transform: translateX(-100%);
            animation: slideIn 0.3s forwards ease-out;
            position: relative;
            border-left: 5px solid; /* 驻住 爪注 爪 */
        }

        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-item.alert-error { border-color: #EF4444; }
        .alert-item.alert-warning { border-color: #F59E0B; }
        .alert-item.alert-info { border-color: #3B82F6; }
        .alert-item.alert-success { border-color: #22C55E; }

        .alert-item .close-alert-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: #6B7280;
        }

        /* 注爪 砖转 拽 */
        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 1rem;
            color: #333333;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /*   */
        td {
            font-size: 0.95rem;
            color: #4B5563;
        }
        th {
            font-size: 0.9rem;
        }

        /* 住  注专 转专转 驻 */
        .page-header {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1F2937;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* 住 注专 住专   驻 */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            background-color: #EBF4FF; /* 专拽注 专  */
            border-radius: 12px;
            padding: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .nav-tab-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: #4B5563;
            background-color: transparent;
            border: none;
        }

        .nav-tab-btn.active {
            background-color: #3B82F6;
            color: #FFFFFF;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .nav-tab-btn:not(.active):hover {
            background-color: #DBEAFE; /* 专拽注 注 专   驻注 */
        }

        /* 驻转专 驻住 */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-table, #printable-table * {
                visibility: visible;
            }
            #printable-table {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- 住驻专 注 -->
    <div id="loader-overlay" class="loader-overlay hidden">
        <div class="loader"></div>
    </div>

    <!-- Container for Alerts -->
    <div id="alert-container"></div>

    <!-- Modal for Add/Edit Order -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeOrderModal()"><i class="fas fa-times"></i></button>
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700">住祝  砖</h2>
            <form id="order-form" class="space-y-4">
                <div>
                    <label for="转专 " class="block text-sm font-medium text-gray-700 mb-1">转专 </label>
                    <input type="date" id="转专 " name="转专 " class="form-input" required>
                </div>
                <div>
                    <label for="转注" class="block text-sm font-medium text-gray-700 mb-1">转注</label>
                    <input type="text" id="转注" name="转注" class="form-input" required>
                </div>
                <div>
                    <label for="砖 住" class="block text-sm font-medium text-gray-700 mb-1">砖 住</label>
                    <input type="text" id="砖 住" name="砖 住" class="form-input" required>
                </div>
                <div>
                    <label for="砖 拽" class="block text-sm font-medium text-gray-700 mb-1">砖 拽</label>
                    <input type="text" id="砖 拽" name="砖 拽" class="form-input" required>
                </div>
                <div>
                    <label for="转转" class="block text-sm font-medium text-gray-700 mb-1">转转</label>
                    <input type="text" id="转转" name="转转" class="form-input" required>
                </div>
                <div>
                    <label for="住 驻注" class="block text-sm font-medium text-gray-700 mb-1">住 驻注</label>
                    <select id="住 驻注" name="住 驻注" class="form-select" required>
                        <option value="专">专</option>
                        <option value="注">注</option>
                    </select>
                </div>
                <div>
                    <label for="住驻专 转" class="block text-sm font-medium text-gray-700 mb-1">住驻专 转 (驻专 驻住拽)</label>
                    <input type="text" id="住驻专 转" name="住驻专 转" class="form-input" required>
                </div>
                <div>
                    <label for="转专 住 爪驻" class="block text-sm font-medium text-gray-700 mb-1">转专 住 爪驻</label>
                    <input type="date" id="转专 住 爪驻" name="转专 住 爪驻" class="form-input">
                </div>
                <div>
                    <label for="注专转" class="block text-sm font-medium text-gray-700 mb-1">注专转</label>
                    <textarea id="注专转" name="注专转" rows="3" class="form-textarea"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()"></button>
                    <button type="submit" class="btn btn-primary">砖专 </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Close Order -->
    <div id="close-order-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeCloseOrderModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">住专 </h2>
            <p class="mb-4 text-gray-600"> 转  砖专爪 住专 转  住驻专 <span id="close-order-id" class="font-bold"></span>?</p>
            <div class="mb-4">
                <label for="close-notes" class="block text-sm font-medium text-gray-700 mb-1">注专转 住 (驻爪)</label>
                <textarea id="close-notes" rows="3" class="form-textarea"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" class="btn btn-secondary" onclick="closeCloseOrderModal()"></button>
                <button type="button" class="btn btn-primary" id="confirm-close-btn">砖专 住专</button>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeDeleteConfirmModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">砖专 拽</h2>
            <p class="mb-6 text-gray-600"> 转  砖专爪 拽 转  住驻专 <span id="delete-order-id" class="font-bold"></span>? 驻注  转 驻.</p>
            <div class="flex justify-end gap-3">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()"></button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">拽</button>
            </div>
        </div>
    </div>

    <!-- Modal for Overdue Customers -->
    <div id="overdue-customers-modal" class="modal-overlay">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeOverdueCustomersModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">拽转 专 砖专转</h2>
            <div class="modal-body table-container">
                <table id="overdue-customers-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>砖 拽</th>
                            <th>转注</th>
                            <th>转转</th>
                            <th> 砖注专</th>
                            <th>住驻专 转</th>
                            <th>注专转</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 注  -->
                    </tbody>
                </table>
                <p id="no-overdue-customers" class="text-center text-gray-500 mt-4 hidden"> 拽转 专 驻 专注. </p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeOverdueCustomersModal()">住专</button>
            </div>
        </div>
    </div>

    <!-- Modal for Customer History -->
    <div id="customer-history-modal" class="modal-overlay">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeCustomerHistoryModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">住专转 转 注专 <span id="history-customer-name"></span></h2>
            <div class="modal-body table-container">
                <table id="customer-history-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>转专 </th>
                            <th>转注</th>
                            <th>住 驻注</th>
                            <th>住驻专 转</th>
                            <th>住住</th>
                            <th> 砖注专</th>
                            <th>转专 住专</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 注  -->
                    </tbody>
                </table>
                <p id="no-customer-history" class="text-center text-gray-500 mt-4 hidden"> 住专转 转 注专 拽 .</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeCustomerHistoryModal()">住专</button>
            </div>
        </div>
    </div>


    <div class="min-h-screen flex flex-col p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="page-header">注专转 CRM 转</h1>
            <p class="text-lg text-gray-600"> 砖专转 转 拽转 注转</p>
        </header>

        <!-- 住专   驻 -->
        <nav class="nav-tabs">
            <button id="nav-dashboard" class="nav-tab-btn active" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt ml-2"></i> 砖专 转 转
            </button>
            <button id="nav-container-inventory" class="nav-tab-btn" onclick="showPage('container-inventory')">
                <i class="fas fa-boxes ml-2"></i>  转
            </button>
        </nav>

        <main class="flex-grow">
            <!-- 砖专 转 转 -->
            <section id="dashboard-page" class="page-content">
                <!-- 驻转专 注 -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div class="flex flex-wrap gap-3">
                        <button class="btn btn-primary" onclick="openOrderModal('add')">
                            <i class="fas fa-plus-circle ml-2"></i> 住祝  砖
                        </button>
                        <button class="btn btn-danger" onclick="openOverdueCustomersModal()">
                            <i class="fas fa-hand-paper ml-2"></i> 拽转 专 驻 <span id="overdue-customers-badge" class="mr-2 bg-white text-red-600 px-2 py-1 rounded-full text-xs font-bold">0</span>
                        </button>
                        <button class="btn btn-secondary" onclick="printTable()">
                            <i class="fas fa-print ml-2"></i> 驻住 
                        </button>
                        <button class="btn btn-secondary" onclick="exportToExcel()">
                            <i class="fas fa-file-excel ml-2"></i> 爪 拽住
                        </button>
                        <button class="btn btn-secondary" onclick="refreshData()">
                            <i class="fas fa-sync-alt ml-2"></i> 专注 转
                        </button>
                    </div>
                </div>

                <!-- 砖专 专住转 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">转 驻转转</p>
                            <p id="open-orders-count" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <i class="fas fa-box-open text-blue-500 text-4xl opacity-75"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">转 专转</p>
                            <p id="overdue-orders-count" class="text-3xl font-bold text-red-500 mt-1">0</p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl opacity-75"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">转 砖砖</p>
                            <p id="containers-in-use" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <i class="fas fa-truck-moving text-green-500 text-4xl opacity-75"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">拽转 驻注</p>
                            <p id="active-customers-count" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <i class="fas fa-users text-purple-500 text-4xl opacity-75"></i>
                    </div>
                </div>

                <!-- 转专砖 专转 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div id="chart-containers-by-customer" class="chart-container">
                        <button class="action-btn absolute top-3 left-3 z-10" onclick="toggleFullscreen('chart-containers-by-customer')">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                        <h3 class="text-lg font-bold mb-4 text-gray-700">转 砖砖 驻 拽</h3>
                    </div>
                    <div id="chart-status-pie" class="chart-container">
                        <button class="action-btn absolute top-3 left-3 z-10" onclick="toggleFullscreen('chart-status-pie')">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                        <h3 class="text-lg font-bold mb-4 text-gray-700">拽转 转 驻 住住</h3>
                    </div>
                </div>

                <!-- 转 转 转 -->
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700">专砖转 转</h2>

                    <!-- 住专 驻砖 住 -->
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <input type="text" id="search-input" placeholder="驻砖 驻 拽, 转注, 转转..."
                               class="flex-grow px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                               onkeyup="filterTable()">
                        <select id="filter-status" onchange="filterTable()"
                                class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="all"> 住住</option>
                            <option value="驻转">驻转</option>
                            <option value="专">专</option>
                            <option value="住专">住专</option>
                            <option value="转/ 转拽">转/ 转拽</option>
                        </select>
                        <select id="filter-action-type" onchange="filterTable()"
                                class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="all"> 住 驻注转</option>
                            <option value="专">专</option>
                            <option value="注">注</option>
                        </select>
                    </div>

                    <div class="table-container" id="printable-table">
                        <table id="orders-table">
                            <thead>
                                <tr>
                                    <th>转专 </th>
                                    <th>转注</th>
                                    <th>砖 住</th>
                                    <th>砖 拽</th>
                                    <th>转转</th>
                                    <th>住 驻注</th>
                                    <th> 砖注专</th>
                                    <th>住驻专 转</th>
                                    <th>住住</th>
                                    <th>注专转</th>
                                    <th>转专 住 爪驻</th>
                                    <th>注专转 住</th>
                                    <th>转专 住专</th>
                                    <th> 砖注专 (注转)</th>
                                    <th class="w-24">驻注转</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 转 转 注  爪注转 JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 祝  转 -->
            <section id="container-inventory-page" class="page-content hidden">
                <h2 class="page-header"> 转</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">转 砖砖 / 驻转</h3>
                    <div class="table-container">
                        <table id="inventory-table" class="min-w-full">
                            <thead>
                                <tr>
                                    <th>住驻专 </th>
                                    <th>住住</th>
                                    <th> 拽砖专</th>
                                    <th>拽 拽砖专</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 转  注  -->
                            </tbody>
                        </table>
                        <p id="no-containers-info" class="text-center text-gray-500 mt-4 hidden"> 转 转 爪.</p>
                    </div>
                </div>
            </section>

        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>&copy; 2025 注专转 CRM 转.  转 砖专转.</p>
        </footer>
    </div>

    <script>
        // TODO: 祝 转 SCRIPT_WEB_APP_URL 转转 -URL 砖 Web App 专 驻专住转 -Code.gs
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec';
        let allOrders = []; // 转  砖  转
        let currentEditingOrder = null; // 砖转 砖专转  注转 注专

        // 驻拽爪转 注专 转
        function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }

        /**
         * 爪 注转 Pop-up 砖转砖.
         * @param {string} message 注 爪.
         * @param {'success'|'error'|'warning'|'info'} type 住 注 (砖驻注 注 爪注).
         */
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertItem = document.createElement('div');
            alertItem.className = `alert-item alert-${type} flex items-center gap-2`;
            alertItem.innerHTML = `
                ${type === 'success' ? '<i class="fas fa-check-circle text-green-600"></i>' : ''}
                ${type === 'error' ? '<i class="fas fa-times-circle text-red-600"></i>' : ''}
                ${type === 'warning' ? '<i class="fas fa-exclamation-triangle text-orange-600"></i>' : ''}
                ${type === 'info' ? '<i class="fas fa-info-circle text-blue-600"></i>' : ''}
                <p class="text-sm font-medium text-gray-800 flex-grow">${message}</p>
                <button class="close-alert-btn" onclick="this.closest('.alert-item').remove()"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(alertItem);

            // 住专 转 转专 转 专 住驻专 砖转
            setTimeout(() => {
                alertItem.style.opacity = '0';
                alertItem.style.transform = 'translateX(-100%)';
                setTimeout(() => alertItem.remove(), 300); // 住专 -DOM 专 爪
            }, 5000);
        }

        /**
         * 砖 拽砖转 Fetch -Google Apps Script.
         * @param {string} action 驻注 爪注 -script (e.g., 'list', 'add').
         * @param {Object} params 驻专专 住驻 拽砖.
         * @returns {Promise<Object>} 拽 转 砖专转.
         */
        async function fetchData(action, params = {}) {
            showLoader();
            const urlParams = new URLSearchParams({ action, ...params });
            const url = `${SCRIPT_WEB_APP_URL}?${urlParams.toString()}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                hideLoader();
                if (!data.success) {
                    showAlert(data.message || '砖 爪注 驻注.', 'error');
                }
                return data;
            } catch (error) {
                hideLoader();
                console.error('砖转 Fetch:', error);
                showAlert('砖 转拽砖专转 注 砖专转: ' + error.message, 'error');
                return { success: false, message: '砖 转拽砖专转 注 砖专转: ' + error.message };
            }
        }

        /**
         * 注 转  转  注 转 -UI.
         */
        async function loadOrders() {
            const response = await fetchData('list', { status: 'all' });
            if (response.success) {
                allOrders = response.data;
                updateDashboard();
                filterTable(); // 拽专 驻拽爪转 住  专专 转  注 转  转
                checkAlerts(allOrders); // 驻注 拽转 转专转
                drawCharts(allOrders); // 爪专 转专砖
                updateContainerInventory(); // 注  转
            }
        }

        /**
         * 注 转 专住转 砖专.
         */
        function updateDashboard() {
            const openOrders = allOrders.filter(o => o['住住'] !== '住专' && o['住住'] !== '转/ 转拽');
            const overdueOrders = allOrders.filter(o => o['住住'] === '专');

            const containersInUse = new Set();
            openOrders.forEach(order => { // 专拽 转 驻转转/专转
                if (order['住 驻注'] === '专' && order['住驻专 转'] !== undefined && order['住驻专 转'] !== null) {
                    (order['住驻专 转'] || '').toString().split(',').forEach(container => {
                        const trimmedContainer = container.trim();
                        if (trimmedContainer) {
                            containersInUse.add(trimmedContainer);
                        }
                    });
                }
            });

            const activeCustomers = new Set();
            openOrders.forEach(order => {
                if (order['砖 拽']) {
                    activeCustomers.add(order['砖 拽'].trim());
                }
            });

            document.getElementById('open-orders-count').textContent = openOrders.length;
            document.getElementById('overdue-orders-count').textContent = overdueOrders.length;
            document.getElementById('containers-in-use').textContent = containersInUse.size;
            document.getElementById('active-customers-count').textContent = activeCustomers.size;

            // 注 ' 砖 "拽转 专 驻"
            document.getElementById('overdue-customers-badge').textContent = overdueOrders.length;
        }

        /**
         * 专专 转 转 转 -UI.
         * @param {Array<Object>} ordersToRender 转 爪 .
         */
        function renderOrdersTable(ordersToRender) {
            const tableBody = document.querySelector('#orders-table tbody');
            tableBody.innerHTML = ''; // 拽 转 拽

            ordersToRender.forEach(order => {
                const row = tableBody.insertRow();
                row.style.cursor = 'pointer'; // 驻 转 砖专 爪
                row.onclick = () => showCustomerHistory(order['砖 拽'], order['转转']); // 驻注 住专转 拽 爪

                // 住 砖专转 住专转
                if (order['住住'] === '住专') {
                    row.classList.add('closed-order-row');
                }

                // 住 砖专转 专转 110 
                if (order['住住'] !== '住专' && order[' 砖注专'] && parseInt(order[' 砖注专']) > 110) {
                    row.classList.add('overdue-110-days');
                }


                row.insertCell().textContent = formatDate(order['转专 ']);
                const docIdCell = row.insertCell();
                docIdCell.innerHTML = `
                    <div class="tooltip-container">
                        ${order['转注']}
                        <span class="tooltip-text">砖 住: ${order['砖 住'] || ''}</span>
                    </div>
                `;
                row.insertCell().textContent = order['砖 住'] || '';
                row.insertCell().textContent = order['砖 拽'] || '';
                row.insertCell().textContent = order['转转'] || '';
                row.insertCell().textContent = order['住 驻注'] || '';
                row.insertCell().textContent = order[' 砖注专'] !== undefined ? order[' 砖注专'] : '';
                row.insertCell().textContent = order['住驻专 转'] || '';

                const statusCell = row.insertCell();
                let statusClass = '';
                switch (order['住住']) {
                    case '驻转': statusClass = 'status-open'; break;
                    case '住专': statusClass = 'status-closed'; break;
                    case '专': statusClass = 'status-overdue'; break;
                    case '转/ 转拽': statusClass = 'status-pending'; break;
                    default: statusClass = 'status-warning'; break;
                }
                statusCell.innerHTML = `<span class="${statusClass}">${order['住住'] || ''}</span>`;

                row.insertCell().textContent = order['注专转'] || '';
                row.insertCell().textContent = formatDate(order['转专 住 爪驻']);
                row.insertCell().textContent = order['注专转 住'] || '';
                row.insertCell().textContent = formatDate(order['转专 住专']);
                row.insertCell().textContent = order[' 砖注专 (注转)'] !== undefined ? order[' 砖注专 (注转)'] : '';


                const actionsCell = row.insertCell();
                actionsCell.className = 'flex gap-1 justify-center items-center';
                actionsCell.innerHTML = `
                    <button class="action-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})">
                        <i class="fas fa-edit"></i>
                        <span class="custom-tooltip">注专 </span>
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})">
                        <i class="fas fa-copy"></i>
                        <span class="custom-tooltip">砖驻 </span>
                    </button>
                    ${order['住住'] !== '住专' ? `
                    <button class="action-btn" onclick="event.stopPropagation(); openCloseOrderModal(${order.sheetRow}, '${order['转注']}')">
                        <i class="fas fa-check-circle text-green-600"></i>
                        <span class="custom-tooltip">住专 </span>
                    </button>` : ''}
                    <button class="action-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['转注']}')">
                        <i class="fas fa-trash-alt text-red-600"></i>
                        <span class="custom-tooltip">拽 </span>
                    </button>
                `;
            });
        }

        /**
         * 驻专 转专 转爪 .
         * @param {Date|string} dateInput 转专  专转 转专.
         * @returns {string} 转专 驻专 DD/MM/YYYY.
         */
        function formatDate(dateInput) {
            if (!dateInput) return '';
            const date = new Date(dateInput);
            if (isNaN(date)) return dateInput; //   转专 转拽, 专 转 拽 拽专
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        /**
         * 驻转 转 Modal 住驻/注专  转  专砖.
         * @param {'add'|'edit'} mode 爪 驻注 (住驻  注专).
         * @param {number} [sheetRow] 住驻专 砖专  注专 注专.
         */
        function openOrderModal(mode, sheetRow = null) {
            const modal = document.getElementById('order-modal');
            const form = document.getElementById('order-form');
            const modalTitle = document.getElementById('modal-title');
            form.reset(); // 驻住 驻住

            currentEditingOrder = null; // 驻住  注专转

            if (mode === 'add') {
                modalTitle.textContent = '住祝  砖';
                form.onsubmit = (e) => { e.preventDefault(); addOrder(); };
                // 专 转专  转 转专 
                document.getElementById('转专 ').valueAsDate = new Date();
            } else if (mode === 'edit' && sheetRow) {
                modalTitle.textContent = '注专 ';
                // 爪 转  -allOrders 驻 sheetRow
                currentEditingOrder = allOrders.find(order => order.sheetRow === sheetRow);
                if (currentEditingOrder) {
                    //  驻住 转 拽
                    for (const key in currentEditingOrder) {
                        const input = document.getElementById(key);
                        if (input) {
                            if (input.type === 'date' && currentEditingOrder[key]) {
                                // 专 驻专 YYYY-MM-DD 转专 HTML input
                                const date = new Date(currentEditingOrder[key]);
                                if (!isNaN(date)) {
                                    input.value = date.toISOString().split('T')[0];
                                }
                            } else {
                                input.value = currentEditingOrder[key];
                            }
                        }
                    }
                    form.onsubmit = (e) => { e.preventDefault(); editOrder(sheetRow); };
                } else {
                    showAlert(' 注专  爪.', 'error');
                    return;
                }
            }
            modal.classList.add('active');
        }

        /**
         * 住专 转 Modal 住驻/注专.
         */
        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
            document.getElementById('order-form').reset();
            currentEditingOrder = null;
        }

        /**
         * 住祝  砖 .
         */
        async function addOrder() {
            const form = document.getElementById('order-form');
            const formData = new FormData(form);
            const orderData = {};
            for (const [key, value] of formData.entries()) {
                orderData[key] = value;
            }

            // 专 转 驻专 转专 -YYYY-MM-DD 驻 砖 砖专转
            if (orderData['转专 ']) {
                const date = new Date(orderData['转专 ']);
                orderData['转专 '] = date.toLocaleDateString('en-CA'); // YYYY-MM-DD
            }
            if (orderData['转专 住 爪驻']) {
                const date = new Date(orderData['转专 住 爪驻']);
                orderData['转专 住 爪驻'] = date.toLocaleDateString('en-CA'); // YYYY-MM-DD
            }

            const response = await fetchData('add', { data: JSON.stringify(orderData) });
            if (response.success) {
                showAlert(response.message, 'success');
                closeOrderModal();
                loadOrders(); // 专注 转 专 住驻
            }
        }

        /**
         * 注专  拽转 .
         * @param {number} sheetRow 住驻专 砖专  注专.
         */
        async function editOrder(sheetRow) {
            const form = document.getElementById('order-form');
            const formData = new FormData(form);
            const updateData = {};
            for (const [key, value] of formData.entries()) {
                // 专拽  注专 砖转      拽 拽专 (砖, 砖 专拽 砖 专拽 砖专 专拽)
                if (currentEditingOrder[key] !== value) {
                    updateData[key] = value;
                }
            }

            // 专 转 驻专 转专 -YYYY-MM-DD 驻 砖 砖专转
            if (updateData['转专 ']) {
                const date = new Date(updateData['转专 ']);
                updateData['转专 '] = date.toLocaleDateString('en-CA');
            }
            if (updateData['转专 住 爪驻']) {
                const date = new Date(updateData['转专 住 爪驻']);
                updateData['转专 住 爪驻'] = date.toLocaleDateString('en-CA');
            }

            const response = await fetchData('edit', { id: sheetRow, data: JSON.stringify(updateData) });
            if (response.success) {
                showAlert(response.message, 'success');
                closeOrderModal();
                loadOrders(); // 专注 转 专 注专
            }
        }

        /**
         * 驻转 转 Modal 住专转 .
         * @param {number} sheetRow 住驻专 砖专  住专.
         * @param {string} orderId 转注转 .
         */
        function openCloseOrderModal(sheetRow, orderId) {
            document.getElementById('close-order-id').textContent = orderId;
            document.getElementById('close-notes').value = ''; // 驻住 注专转
            document.getElementById('confirm-close-btn').onclick = () => confirmCloseOrder(sheetRow);
            document.getElementById('close-order-modal').classList.add('active');
        }

        /**
         * 住专 转 Modal 住专转 .
         */
        function closeCloseOrderModal() {
            document.getElementById('close-order-modal').classList.remove('active');
        }

        /**
         * 砖专 住专 .
         * @param {number} sheetRow 住驻专 砖专  住专.
         */
        async function confirmCloseOrder(sheetRow) {
            const notes = document.getElementById('close-notes').value;
            const response = await fetchData('close', { id: sheetRow, notes: notes });
            if (response.success) {
                showAlert(response.message, 'success');
                closeCloseOrderModal();
                loadOrders(); // 专注 转 专 住专
            }
        }

        /**
         * 驻转 转 Modal 砖专 拽.
         * @param {number} sheetRow 住驻专 砖专  拽.
         * @param {string} orderId 转注转 .
         */
        function openDeleteConfirmModal(sheetRow, orderId) {
            document.getElementById('delete-order-id').textContent = orderId;
            document.getElementById('confirm-delete-btn').onclick = () => deleteOrder(sheetRow);
            document.getElementById('delete-confirm-modal').classList.add('active');
        }

        /**
         * 住专 转 Modal 砖专 拽.
         */
        function closeDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').classList.remove('active');
        }

        /**
         * 拽  .
         * @param {number} sheetRow 住驻专 砖专  拽.
         */
        async function deleteOrder(sheetRow) {
            const response = await fetchData('delete', { id: sheetRow });
            if (response.success) {
                showAlert(response.message, 'success');
                closeDeleteConfirmModal();
                loadOrders(); // 专注 转 专 拽
            }
        }

        /**
         * 砖驻  拽转.
         * @param {number} sheetRow 住驻专 砖专  砖驻.
         */
        async function duplicateOrder(sheetRow) {
            const response = await fetchData('duplicate', { id: sheetRow });
            if (response.success) {
                showAlert(response.message, 'success');
                loadOrders(); // 专注 转 专 砖驻
            }
        }

        /**
         * 住 转  驻 拽 驻砖 住.
         */
        function filterTable() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const filterStatus = document.getElementById('filter-status').value;
            const filterActionType = document.getElementById('filter-action-type').value;

            const filtered = allOrders.filter(order => {
                const matchesSearch =
                    (order['砖 拽'] || '').toLowerCase().includes(searchText) ||
                    (order['转注'] || '').toLowerCase().includes(searchText) ||
                    (order['转转'] || '').toLowerCase().includes(searchText) ||
                    (order['注专转'] || '').toLowerCase().includes(searchText);

                const matchesStatus = filterStatus === 'all' || order['住住'] === filterStatus;
                const matchesActionType = filterActionType === 'all' || order['住 驻注'] === filterActionType;

                return matchesSearch && matchesStatus && matchesActionType;
            });

            renderOrdersTable(filtered);
        }

        /**
         * 拽 驻转 专转 爪 转专转 Pop-up.
         * @param {Array<Object>} orders 专砖转 转 转.
         */
        function checkAlerts(orders) {
            const activeOrders = orders.filter(o => o['住住'] !== '住专');
            const customerCounts = {};
            const containerUsage = {}; // { containerNum: [order1, order2...] }
            const docIdCounts = {}; // { docId: [order1, order2...] }

            activeOrders.forEach(order => {
                // 拽转 拽转 驻 驻注
                const customerName = order['砖 拽'].trim();
                customerCounts[customerName] = (customerCounts[customerName] || 0) + 1;

                // 拽转 住驻专 转注 驻 转 驻注转
                const docId = order['转注'].trim();
                if (docId) {
                    if (!docIdCounts[docId]) {
                        docIdCounts[docId] = [];
                    }
                    docIdCounts[docId].push(order);
                }

                // 拽转 转 驻转
                if (order['住驻专 转'] !== undefined && order['住驻专 转'] !== null) {
                    (order['住驻专 转'] || '').toString().split(',').forEach(container => {
                        const trimmedContainer = container.trim();
                        if (trimmedContainer) {
                            if (!containerUsage[trimmedContainer]) {
                                containerUsage[trimmedContainer] = [];
                            }
                            containerUsage[trimmedContainer].push(order);
                        }
                    });
                }

                // 拽转 专转  砖专转 ( 转专 住 爪驻  专)
                if (order['住住'] === '专') {
                    showAlert(` 专转: 转注 ${order['转注']} 砖 拽 ${order['砖 拽']} 专转 转专 爪驻.`, 'warning');
                }
            });

            // 爪 转专转 注 拽转 驻
            for (const customer in customerCounts) {
                if (customerCounts[customer] > 1) {
                    showAlert(`拽 驻 驻注: '${customer}' 驻注 -${customerCounts[customer]} 转 驻转转.`, 'warning');
                }
            }

            // 爪 转专转 注 住驻专 转注 驻
            for (const docId in docIdCounts) {
                if (docIdCounts[docId].length > 1) {
                    const conflictingOrders = docIdCounts[docId].map(o => o['砖 拽']).join(', ');
                    showAlert(`专: 住驻专 转注 '${docId}' 驻注 -${docIdCounts[docId].length} 转 驻转转 (拽转: ${conflictingOrders}).`, 'error');
                }
            }

            // 爪 转专转 注 转 驻转 (砖砖 -转)
            for (const container in containerUsage) {
                if (containerUsage[container].length > 1) {
                    const conflictingOrders = containerUsage[container].map(o => o['转注']).join(', ');
                    showAlert(` '${container}' 爪转 砖砖 转专  转 驻注: ${conflictingOrders}`, 'error');
                }
            }
        }

        /**
         * 爪专 转 专祝 转 砖砖 驻 拽转.
         * @param {Array<Object>} orders 转 转.
         */
        function drawContainersByCustomerChart(orders) {
            const chartDiv = d3.select("#chart-containers-by-customer");
            chartDiv.select("svg").remove(); // 拽 SVG 拽

            const activeOrders = orders.filter(o => o['住住'] !== '住专' && o['住住'] !== '转/ 转拽');
            const customerContainerCounts = {}; // { customer: count }
            activeOrders.forEach(order => {
                const customerName = order['砖 拽'];
                if (order['住驻专 转'] !== undefined && order['住驻专 转'] !== null) {
                    const numContainers = (order['住驻专 转'] || '').toString().split(',').filter(c => c.trim() !== '').length;
                    customerContainerCounts[customerName] = (customerContainerCounts[customerName] || 0) + numContainers;
                }
            });

            const data = Object.entries(customerContainerCounts).map(([customer, count]) => ({ customer, count }));
            data.sort((a, b) => b.count - a.count); //   拽

            if (data.length === 0) {
                 chartDiv.append("p").attr("class", "text-gray-500").text(" 转 转 砖砖 爪.");
                 return;
            }

            const margin = { top: 20, right: 20, bottom: 80, left: 60 }; //  砖 转转 转转
            const bounds = chartDiv.node().getBoundingClientRect();
            const width = bounds.width - margin.left - margin.right;
            const height = bounds.height - margin.top - margin.bottom;

            const svg = chartDiv.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.customer))
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(data, d => d.count) * 1.1]); //  拽爪转 转 -domain  砖 专

            // 爪专 X (拽转)
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            // 爪专 Y (住驻专 转)
            svg.append("g")
                .call(d3.axisLeft(y));

            // 驻住 (专)
            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.customer))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d.count))
                .attr("height", d => height - y(d.count))
                .attr("fill", "#3B82F6"); // 爪注 
        }

        /**
         * 爪专 转 专转 注 砖 拽转 住住.
         * @param {Array<Object>} orders 转 转.
         */
        function drawStatusPieChart(orders) {
            const chartDiv = d3.select("#chart-status-pie");
            chartDiv.select("svg").remove(); // 拽 SVG 拽

            const statusCounts = {};
            orders.forEach(order => {
                const status = order['住住'] || ' 注';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const data = Object.entries(statusCounts).map(([status, count]) => ({ status, count }));

            if (data.length === 0) {
                chartDiv.append("p").attr("class", "text-gray-500").text(" 转 住住 爪.");
                return;
            }

            const bounds = chartDiv.node().getBoundingClientRect();
            const radius = Math.min(bounds.width, bounds.height) / 2 - 20;

            const svg = chartDiv.append("svg")
                .attr("width", bounds.width)
                .attr("height", bounds.height)
                .append("g")
                .attr("transform", `translate(${bounds.width / 2},${bounds.height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.status))
                .range(d3.schemeCategory10); // 注专转 爪注 住专转

            const pie = d3.pie()
                .value(d => d.count);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const arcs = svg.selectAll("arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.status));

            // 转转 住住 
            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("text-anchor", "middle")
                .text(d => `${d.data.status} (${((d.data.count / orders.length) * 100).toFixed(1)}%)`)
                .style("fill", "white")
                .style("font-size", "12px")
                .style("pointer-events", "none"); //  驻专注 专拽爪

             // 住祝 拽专 (')
            const legend = svg.selectAll(".legend")
                .data(color.domain())
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(${radius + 20},${-radius / 2 + i * 20})`); // 拽 拽专

            legend.append("rect")
                .attr("x", 0)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", color);

            legend.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "start")
                .text(d => d);
        }

        /**
         * 爪专 转  转专砖.
         * @param {Array<Object>} orders 转 转.
         */
        function drawCharts(orders) {
            drawContainersByCustomerChart(orders);
            drawStatusPieChart(orders);
        }

        /**
         * 驻注/ 爪 住  转专砖.
         * @param {string} chartId  -div 砖 转专砖.
         */
        function toggleFullscreen(chartId) {
            const chartElement = document.getElementById(chartId);
            chartElement.classList.toggle('chart-fullscreen');

            if (chartElement.classList.contains('chart-fullscreen')) {
                // 住祝 驻转专 住专 爪 住 
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-fullscreen-btn';
                closeBtn.innerHTML = '<i class="fas fa-compress-alt"></i>';
                closeBtn.onclick = () => toggleFullscreen(chartId);
                chartElement.appendChild(closeBtn);
            } else {
                // 住专 驻转专 住专
                const closeBtn = chartElement.querySelector('.close-fullscreen-btn');
                if (closeBtn) {
                    closeBtn.remove();
                }
            }
            // 爪专 砖 转 转专砖  转  砖
            drawCharts(allOrders);
        }

        /**
         * 爪 转 转  爪 拽抓 拽住 (CSV).
         */
        function exportToExcel() {
            const table = document.getElementById('orders-table');
            const rows = Array.from(table.querySelectorAll('tr'));

            if (rows.length <= 1) { // 专拽 转专转  专拽
                showAlert(' 转 爪.', 'warning');
                return;
            }

            const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim());
            // 住专 转 注转 "驻注转" 转专转 爪
            const filteredHeaders = headers.filter(header => header !== '驻注转');

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // UTF-8 BOM for Hebrew support
            csvContent += filteredHeaders.join(',') + '\n';

            // 注专 注 砖专转 爪转  ( -allOrders )
            for (let i = 1; i < rows.length; i++) {
                const rowCells = Array.from(rows[i].querySelectorAll('td'));
                const rowData = filteredHeaders.map(header => {
                    const headerIndex = headers.indexOf(header);
                    let value = rowCells[headerIndex] ? rowCells[headerIndex].textContent.trim() : '';

                    // 住专 拽 爪 拽住 注专 砖专转 住专转
                    if (rows[i].classList.contains('closed-order-row')) {
                        value = value.replace(/[\u0305\u0336]/g, ''); // 住专转 转 砖 拽 爪 拽住
                    }

                    // 驻 驻住拽 转 砖转 - 注祝 专砖
                    value = value.replace(/"/g, '""'); // Escaping double quotes
                    if (value.includes(',')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvContent += rowData.join(',') + '\n';
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "orders_table_data.csv"); // 砖 拽抓 砖爪注 注 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAlert('转 爪 拽住 爪!', 'success');
        }

        /**
         * 驻住 转 转 转 爪转.
         */
        function printTable() {
            const currentTableBody = document.querySelector('#orders-table tbody');
            if (currentTableBody.rows.length === 0) {
                showAlert(' 转 驻住.', 'warning');
                return;
            }
            window.print();
        }

        /**
         * 驻转 转 Modal 拽转 专.
         */
        function openOverdueCustomersModal() {
            const modal = document.getElementById('overdue-customers-modal');
            const tableBody = document.querySelector('#overdue-customers-table tbody');
            const noCustomersMsg = document.getElementById('no-overdue-customers');
            tableBody.innerHTML = '';
            noCustomersMsg.classList.add('hidden');

            const overdueCustomers = allOrders.filter(o => o['住住'] === '专');

            if (overdueCustomers.length === 0) {
                noCustomersMsg.classList.remove('hidden');
            } else {
                //  驻  砖注专 ( 拽)
                overdueCustomers.sort((a, b) => (parseInt(b[' 砖注专']) || 0) - (parseInt(a[' 砖注专']) || 0));

                overdueCustomers.forEach(order => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = order['砖 拽'] || '';
                    row.insertCell().textContent = order['转注'] || '';
                    row.insertCell().textContent = order['转转'] || '';
                    row.insertCell().textContent = order[' 砖注专'] || '';
                    row.insertCell().textContent = order['住驻专 转'] || '';
                    row.insertCell().textContent = order['注专转'] || '';
                    // 转 住祝 驻转专 驻注  "爪专 拽砖专"
                });
            }
            modal.classList.add('active');
        }

        /**
         * 住专 转 Modal 拽转 专.
         */
        function closeOverdueCustomersModal() {
            document.getElementById('overdue-customers-modal').classList.remove('active');
        }

        /**
         * 爪 住专转 转 注专 拽 住驻爪驻.
         * @param {string} customerName 砖 拽.
         * @param {string} customerAddress 转转 拽.
         */
        function showCustomerHistory(customerName, customerAddress) {
            const modal = document.getElementById('customer-history-modal');
            const tableBody = document.querySelector('#customer-history-table tbody');
            const noHistoryMsg = document.getElementById('no-customer-history');
            document.getElementById('history-customer-name').textContent = customerName;
            tableBody.innerHTML = '';
            noHistoryMsg.classList.add('hidden');

            const customerHistory = allOrders.filter(order =>
                order['砖 拽'].trim() === customerName.trim() &&
                order['转转'].trim() === customerAddress.trim()
            ).sort((a, b) => new Date(b['转专 ']) - new Date(a['转专 '])); //  砖 砖

            if (customerHistory.length === 0) {
                noHistoryMsg.classList.remove('hidden');
            } else {
                customerHistory.forEach(order => {
                    const row = tableBody.insertRow();
                    if (order['住住'] === '住专') {
                        row.classList.add('closed-order-row'); //  驻 砖 住专
                    }
                    row.insertCell().textContent = formatDate(order['转专 ']);
                    row.insertCell().textContent = order['转注'] || '';
                    row.insertCell().textContent = order['住 驻注'] || '';
                    row.insertCell().textContent = order['住驻专 转'] || '';
                    row.insertCell().innerHTML = `<span class="${order['住住'] === '驻转' ? 'status-open' : order['住住'] === '专' ? 'status-overdue' : 'status-closed'}">${order['住住'] || ''}</span>`;
                    row.insertCell().textContent = order[' 砖注专'] || '';
                    row.insertCell().textContent = formatDate(order['转专 住专']);
                });
            }
            modal.classList.add('active');
        }

        /**
         * 住专 转 Modal 住专转 拽.
         */
        function closeCustomerHistoryModal() {
            document.getElementById('customer-history-modal').classList.remove('active');
        }

        /**
         * 注 转 祝  转.
         */
        function updateContainerInventory() {
            const inventoryTableBody = document.querySelector('#inventory-table tbody');
            const noContainersMsg = document.getElementById('no-containers-info');
            inventoryTableBody.innerHTML = '';
            noContainersMsg.classList.add('hidden');

            // Map to store the latest state for each container.
            // Keys: container number. Values: { status, relatedOrderDocId, relatedCustomer, latestEventDate }
            const containerStates = {};

            // Sort orders by '转专 ' (ascending) to process events chronologically.
            // For same dates, use '转注' as a tie-breaker for consistent results.
            const sortedOrders = [...allOrders].sort((a, b) => {
                const dateA = new Date(a['转专 ']);
                const dateB = new Date(b['转专 ']);

                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA - dateB;
                }
                return (a['转注'] || '').localeCompare(b['转注'] || '');
            });

            sortedOrders.forEach(order => {
                const containers = (order['住驻专 转'] || '').toString().split(',').map(c => c.trim()).filter(c => c);
                const orderDate = new Date(order['转专 ']);

                containers.forEach(container => {
                    // Get current state for this container, or initialize it
                    const currentState = containerStates[container] || {
                        status: ' 注',
                        relatedOrderDocId: '',
                        relatedCustomer: '',
                        latestEventDate: null
                    };

                    // Only update the state if this order is chronologically later than the last recorded event
                    if (!currentState.latestEventDate || orderDate.getTime() >= currentState.latestEventDate.getTime()) {
                        currentState.latestEventDate = orderDate; // Update the latest event date

                        if (order['住 驻注'] === '专') {
                            if (order['住住'] === '住专') {
                                // A closed "专" order means this specific rental is finished.
                                // The container should now be considered available unless a later active "专" exists.
                                // Since we process chronologically, if this is the latest for this container, it's available.
                                currentState.status = '驻';
                            } else {
                                // An open or overdue "专" order means the container is currently in use.
                                currentState.status = '砖砖';
                            }
                        } else if (order['住 驻注'] === '注') {
                            if (order['住住'] === '住专') {
                                // A closed "注" definitively means the container has returned and is available.
                                currentState.status = '驻';
                            } else {
                                // An open or overdue "注" order means the container is currently in the process of being returned.
                                currentState.status = '转 专'; // New status for clarity
                            }
                        }

                        // Update related order details
                        currentState.relatedOrderDocId = order['转注'];
                        currentState.relatedCustomer = order['砖 拽'];
                    }
                    containerStates[container] = currentState; // Store the updated state
                });
            });

            // Prepare data for display in the inventory table.
            // Filter out containers with ' 注' status if desired, though current logic aims to define all.
            const containersData = Object.entries(containerStates).map(([containerNum, state]) => ({
                containerNum,
                status: state.status,
                relatedOrderDocId: state.relatedOrderDocId || '',
                relatedCustomer: state.relatedCustomer || ''
            }));

            // Sort containers by number for consistent display
            containersData.sort((a, b) => a.containerNum.localeCompare(b.containerNum));

            if (containersData.length === 0) {
                noContainersMsg.classList.remove('hidden');
            } else {
                containersData.forEach(item => {
                    const row = inventoryTableBody.insertRow();
                    let statusClass = '';
                    if (item.status === '砖砖') {
                        statusClass = 'status-overdue'; // Red for in use
                    } else if (item.status === '驻') {
                        statusClass = 'status-open'; // Green for available
                    } else if (item.status === '转 专') {
                        statusClass = 'status-warning'; // Orange for in return process
                    } else {
                        statusClass = 'status-pending'; // For ' 注' or other states
                    }

                    row.insertCell().textContent = item.containerNum;
                    row.insertCell().innerHTML = `<span class="${statusClass}">${item.status}</span>`;
                    row.insertCell().textContent = item.relatedOrderDocId;
                    row.insertCell().textContent = item.relatedCustomer;
                });
            }
        }


        /**
         * 专注 转  转 转 -UI.
         */
        function refreshData() {
            loadOrders();
            showAlert('转 专注.', 'info');
        }

        /**
         * 爪 转 祝 专 注 转 驻转专 .
         * @param {string} pageId  -HTML 砖 祝 (e.g., 'dashboard', 'container-inventory').
         */
        function showPage(pageId) {
            // 住转专 转  驻
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            // 住专 active  驻转专 
            document.querySelectorAll('.nav-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 爪 转 祝 专 驻注 转 驻转专  转
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            document.getElementById(`nav-${pageId}`).classList.add('active');

            //  砖转专砖 转专专 砖 砖专 砖专 驻注
            if (pageId === 'dashboard') {
                drawCharts(allOrders);
            }
            //  砖 转 转专专 砖 砖专 祝 砖 驻注
            if (pageId === 'container-inventory') {
                updateContainerInventory();
            }
        }


        // 注 转 注转 注转 祝
        window.onload = () => {
            loadOrders();
            showPage('dashboard'); // 爪 转 砖专 祝 专专转 
        };

        // 转 转  转专砖 注转 砖  
        window.addEventListener('resize', () => {
            if (!document.querySelector('.chart-fullscreen')) { // 专拽   爪 住 
                // 拽  祝 砖专 驻注 驻 爪专 转专砖
                if (!document.getElementById('dashboard-page').classList.contains('hidden')) {
                    drawCharts(allOrders);
                }
            }
        });
    </script>
</body>
</html>
