<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת CRM לניהול מכולות</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0e7ff; /* גוון סגול בהיר מאוד לרקע כללי - בהשראת Glassmorphism */
            direction: rtl; /* Right-to-left for Hebrew */
            text-align: right; /* Align text right for RTL */
            min-height: 100vh; /* ודא שהגוף תופס לפחות את גובה המסך */
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1; /* מאפשר לתוכן המרכזי לתפוס את השטח הזמין */
        }

        /* Glassmorphism Base Styles */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.2); /* שקיפות עדינה */
            backdrop-filter: blur(10px); /* אפקט טשטוש */
            border: 1px solid rgba(255, 255, 255, 0.3); /* מסגרת שקופה */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Shadow enhancement */
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth transitions for hover */
            position: relative;
            overflow: hidden; /* For glow effect */
        }
        .glass-card:hover {
            transform: translateY(-5px); /* Lift effect on hover */
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.15), 0 4px 8px -2px rgba(0, 0, 0, 0.1); /* Stronger shadow */
        }
        /* Glow effect on hover */
        .glass-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transform: rotate(45deg);
            transition: opacity 0.5s ease-out;
            z-index: 0;
        }
        .glass-card:hover::before {
            opacity: 1;
        }

        /* Buttons with new colors and glow */
        .btn-primary {
            @apply bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105;
            position: relative;
            overflow: hidden;
        }
        .btn-primary::after { /* Glow for primary buttons */
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            opacity: 0;
            transform: rotate(45deg);
            transition: opacity 0.5s ease-out;
            z-index: 0;
        }
        .btn-primary:hover::after { opacity: 1; }

        .btn-secondary {
            @apply bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition duration-300 ease-in-out transform hover:scale-105;
            position: relative;
            overflow: hidden;
        }
         .btn-secondary::after { /* Glow for secondary buttons */
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transform: rotate(45deg);
            transition: opacity 0.5s ease-out;
            z-index: 0;
        }
        .btn-secondary:hover::after { opacity: 1; }

        .btn-danger {
            @apply bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-700 transition duration-300 ease-in-out transform hover:scale-105; /* Orange for danger */
            position: relative;
            overflow: hidden;
        }
        .btn-danger::after { /* Glow for danger buttons */
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            opacity: 0;
            transform: rotate(45deg);
            transition: opacity 0.5s ease-out;
            z-index: 0;
        }
        .btn-danger:hover::after { opacity: 1; }

        .btn-warning {
            @apply bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition duration-300 ease-in-out transform hover:scale-105;
            position: relative;
            overflow: hidden;
        }
        .btn-warning::after { /* Glow for warning buttons */
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transform: rotate(45deg);
            transition: opacity 0.5s ease-out;
            z-index: 0;
        }
        .btn-warning:hover::after { opacity: 1; }

        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200; /* Purple ring */
        }
        .table-row-open {
            background-color: rgba(255, 255, 255, 0.8); /* Slightly transparent white */
            transition: background-color 0.2s ease, transform 0.1s ease;
            cursor: pointer;
        }
        .table-row-open:hover {
            background-color: rgba(240, 248, 255, 0.9); /* Light blue on hover for open rows */
            transform: scale(1.005);
        }
        .table-row-closed {
            background-color: rgba(248, 250, 252, 0.7); /* Lighter gray for closed rows, more transparent */
            text-decoration: line-through;
            color: #94a3b8; /* Darker gray text */
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .table-row-closed:hover {
            background-color: rgba(224, 231, 240, 0.8); /* Slightly darker gray on hover */
            transform: scale(1.005);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: rgba(255, 255, 255, 0.8); /* שקיפות במודל */
            backdrop-filter: blur(15px); /* טשטוש חזק יותר למודל */
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 2.5rem; /* Increased padding */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.08); /* Stronger shadow */
            width: 90%;
            max-width: 700px; /* Wider modal */
            max-height: 90vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling for taller modals */
            position: relative;
        }
        .alert-banner {
            background-color: #ef4444; /* Red-600 */
            color: #ffffff;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: sticky; /* Stick to top */
            top: 0;
            z-index: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert-banner:hover {
            background-color: #dc2626; /* Red-700 */
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.5); /* Light blue-gray track with transparency */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a78bfa; /* Purple thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6; /* Darker purple on hover */
        }

        /* Specific style for table body to enable vertical scrolling */
        #ordersTableContainer {
            max-height: 60vh; /* Set a maximum height for the table body */
            overflow-y: auto; /* Enable vertical scrolling */
            border-radius: 0.75rem; /* Match card border-radius */
            border: 1px solid rgba(226, 232, 240, 0.5); /* Light border for definition */
        }

        #ordersTableBody {
            display: block; /* Important for scrollable tbody */
            overflow-y: auto; /* Handles its own scrolling if necessary */
            height: auto; /* Allow content to define height within max-height of container */
        }

        #ordersTable thead, #ordersTable tbody tr {
            display: table; /* Make table header and rows act like table elements */
            width: 100%;
            table-layout: fixed; /* Fix column widths */
        }

        /* Responsive table column widths */
        @media (min-width: 1024px) { /* Large screens */
            #ordersTable thead th, #ordersTable tbody td {
                width: calc(100% / 13); /* Divide equally by number of columns */
            }
            #ordersTable thead th:nth-child(4), /* שם לקוח */
            #ordersTable tbody td:nth-child(4) {
                width: 10%; /* Larger width for client name */
            }
             #ordersTable thead th:nth-child(5), /* כתובת */
            #ordersTable tbody td:nth-child(5) {
                width: 15%; /* Larger width for address */
            }
             #ordersTable thead th:nth-child(12), /* הערות */
            #ordersTable tbody td:nth-child(12) {
                width: 12%; /* Larger width for notes */
            }
             #ordersTable thead th:last-child, /* פעולות */
            #ordersTable tbody td:last-child {
                width: 15%; /* Larger width for actions */
            }
        }
        @media (min-width: 768px) and (max-width: 1023px) { /* Medium screens */
             #ordersTable thead th, #ordersTable tbody td {
                width: calc(100% / 10); /* Adjust for fewer columns visible without excessive scroll */
            }
             #ordersTable thead th:nth-child(4), /* שם לקוח */
            #ordersTable tbody td:nth-child(4) {
                width: 12%;
            }
             #ordersTable thead th:nth-child(5), /* כתובת */
            #ordersTable tbody td:nth-child(5) {
                width: 18%;
            }
             #ordersTable thead th:last-child, /* פעולות */
            #ordersTable tbody td:last-child {
                width: 20%;
            }
        }
        /* Mobile styles (max-width: 767px) - will rely on overflow-x-auto */
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[2000] hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
            <p class="text-white mt-4 text-lg">טוען נתונים...</p>
        </div>
    </div>

    <div id="alertBanner" class="alert-banner hidden">
        <p><i class="fas fa-exclamation-triangle ml-2"></i> ישנן <span id="exceedingOrdersCount">0</span> הזמנות חורגות. לחץ לסינון מהיר.</p>
    </div>

    <div class="container mx-auto p-4 md:p-8 main-content">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-8">מערכת CRM לניהול שכירות מכולות</h1>

        <!-- Dashboard Indicators -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="glass-card flex items-center justify-between p-4">
                <div>
                    <p class="text-gray-600 text-sm">הזמנות פתוחות</p>
                    <p id="openOrdersCount" class="text-2xl font-bold text-purple-600">0</p>
                </div>
                <i class="fas fa-box-open text-4xl text-purple-400"></i>
            </div>
            <div class="glass-card flex items-center justify-between p-4">
                <div>
                    <p class="text-gray-600 text-sm">הזמנות חורגות</p>
                    <p id="exceedingOrdersCountCard" class="text-2xl font-bold text-orange-600">0</p>
                </div>
                <i class="fas fa-bell text-4xl text-orange-400"></i>
            </div>
            <div class="glass-card flex items-center justify-between p-4">
                <div>
                    <p class="text-gray-600 text-sm">מכולות בשימוש</p>
                    <p id="inUseContainersCount" class="text-2xl font-bold text-green-600">0</p>
                </div>
                <i class="fas fa-shipping-fast text-4xl text-green-400"></i>
            </div>
            <div class="glass-card flex items-center justify-between p-4">
                <div>
                    <p class="text-gray-600 text-sm">לקוחות פעילים</p>
                    <p id="activeCustomersCount" class="text-2xl font-bold text-blue-600">0</p>
                </div>
                <i class="fas fa-users text-4xl text-blue-400"></i>
            </div>
        </div>

        <!-- Add New Order Button -->
        <div class="flex justify-end mb-6">
            <button id="addOrderBtn" class="btn-primary flex items-center">
                <i class="fas fa-plus ml-2"></i> הוסף הזמנה חדשה
            </button>
        </div>

        <!-- Search and Filter -->
        <div class="glass-card mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">חיפוש וסינון הזמנות</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div>
                    <label for="searchClientName" class="block text-gray-700 text-sm font-bold mb-2">שם לקוח:</label>
                    <input type="text" id="searchClientName" placeholder="הכנס שם לקוח" class="input-field">
                </div>
                <div>
                    <label for="searchAddress" class="block text-gray-700 text-sm font-bold mb-2">כתובת:</label>
                    <input type="text" id="searchAddress" placeholder="הכנס כתובת" class="input-field">
                </div>
                <div>
                    <label for="searchActionType" class="block text-gray-700 text-sm font-bold mb-2">סוג פעולה:</label>
                    <select id="searchActionType" class="input-field">
                        <option value="">הכל</option>
                        <option value="הצבה">הצבה</option>
                        <option value="הוצאה">הוצאה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        <option value="החלפה">החלפה</option>
                    </select>
                </div>
                <div>
                    <label for="searchStatus" class="block text-gray-700 text-sm font-bold mb-2">סטטוס:</label>
                    <select id="searchStatus" class="input-field">
                        <option value="">הכל</option>
                        <option value="פתוחה">פתוחה</option>
                        <option value="סגורה">סגורה</option>
                    </select>
                </div>
                <div>
                    <label for="searchDate" class="block text-gray-700 text-sm font-bold mb-2">תאריך (מתאריך):</label>
                    <input type="date" id="searchDate" class="input-field">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="applyFilterBtn" class="btn-primary">הפעל סינון</button>
                <button id="clearFilterBtn" class="btn-secondary">נקה סינון</button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="glass-card overflow-x-auto mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">טבלת הזמנות</h2>
            <div id="ordersTableContainer" class="rounded-lg shadow-inner bg-gray-50 border border-gray-200">
                <table id="ordersTable" class="min-w-full bg-white">
                    <thead class="bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">מתאריך</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">תעודה</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">שם סוכן</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">שם לקוח</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">כתובת</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">סוג פעולה</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ימים שעברו (ירדה)</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">מס" מכולה ירדה</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">מס" מכולה עלתה</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ימים שעברו (עלתה)</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">סטטוס</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">הערות</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="divide-y divide-gray-200">
                        <!-- Orders will be loaded here by JavaScript -->
                        <tr>
                            <td colspan="13" class="text-center py-4 text-gray-500">טוען הזמנות...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="glass-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">מכולות בשימוש לפי לקוחות</h2>
                <canvas id="containersByClientChart"></canvas>
            </div>
            <div class="glass-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">סוגי פעולות</h2>
                <canvas id="actionTypesChart"></canvas>
            </div>
        </div>
        <!-- Placeholder for Days Remaining chart, will implement in future iteration -->
        <div class="glass-card hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">ימי שכירות שנותרו</h2>
            <canvas id="rentalDaysRemainingChart"></canvas>
        </div>

    </div>

    <!-- Modals -->

    <!-- Add/Edit Order Modal -->
    <div id="orderModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="orderModalTitle" class="text-2xl font-bold mb-6 text-gray-800">הוסף הזמנה חדשה</h2>
            <button class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal('orderModal')"><i class="fas fa-times"></i></button>

            <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="orderRowIndex">
                <div>
                    <label for="orderFromDate" class="block text-gray-700 text-sm font-bold mb-2">מתאריך:</label>
                    <input type="date" id="orderFromDate" class="input-field" required>
                </div>
                <div>
                    <label for="orderDocumentId" class="block text-gray-700 text-sm font-bold mb-2">תעודה:</label>
                    <input type="text" id="orderDocumentId" class="input-field" required>
                </div>
                <div>
                    <label for="orderAgentName" class="block text-gray-700 text-sm font-bold mb-2">שם סוכן:</label>
                    <input type="text" id="orderAgentName" class="input-field" required>
                </div>
                <div>
                    <label for="orderClientName" class="block text-gray-700 text-sm font-bold mb-2">שם לקוח:</label>
                    <input type="text" id="orderClientName" class="input-field" required>
                </div>
                <div class="md:col-span-2">
                    <label for="orderAddress" class="block text-gray-700 text-sm font-bold mb-2">כתובת:</label>
                    <input type="text" id="orderAddress" class="input-field" required>
                </div>
                <div>
                    <label for="orderActionType" class="block text-gray-700 text-sm font-bold mb-2">סוג פעולה:</label>
                    <select id="orderActionType" class="input-field" required>
                        <option value="הצבה">הצבה</option>
                        <option value="הוצאה">הוצאה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        <option value="החלפה">החלפה</option>
                    </select>
                </div>
                <div>
                    <label for="orderDaysPassed" class="block text-gray-700 text-sm font-bold mb-2">ימים שעברו (ירדה):</label>
                    <input type="number" id="orderDaysPassed" class="input-field">
                </div>
                <div>
                    <label for="orderContainerRemoved" class="block text-gray-700 text-sm font-bold mb-2">מס" מכולה ירדה:</label>
                    <input type="text" id="orderContainerRemoved" class="input-field">
                </div>
                <div>
                    <label for="orderContainerAdded" class="block text-gray-700 text-sm font-bold mb-2">מס" מכולה עלתה:</label>
                    <input type="text" id="orderContainerAdded" class="input-field">
                </div>
                <div>
                    <label for="orderDaysPassedAdded" class="block text-gray-700 text-sm font-bold mb-2">ימים שעברו (עלתה):</label>
                    <input type="number" id="orderDaysPassedAdded" class="input-field" disabled> <!-- Automatically calculated -->
                </div>
                <div>
                    <label for="orderStatus" class="block text-gray-700 text-sm font-bold mb-2">סטטוס:</label>
                    <select id="orderStatus" class="input-field" required>
                        <option value="פתוחה">פתוחה</option>
                        <option value="סגורה">סגורה</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="orderNotes" class="block text-gray-700 text-sm font-bold mb-2">הערות:</label>
                    <textarea id="orderNotes" rows="3" class="input-field"></textarea>
                </div>
                <div class="md:col-span-2 flex justify-end gap-4 mt-6">
                    <button type="submit" class="btn-primary" id="saveOrderBtn">שמור הזמנה</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('orderModal')">ביטול</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details POPUP Modal -->
    <div id="orderDetailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">פרטי הזמנה</h2>
            <button class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal('orderDetailModal')"><i class="fas fa-times"></i></button>

            <div id="orderDetailsContent" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-right">
                <!-- Details will be populated here -->
            </div>

            <div class="flex justify-center gap-4 mt-8">
                <button id="detailEditBtn" class="btn-primary flex items-center">
                    <i class="fas fa-edit ml-2"></i> ערוך
                </button>
                <button id="detailDuplicateBtn" class="btn-warning flex items-center">
                    <i class="fas fa-copy ml-2"></i> שכפל
                </button>
                <button id="detailCloseBtn" class="btn-secondary flex items-center">
                    <i class="fas fa-check-circle ml-2"></i> סגור
                </button>
                <button id="detailDeleteBtn" class="btn-danger flex items-center">
                    <i class="fas fa-trash ml-2"></i> מחק
                </button>
            </div>
        </div>
    </div>

    <!-- General Alert/Confirmation Modal (improved styling and messages) -->
    <div id="generalAlertModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <button class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal('generalAlertModal')"><i class="fas fa-times"></i></button>
            <h3 id="alertModalTitle" class="text-xl font-semibold mb-4 text-gray-800"></h3>
            <p id="alertModalMessage" class="text-gray-700 mb-6"></p>
            <div id="alertModalActions" class="flex justify-center gap-4">
                <button type="button" class="btn-primary" onclick="closeModal('generalAlertModal')">אישור</button>
            </div>
        </div>
    </div>

    <script>
        // IMPORTANT: Replace this with your deployed Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwDJZ-rGmv0CSr8S_B8TMoSkKxKrzc3D5TVIv5wYaRh8nb0ZXCXHXNxxMJ09fsRnVN2/exec'; // e.g., 'https://script.google.com/macros/s/AKfyc.../exec'

        let allOrders = { openOrders: [], closedOrders: [] };
        let filteredOrders = [];
        let containersByClientChart;
        let actionTypesChart;
        // let rentalDaysRemainingChart; // For future implementation

        // --- Utility Functions ---

        /** Shows a loading overlay. */
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        /** Hides the loading overlay. */
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        /** Shows a general modal with a message and title. */
        function showGeneralModal(title, message, isConfirm = false, onConfirm = null) {
            document.getElementById('alertModalTitle').innerText = title;
            document.getElementById('alertModalMessage').innerText = message;
            const actionsDiv = document.getElementById('alertModalActions');
            actionsDiv.innerHTML = ''; // Clear previous buttons

            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn-danger'; // Use orange for confirmation action
                confirmBtn.innerText = 'כן, אשר';
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    closeModal('generalAlertModal');
                };
                actionsDiv.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn-secondary';
                cancelBtn.innerText = 'ביטול';
                cancelBtn.onclick = () => closeModal('generalAlertModal');
                actionsDiv.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'btn-primary'; // Use purple for general info
                okBtn.innerText = 'אישור';
                okBtn.onclick = () => closeModal('generalAlertModal');
                actionsDiv.appendChild(okBtn);
            }
            document.getElementById('generalAlertModal').classList.remove('hidden');
        }

        /** Closes a specified modal. */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        /** Formats a date string to DD/MM/YYYY. */
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return dateString; // Return as is if invalid date
            // Ensure locale is 'he-IL' for consistent Hebrew date format
            return new Date(date).toLocaleDateString('he-IL', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        /** Calculates days passed from a given date to today. */
        function calculateDaysPassed(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to compare days accurately
            date.setHours(0, 0, 0, 0);

            const diffTime = today.getTime() - date.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays >= 0 ? diffDays : 0; // Don't show negative days
        }


        // --- Data Fetching and UI Rendering ---

        /** Fetches all orders from Google Sheet. */
        async function fetchOrders() {
            showLoading();
            try {
                const response = await fetch(`${SCRIPT_URL}?action=list`);
                if (!response.ok) {
                    throw new Error(`שגיאת HTTP: ${response.status}`);
                }
                const data = await response.json();
                if (data.status === 'success') {
                    allOrders = data.data;
                    filteredOrders = [...allOrders.openOrders, ...allOrders.closedOrders]; // Initial display all orders
                    updateDashboard();
                    renderOrdersTable(filteredOrders);
                    updateCharts();
                    runAlertChecks();
                } else {
                    showGeneralModal('שגיאה בשליפת נתונים', data.message);
                }
            } catch (error) {
                console.error('שגיאה בטעינת הזמנות:', error);
                showGeneralModal('שגיאה', `לא ניתן לטעון הזמנות. אנא נסה שוב מאוחר יותר.`); // Generic Hebrew error
            } finally {
                hideLoading();
            }
        }

        /** Updates the dashboard indicator cards. */
        function updateDashboard() {
            const openCount = allOrders.openOrders.length;
            document.getElementById('openOrdersCount').innerText = openCount;

            const exceedingOrders = allOrders.openOrders.filter(order => {
                const daysPassedAdded = parseInt(order['ימים שעברו (עלתה)']);
                return order['closed'] === 'פתוחה' && daysPassedAdded >= 7; // Threshold for "exceeding"
            });
            document.getElementById('exceedingOrdersCount').innerText = exceedingOrders.length;
            document.getElementById('exceedingOrdersCountCard').innerText = exceedingOrders.length;

            if (exceedingOrders.length > 0) {
                document.getElementById('alertBanner').classList.remove('hidden');
            } else {
                document.getElementById('alertBanner').classList.add('hidden');
            }

            const inUseContainers = new Set(allOrders.openOrders.map(order => order['מס" מכולה עלתה']).filter(Boolean));
            document.getElementById('inUseContainersCount').innerText = inUseContainers.size;

            const activeCustomers = new Set(allOrders.openOrders.map(order => order['שם לקוח']).filter(Boolean));
            document.getElementById('activeCustomersCount').innerText = activeCustomers.size;
        }

        /** Renders the orders table with given data. */
        function renderOrdersTable(ordersToDisplay) {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            if (ordersToDisplay.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" class="text-center py-4 text-gray-500">אין הזמנות להצגה.</td></tr>';
                return;
            }

            ordersToDisplay.forEach(order => {
                const row = document.createElement('tr');
                row.className = order.closed === 'סגורה' ? 'table-row-closed' : 'table-row-open';
                row.dataset.rowIndex = order.rowIndex; // Store row index for actions
                row.onclick = () => showOrderDetailsModal(order.rowIndex); // Add click listener for popup

                // Define order of columns for rendering
                const columns = [
                    'מתאריך', 'תעודה', 'שם סוכן', 'שם לקוח', 'כתובת', 'סוג פעולה',
                    'ימים שעברו', 'מס" מכולה ירדה', 'מס" מכולה עלתה', 'ימים שעברו (עלתה)',
                    'closed', 'הערות'
                ];

                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-800 border-b border-gray-200';
                    let value = order[col] || '';

                    // Special formatting for dates
                    if (col === 'מתאריך') {
                        value = formatDisplayDate(value);
                    }
                    // Special styling for status column
                    if (col === 'closed') {
                        td.className += ` font-semibold ${value === 'פתוחה' ? 'text-green-600' : 'text-gray-500'}`;
                    }

                    td.innerText = value;
                    row.appendChild(td);
                });

                // Action buttons column - prevent event propagation for row click
                const actionsTd = document.createElement('td');
                actionsTd.className = 'px-4 py-2 whitespace-nowrap text-sm font-medium border-b border-gray-200';
                actionsTd.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="event.stopPropagation(); editOrder(${order.rowIndex})" class="btn-primary p-2 text-sm">
                            <i class="fas fa-edit"></i>
                            <span class="hidden sm:inline mr-1">ערוך</span>
                        </button>
                        <button onclick="event.stopPropagation(); duplicateOrder(${order.rowIndex})" class="btn-warning p-2 text-sm">
                            <i class="fas fa-copy"></i>
                            <span class="hidden sm:inline mr-1">שכפל</span>
                        </button>
                        ${order.closed === 'פתוחה' ? `
                        <button onclick="event.stopPropagation(); confirmCloseOrder(${order.rowIndex})" class="btn-secondary p-2 text-sm">
                            <i class="fas fa-check-circle"></i>
                            <span class="hidden sm:inline mr-1">סגור</span>
                        </button>
                        ` : ''}
                        <button onclick="event.stopPropagation(); confirmDeleteOrder(${order.rowIndex})" class="btn-danger p-2 text-sm">
                            <i class="fas fa-trash"></i>
                            <span class="hidden sm:inline mr-1">מחק</span>
                        </button>
                    </div>
                `;
                row.appendChild(actionsTd);
                tableBody.appendChild(row);
            });
        }

        /** Filters the orders table based on search inputs. */
        function applyFilter() {
            const clientName = document.getElementById('searchClientName').value.toLowerCase();
            const address = document.getElementById('searchAddress').value.toLowerCase();
            const actionType = document.getElementById('searchActionType').value;
            const status = document.getElementById('searchStatus').value;
            const searchDate = document.getElementById('searchDate').value; // YYYY-MM-DD

            const allCombinedOrders = [...allOrders.openOrders, ...allOrders.closedOrders];

            filteredOrders = allCombinedOrders.filter(order => {
                const matchesClient = clientName === '' || (order['שם לקוח'] && order['שם לקוח'].toLowerCase().includes(clientName));
                const matchesAddress = address === '' || (order['כתובת'] && order['כתובת'].toLowerCase().includes(address));
                const matchesActionType = actionType === '' || order['סוג פעולה'] === actionType;
                const matchesStatus = status === '' || order['closed'] === status;

                let matchesDate = true;
                if (searchDate) {
                    const orderDate = new Date(order['מתאריך']);
                    const filterDate = new Date(searchDate);
                    matchesDate = orderDate.toDateString() === filterDate.toDateString();
                }
                return matchesClient && matchesAddress && matchesActionType && matchesStatus && matchesDate;
            });
            renderOrdersTable(filteredOrders);
        }

        /** Clears all filter inputs and re-renders the full table. */
        function clearFilter() {
            document.getElementById('searchClientName').value = '';
            document.getElementById('searchAddress').value = '';
            document.getElementById('searchActionType').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('searchDate').value = '';
            filteredOrders = [...allOrders.openOrders, ...allOrders.closedOrders];
            renderOrdersTable(filteredOrders);
        }

        // --- CRUD Operations ---

        /** Opens the modal to add a new order. */
        document.getElementById('addOrderBtn').addEventListener('click', () => {
            document.getElementById('orderModalTitle').innerText = 'הוסף הזמנה חדשה';
            document.getElementById('orderForm').reset();
            document.getElementById('orderRowIndex').value = ''; // Clear row index for new
            document.getElementById('orderDaysPassedAdded').disabled = true; // Days passed added is auto-calculated for new
            document.getElementById('orderStatus').value = 'פתוחה'; // Default status for new
            document.getElementById('orderModal').classList.remove('hidden');
        });

        /** Populates the modal for editing an existing order. */
        function editOrder(rowIndex) {
            closeModal('orderDetailModal'); // Close details modal if open
            const orderToEdit = [...allOrders.openOrders, ...allOrders.closedOrders].find(order => order.rowIndex === rowIndex);
            if (!orderToEdit) {
                showGeneralModal('שגיאה', 'ההזמנה לא נמצאה לעריכה.');
                return;
            }

            document.getElementById('orderModalTitle').innerText = 'ערוך הזמנה';
            document.getElementById('orderRowIndex').value = rowIndex;
            document.getElementById('orderFromDate').value = orderToEdit['מתאריך'] ? new Date(orderToEdit['מתאריך']).toISOString().split('T')[0] : '';
            document.getElementById('orderDocumentId').value = orderToEdit['תעודה'] || '';
            document.getElementById('orderAgentName').value = orderToEdit['שם סוכן'] || '';
            document.getElementById('orderClientName').value = orderToEdit['שם לקוח'] || '';
            document.getElementById('orderAddress').value = orderToEdit['כתובת'] || '';
            document.getElementById('orderActionType').value = orderToEdit['סוג פעולה'] || '';
            document.getElementById('orderDaysPassed').value = orderToEdit['ימים שעברו'] || '';
            document.getElementById('orderContainerRemoved').value = orderToEdit['מס" מכולה ירדה'] || '';
            document.getElementById('orderContainerAdded').value = orderToEdit['מס" מכולה עלתה'] || '';
            document.getElementById('orderDaysPassedAdded').value = orderToEdit['ימים שעברו (עלתה)'] || ''; // Pre-fill calculated value
            document.getElementById('orderDaysPassedAdded').disabled = true; // Keep disabled as it's calculated
            document.getElementById('orderStatus').value = orderToEdit['closed'] || 'פתוחה';
            document.getElementById('orderNotes').value = orderToEdit['הערות'] || '';

            document.getElementById('orderModal').classList.remove('hidden');
        }

        /** Handles form submission for adding or updating an order. */
        document.getElementById('orderForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            showLoading();

            const rowIndex = document.getElementById('orderRowIndex').value;
            const isNew = !rowIndex;
            const action = isNew ? 'add' : 'update';

            const formData = {
                'מתאריך': document.getElementById('orderFromDate').value,
                'תעודה': document.getElementById('orderDocumentId').value,
                'שם סוכן': document.getElementById('orderAgentName').value,
                'שם לקוח': document.getElementById('orderClientName').value,
                'כתובת': document.getElementById('orderAddress').value,
                'סוג פעולה': document.getElementById('orderActionType').value,
                'ימים שעברו': document.getElementById('orderDaysPassed').value,
                'מס" מכולה ירדה': document.getElementById('orderContainerRemoved').value,
                'מס" מכולה עלתה': document.getElementById('orderContainerAdded').value,
                'closed': document.getElementById('orderStatus').value,
                'הערות': document.getElementById('orderNotes').value
            };

            // Recalculate 'ימים שעברו (עלתה)' on frontend before sending for new/edit
            if (formData['מס" מכולה עלתה'] && formData['מתאריך']) {
                formData['ימים שעברו (עלתה)'] = calculateDaysPassed(formData['מתאריך']);
            } else {
                 formData['ימים שעברו (עלתה)'] = '';
            }

            const params = new URLSearchParams(formData);
            params.append('action', action);
            if (!isNew) {
                params.append('rowIndex', rowIndex);
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
                const data = await response.json();

                if (data.status === 'success') {
                    showGeneralModal('הצלחה', data.message);
                    closeModal('orderModal');
                    await fetchOrders(); // Re-fetch to update table and dashboard
                } else {
                    showGeneralModal('שגיאה', data.message);
                }
            } catch (error) {
                console.error('שגיאה בשמירת הזמנה:', error);
                showGeneralModal('שגיאה', `שגיאה בשמירת הזמנה. אנא נסה שוב.`); // Generic Hebrew error
            } finally {
                hideLoading();
            }
        });

        /** Confirms and then closes an order. */
        function confirmCloseOrder(rowIndex) {
            closeModal('orderDetailModal'); // Close details modal if open
            showGeneralModal(
                'אשר סגירת הזמנה',
                `האם אתה בטוח שברצונך לסגור את הזמנה בשורה ${rowIndex}?`,
                true,
                async () => {
                    showLoading();
                    try {
                        const response = await fetch(`${SCRIPT_URL}?action=close&rowIndex=${rowIndex}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            showGeneralModal('הצלחה', data.message);
                            await fetchOrders();
                        } else {
                            showGeneralModal('שגיאה', data.message);
                        }
                    } catch (error) {
                        console.error('שגיאה בסגירת הזמנה:', error);
                        showGeneralModal('שגיאה', `שגיאה בסגירת הזמנה. אנא נסה שוב.`); // Generic Hebrew error
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        /** Confirms and then deletes an order. */
        function confirmDeleteOrder(rowIndex) {
            closeModal('orderDetailModal'); // Close details modal if open
            showGeneralModal(
                'אשר מחיקת הזמנה',
                `האם אתה בטוח שברצונך למחוק את הזמנה בשורה ${rowIndex}? פעולה זו אינה הפיכה!`,
                true,
                async () => {
                    showLoading();
                    try {
                        const response = await fetch(`${SCRIPT_URL}?action=delete&rowIndex=${rowIndex}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            showGeneralModal('הצלחה', data.message);
                            await fetchOrders();
                        } else {
                            showGeneralModal('שגיאה', data.message);
                        }
                    } catch (error) {
                        console.error('שגיאה במחיקת הזמנה:', error);
                        showGeneralModal('שגיאה', `שגיאה במחיקת הזמנה. אנא נסה שוב.`); // Generic Hebrew error
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        /** Duplicates an order. */
        async function duplicateOrder(rowIndex) {
            closeModal('orderDetailModal'); // Close details modal if open
            showLoading();
            try {
                const response = await fetch(`${SCRIPT_URL}?action=duplicate&rowIndex=${rowIndex}`);
                const data = await response.json();
                if (data.status === 'success') {
                    showGeneralModal('הצלחה', data.message);
                    await fetchOrders();
                } else {
                    showGeneralModal('שגיאה', data.message);
                }
            } catch (error) {
                console.error('שגיאה בשכפול הזמנה:', error);
                showGeneralModal('שגיאה', `שגיאה בשכפול הזמנה. אנא נסה שוב.`); // Generic Hebrew error
            } finally {
                hideLoading();
            }
        }

        // --- Order Details POPUP ---
        function showOrderDetailsModal(rowIndex) {
            const order = [...allOrders.openOrders, ...allOrders.closedOrders].find(o => o.rowIndex === rowIndex);
            if (!order) {
                showGeneralModal('שגיאה', 'פרטי ההזמנה לא נמצאו.');
                return;
            }

            const detailsContent = document.getElementById('orderDetailsContent');
            detailsContent.innerHTML = ''; // Clear previous content

            // Map Hebrew column names to more readable labels for display
            const displayLabels = {
                'מתאריך': 'תאריך:',
                'תעודה': 'מספר תעודה:',
                'שם סוכן': 'סוכן:',
                'שם לקוח': 'לקוח:',
                'כתובת': 'כתובת:',
                'סוג פעולה': 'סוג פעולה:',
                'ימים שעברו': 'ימים שעברו (ירדה):',
                'מס" מכולה ירדה': 'מכולה ירדה:',
                'מס" מכולה עלתה': 'מכולה עלתה:',
                'ימים שעברו (עלתה)': 'ימים שעברו (עלתה):',
                'closed': 'סטטוס:',
                'הערות': 'הערות:'
            };

            for (const key in displayLabels) {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'col-span-1 text-gray-600 font-bold text-sm md:text-base';
                labelDiv.innerText = displayLabels[key];

                const valueDiv = document.createElement('div');
                valueDiv.className = 'col-span-1 text-gray-800 text-sm md:text-base';
                let displayValue = order[key] || '-';

                if (key === 'מתאריך') {
                    displayValue = formatDisplayDate(displayValue);
                }
                 if (key === 'closed') {
                    valueDiv.className += ` font-semibold ${displayValue === 'פתוחה' ? 'text-green-600' : 'text-gray-500'}`;
                }

                valueDiv.innerText = displayValue;

                detailsContent.appendChild(labelDiv);
                detailsContent.appendChild(valueDiv);
            }

            // Set up action buttons in the detail modal
            document.getElementById('detailEditBtn').onclick = () => editOrder(rowIndex);
            document.getElementById('detailDuplicateBtn').onclick = () => duplicateOrder(rowIndex);

            const detailCloseBtn = document.getElementById('detailCloseBtn');
            const detailDeleteBtn = document.getElementById('detailDeleteBtn');

            if (order.closed === 'פתוחה') {
                detailCloseBtn.classList.remove('hidden');
                detailCloseBtn.onclick = () => confirmCloseOrder(rowIndex);
            } else {
                detailCloseBtn.classList.add('hidden');
            }
            detailDeleteBtn.onclick = () => confirmDeleteOrder(rowIndex);


            document.getElementById('orderDetailModal').classList.remove('hidden');
        }


        // --- Alert System ---

        /** Runs checks for duplicates and exceeding orders and shows pop-ups. */
        function runAlertChecks() {
            const allCombinedOrders = [...allOrders.openOrders, ...allOrders.closedOrders];
            const alerts = [];

            // Check for duplicate clients (in open orders for relevance)
            const clientNames = {};
            allOrders.openOrders.forEach(order => {
                const client = order['שם לקוח'];
                if (client) {
                    clientNames[client] = (clientNames[client] || 0) + 1;
                }
            });
            for (const client in clientNames) {
                if (clientNames[client] > 1) {
                    alerts.push(`לקוח כפול: הלקוח "${client}" מופיע ${clientNames[client]} פעמים בהזמנות פתוחות.`);
                }
            }

            // Check for duplicate containers (in open orders for relevance)
            const containerIds = {};
            allOrders.openOrders.forEach(order => {
                const containerAdded = order['מס" מכולה עלתה'];
                if (containerAdded) {
                    containerIds[containerAdded] = (containerIds[containerAdded] || 0) + 1;
                }
            });
            for (const container in containerIds) {
                if (containerIds[container] > 1) {
                    alerts.push(`מכולה כפולה: מכולה מספר "${container}" מופיעה ${containerIds[container]} פעמים בהזמנות פתוחות.`);
                }
            }

            // Check for exceeding rental days (ימים שעברו (עלתה))
            allOrders.openOrders.forEach(order => {
                const daysPassedAdded = parseInt(order['ימים שעברו (עלתה)']);
                if (order['closed'] === 'פתוחה' && daysPassedAdded >= 7) { // Threshold for alert
                    alerts.push(`חריגה בימי שכירות: הזמנה מספר ${order['תעודה']} ללקוח "${order['שם לקוח']}" חורגת בימי השכירות (${daysPassedAdded} ימים).`);
                }
            });

            if (alerts.length > 0) {
                const alertsHtml = alerts.map(alert => `<li class="mb-2">${alert}</li>`).join('');
                showGeneralModal(
                    'התראות מערכת',
                    `<ul class="list-disc list-inside text-right">${alertsHtml}</ul>`
                );
            }
        }

        // --- Chart Rendering ---

        /** Updates all charts based on current data. */
        function updateCharts() {
            renderContainersByClientChart();
            renderActionTypesChart();
            // renderRentalDaysRemainingChart(); // For future implementation
        }

        /** Renders the Bar chart for containers in use by client. */
        function renderContainersByClientChart() {
            const clientContainerCounts = {};
            allOrders.openOrders.forEach(order => {
                if (order['שם לקוח'] && order['מס" מכולה עלתה']) {
                    clientContainerCounts[order['שם לקוח']] = (clientContainerCounts[order['שם לקוח']] || 0) + 1;
                }
            });

            const labels = Object.keys(clientContainerCounts);
            const data = Object.values(clientContainerCounts);

            const ctx = document.getElementById('containersByClientChart').getContext('2d');
            if (containersByClientChart) {
                containersByClientChart.destroy(); // Destroy previous chart instance
            }
            containersByClientChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'מספר מכולות בשימוש',
                        data: data,
                        backgroundColor: 'rgba(139, 92, 246, 0.7)', /* Purple */
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'מכולות בשימוש לפי לקוח',
                            font: {
                                size: 16,
                                family: 'Inter'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
        }

        /** Renders the Pie chart for action types. */
        function renderActionTypesChart() {
            const actionTypeCounts = {};
            const allCombinedOrders = [...allOrders.openOrders, ...allOrders.closedOrders];
            allCombinedOrders.forEach(order => {
                const type = order['סוג פעולה'];
                if (type) {
                    actionTypeCounts[type] = (actionTypeCounts[type] || 0) + 1;
                }
            });

            const labels = Object.keys(actionTypeCounts);
            const data = Object.values(actionTypeCounts);
            const backgroundColors = [
                'rgba(251, 146, 60, 0.7)', /* Orange-500 */
                'rgba(139, 92, 246, 0.7)', /* Purple-500 */
                'rgba(59, 130, 246, 0.7)',  /* Blue-500 */
                'rgba(75, 192, 192, 0.7)' /* Teal (if more than 3 types) */
            ];
            const borderColors = [
                'rgba(251, 146, 60, 1)',
                'rgba(139, 92, 246, 1)',
                'rgba(59, 130, 246, 1)',
                'rgba(75, 192, 192, 1)'
            ];

            const ctx = document.getElementById('actionTypesChart').getContext('2d');
            if (actionTypesChart) {
                actionTypesChart.destroy(); // Destroy previous chart instance
            }
            actionTypesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'מספר פעולות',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'חלוקת סוגי פעולות',
                            font: {
                                size: 16,
                                family: 'Inter'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the Line chart for rental days remaining.
         * NOTE: This requires additional data (e.g., agreed rental duration) not present in the current sheet.
         * For now, this is a placeholder. If "days remaining" can be derived from existing data
         * (e.g., a fixed rental period minus "days passed"), it can be implemented.
         */
        // function renderRentalDaysRemainingChart() {
        //     // Placeholder for future implementation
        //     const ctx = document.getElementById('rentalDaysRemainingChart').getContext('2d');
        //     if (rentalDaysRemainingChart) {
        //         rentalDaysRemainingChart.destroy();
        //     }
        //     // Example data - replace with actual calculation
        //     const labels = ['שבוע 1', 'שבוע 2', 'שבוע 3', 'שבוע 4'];
        //     const data = [10, 8, 5, 2]; // Example: containers with days remaining
        //     rentalDaysRemainingChart = new Chart(ctx, {
        //         type: 'line',
        //         data: {
        //             labels: labels,
        //             datasets: [{
        //                 label: 'ימי שכירות שנותרו (מכולות פתוחות)',
        //                 data: data,
        //                 borderColor: 'rgba(255, 99, 132, 1)',
        //                 backgroundColor: 'rgba(255, 99, 132, 0.2)',
        //                 fill: true,
        //                 tension: 0.1
        //             }]
        //         },
        //         options: {
        //             responsive: true,
        //             maintainAspectRatio: false,
        //             plugins: {
        //                 legend: {
        //                     position: 'top',
        //                     labels: {
        //                         font: {
        //                             family: 'Inter'
        //                         }
        //                     }
        //                 },
        //                 title: {
        //                     display: true,
        //                     text: 'ימי שכירות שנותרו',
        //                     font: {
        //                         size: 16,
        //                         family: 'Inter'
        //                     }
        //                 }
        //             },
        //             scales: {
        //                 y: {
        //                     beginAtZero: true,
        //                     ticks: {
        //                         font: {
        //                             family: 'Inter'
        //                         }
        //                     }
        //                 },
        //                 x: {
        //                     ticks: {
        //                         font: {
        //                             family: 'Inter'
        //                         }
        //                     }
        //                 }
            //         }
            //     }
            // });
        // }


        // --- Event Listeners ---

        document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
        document.getElementById('clearFilterBtn').addEventListener('click', clearFilter);
        document.getElementById('alertBanner').addEventListener('click', () => {
            document.getElementById('searchStatus').value = 'פתוחה'; // Set status to open
            applyFilter();
            showGeneralModal('הזמנות חורגות', 'הטבלה סוננה להצגת הזמנות פתוחות שחורגות מימי השכירות.');
        });

        // Initial data load when the page is ready
        window.addEventListener('load', fetchOrders);
    </script>
</body>
</html>
