<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转 CRM  转</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            direction: rtl; /* Set default text direction to Right-to-Left */
            text-align: right; /* Align text to the right by default */
        }
        .container {
            max-width: 1280px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .flashing-red {
            animation: flashRed 1s infinite alternate;
            background-color: #fee2e2 !important; /* light red */
        }
        @keyframes flashRed {
            from { background-color: #fee2e2; } /* light red */
            to { background-color: #fca5a5; }   /* slightly darker red */
        }
        .scrollable-table {
            overflow-x: auto;
        }
        th, td {
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
        /* Style for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #ef4444; /* red-500 */
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-bold transition-all duration-300;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 shadow-md;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 shadow-md;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700 shadow-md;
        }
        input, select, textarea {
            @apply p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full;
        }
        .label {
            @apply block text-gray-700 text-sm font-bold mb-1 mt-2;
        }
        .kpi-card {
            @apply p-4 bg-white rounded-lg shadow-md flex-1 text-center;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="container glass-effect">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center flex items-center justify-center">
            <svg class="w-8 h-8 ml-3 text-blue-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
            注专转 CRM  转 
        </h1>

        <!-- Summary & Action Buttons -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-center bg-gray-50 p-4 rounded-lg shadow-inner">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 w-full md:w-auto mb-4 md:mb-0">
                <div class="kpi-card">
                    <div class="text-sm font-medium text-gray-500">转 砖砖</div>
                    <div id="containers-in-use" class="text-2xl font-bold text-blue-600">0</div>
                </div>
                <div class="kpi-card">
                    <div class="text-sm font-medium text-gray-500">拽转 驻注</div>
                    <div id="active-clients" class="text-2xl font-bold text-green-600">0</div>
                </div>
                <div class="kpi-card">
                    <div class="text-sm font-medium text-gray-500">转 专转</div>
                    <div id="overdue-containers" class="text-2xl font-bold text-red-600">0</div>
                </div>
                <div class="kpi-card">
                    <div class="text-sm font-medium text-gray-500">住" 转</div>
                    <div id="total-orders" class="text-2xl font-bold text-purple-600">0</div>
                </div>
            </div>
            <div class="flex flex-wrap gap-3 justify-end w-full md:w-auto">
                <button id="add-order-btn" class="btn btn-primary flex items-center">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    住祝 
                </button>
                <button id="add-dummy-order-btn" class="btn btn-secondary flex items-center">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1m-1.636 6.364l-.707-.707M12 20v-1m-6.364-1.636l.707-.707M3 12H4m1.636-6.364l.707.707M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    住祝  
                </button>
                <button id="refresh-btn" class="btn btn-secondary flex items-center">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356-2A8.001 8.001 0 004 16.001v1c0 1.09.89 2 2 2h2c1.09 0 2-.89 2-2v-1c0-1.09-.89-2-2-2h-2c-1.09 0-2 .89-2 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 4v5h-.582m-15.356-2A8.001 8.001 0 0120 16.001v1c0 1.09-.89 2-2 2h-2c-1.09 0-2-.89-2-2v-1c0-1.09.89-2 2-2h2c1.09 0 2 .89 2 2z"></path></svg>
                    专注 转
                </button>
                <button id="export-excel-btn" class="btn btn-secondary flex items-center">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    爪 -Excel
                </button>
                <button id="export-pdf-btn" class="btn btn-secondary flex items-center">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
                    爪 -PDF
                </button>
            </div>
        </div>

        <!-- Filter and Search Options -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-inner grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label for="search-client-name" class="label">驻砖 驻 拽:</label>
                <input type="text" id="search-client-name" class="input" placeholder="住 砖 拽">
            </div>
            <div>
                <label for="search-address" class="label">驻砖 驻 转转:</label>
                <input type="text" id="search-address" class="input" placeholder="住 转转">
            </div>
            <div>
                <label for="search-container-down" class="label">驻砖 驻  专:</label>
                <input type="text" id="search-container-down" class="input" placeholder="住 住'  专">
            </div>
            <div>
                <label for="search-container-up" class="label">驻砖 驻  注转:</label>
                <input type="text" id="search-container-up" class="input" placeholder="住 住'  注转">
            </div>
            <div>
                <label for="filter-status" class="label">住 驻 住住:</label>
                <select id="filter-status" class="input">
                    <option value="all"> 转</option>
                    <option value="open">转 驻转转</option>
                    <option value="closed">转 住专转</option>
                    <option value="overdue">转 专转</option>
                </select>
            </div>
            <div>
                <label for="filter-date-from" class="label">转专:</label>
                <input type="date" id="filter-date-from" class="input">
            </div>
            <div>
                <label for="filter-date-to" class="label">注 转专:</label>
                <input type="date" id="filter-date-to" class="input">
            </div>
            <div class="flex items-end">
                <button id="apply-filters-btn" class="btn btn-primary w-full">驻注 住</button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="scrollable-table bg-white rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="orderDate">转专</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="documentId">转注</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="agentName">砖 住</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="clientName">砖 拽</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="address">转转</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="actionType">住 驻注</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"> 砖注专 (专)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="containerDown">住'  专</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="containerUp">住'  注转</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"> 砖注专 (注转)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-by="closed">住住 (住专)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">注专转</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">驻注转</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be loaded here by JavaScript -->
                    <tr>
                        <td colspan="13" class="text-center py-4 text-gray-500">注 转...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Charts Section -->
        <h2 class="text-2xl font-bold text-gray-800 mt-10 mb-6 text-center">转 住住拽转 </h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md glass-effect">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">转 砖砖 驻 拽</h3>
                <div id="chart-containers-by-client" class="h-64 flex items-center justify-center text-gray-500">
                    转专砖 专 ( 注 住驻专转 转专砖  Chart.js)
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md glass-effect">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">住住 转</h3>
                <div id="chart-order-status" class="h-64 flex items-center justify-center text-gray-500">
                    转专砖 注 ( 注 住驻专转 转专砖  Chart.js)
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md glass-effect">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"> 砖转专 砖专转 (驻 住 驻注)</h3>
            <div id="chart-days-remaining" class="h-64 flex items-center justify-center text-gray-500">
                转专砖 拽 ( 注 住驻专转 转专砖  Chart.js)
            </div>
        </div>

    </div>

    <!-- Modals (Hidden by default) -->

    <!-- Alert Modal -->
    <div id="alert-modal" class="modal-overlay hidden">
        <div class="modal-content glass-effect">
            <span class="modal-close-btn" onclick="closeModal('alert-modal')">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-red-600">转专! </h2>
            <div id="alert-message" class="text-gray-700 mb-4"></div>
            <button onclick="closeModal('alert-modal')" class="btn btn-secondary w-full">住专</button>
        </div>
    </div>

    <!-- Add/Edit Order Modal -->
    <div id="order-modal" class="modal-overlay hidden">
        <div class="modal-content glass-effect">
            <span class="modal-close-btn" onclick="closeModal('order-modal')">&times;</span>
            <h2 id="order-modal-title" class="text-xl font-bold mb-4 text-gray-800">住祝  砖</h2>
            <form id="order-form" class="space-y-4">
                <input type="hidden" id="order-index">

                <div>
                    <label for="order-date" class="label">转专:</label>
                    <input type="date" id="order-date" class="input" required>
                </div>
                <div>
                    <label for="document-id" class="label">转注:</label>
                    <input type="text" id="document-id" class="input">
                </div>
                <div>
                    <label for="agent-name" class="label">砖 住:</label>
                    <input type="text" id="agent-name" class="input" required>
                </div>
                <div>
                    <label for="client-name" class="label">砖 拽:</label>
                    <input type="text" id="client-name" class="input" required>
                </div>
                <div>
                    <label for="address" class="label">转转:</label>
                    <input type="text" id="address" class="input">
                </div>
                <div>
                    <label for="action-type" class="label">住 驻注:</label>
                    <select id="action-type" class="input" required>
                        <option value="">专 住 驻注</option>
                        <option value="爪">爪</option>
                        <option value="驻">驻</option>
                        <option value="驻">驻</option>
                        <option value="专">专</option>
                    </select>
                </div>
                <div>
                    <label for="container-down" class="label">住'  专:</label>
                    <input type="text" id="container-down" class="input">
                </div>
                <div>
                    <label for="container-up" class="label">住'  注转:</label>
                    <input type="text" id="container-up" class="input">
                </div>
                <div>
                    <label for="notes" class="label">注专转:</label>
                    <textarea id="notes" class="input h-20"></textarea>
                </div>
                <div>
                    <label for="closed-status" class="label flex items-center">
                        <input type="checkbox" id="closed-status" class="form-checkbox h-5 w-5 text-blue-600 rounded mr-2">
                        <span>住专</span>
                    </label>
                </div>

                <button type="submit" id="submit-order-btn" class="btn btn-success w-full mt-4">砖专 </button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content glass-effect text-center">
            <h2 class="text-xl font-bold mb-4 text-gray-800">砖专 驻注</h2>
            <p id="confirm-message" class="mb-6 text-gray-700"> 转  砖专爪 爪注 驻注 ?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="btn btn-danger"></button>
                <button id="confirm-no-btn" class="btn btn-secondary" onclick="closeModal('confirm-modal')"></button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script URL for data operations
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxorjB_uddO1jSLCwWSGUSg4ttlcJU5lHohRX10kYXvpDLKDwqpAib_GZ_-MhVHN1cV/exec';

        let allOrders = []; // Stores all fetched orders
        let currentEditingIndex = null; // Used for edit/duplicate operations
        let currentSortColumn = null;
        let currentSortDirection = 'asc'; // 'asc' or 'desc'

        // Helper function to show/hide modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Function to show an alert popup
        function showAlert(message) {
            document.getElementById('alert-message').innerText = message;
            openModal('alert-modal');
        }

        // Generic function to make API requests to Google Apps Script
        async function makeRequest(action, method = 'GET', data = null) {
            const url = new URL(SCRIPT_URL);
            url.searchParams.append('action', action); // Add the action parameter

            let options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url.toString(), options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.message || 'Unknown error from server.');
                }
                return result.data;
            } catch (error) {
                console.error('API Request Error:', error);
                showAlert(`砖转 转拽砖专转: ${error.message}.  住 砖.`);
                return null;
            }
        }

        // Function to fetch all orders from Google Sheet
        async function fetchOrders() {
            document.getElementById('orders-table-body').innerHTML = `<tr><td colspan="13" class="text-center py-4 text-gray-500">注 转...</td></tr>`;
            const data = await makeRequest('getOrders');
            if (data) {
                allOrders = data;
                applyFiltersAndRenderTable(); // Apply filters before rendering
                updateSummary();
                checkAnomalies();
                renderCharts(); // Render chart placeholders
            } else {
                document.getElementById('orders-table-body').innerHTML = `<tr><td colspan="13" class="text-center py-4 text-red-500"> 转 注 转.</td></tr>`;
            }
        }

        // Function to calculate days passed/remaining
        function calculateDays(startDateStr, endDateStr = null) {
            const today = new Date();
            const startDate = new Date(startDateStr);
            let daysPassed = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
            if (isNaN(daysPassed)) daysPassed = 0; // Handle invalid date

            let daysPassedUp = null;
            if (endDateStr) {
                const endDate = new Date(endDateStr);
                daysPassedUp = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                if (isNaN(daysPassedUp)) daysPassedUp = 0;
            }
            return { daysPassed, daysPassedUp };
        }

        // Function to apply filters and then render the table
        function applyFiltersAndRenderTable() {
            let filteredAndSortedOrders = [...allOrders]; // Start with a copy of all orders

            // 1. Apply Search Filters
            const searchTermClient = document.getElementById('search-client-name').value.toLowerCase();
            const searchTermAddress = document.getElementById('search-address').value.toLowerCase();
            const searchTermContainerDown = document.getElementById('search-container-down').value.toLowerCase();
            const searchTermContainerUp = document.getElementById('search-container-up').value.toLowerCase();

            filteredAndSortedOrders = filteredAndSortedOrders.filter(order => {
                const clientMatch = !searchTermClient || (order.clientName && order.clientName.toLowerCase().includes(searchTermClient));
                const addressMatch = !searchTermAddress || (order.address && order.address.toLowerCase().includes(searchTermAddress));
                const containerDownMatch = !searchTermContainerDown || (order.containerDown && order.containerDown.toLowerCase().includes(searchTermContainerDown));
                const containerUpMatch = !searchTermContainerUp || (order.containerUp && order.containerUp.toLowerCase().includes(searchTermContainerUp));
                return clientMatch && addressMatch && containerDownMatch && containerUpMatch;
            });

            // 2. Apply Status Filter
            const filterStatus = document.getElementById('filter-status').value;
            filteredAndSortedOrders = filteredAndSortedOrders.filter(order => {
                const { daysPassed } = calculateDays(order.orderDate);
                const isOverdue = (order.actionType === '爪' && daysPassed > 30 && order.closed !== 'V') ||
                                  (order.actionType === '驻' && daysPassed > 14 && order.closed !== 'V');

                if (filterStatus === 'open') {
                    return order.closed !== 'V';
                } else if (filterStatus === 'closed') {
                    return order.closed === 'V';
                } else if (filterStatus === 'overdue') {
                    return isOverdue;
                }
                return true; // 'all' status or no filter selected
            });

            // 3. Apply Date Range Filter
            const filterDateFrom = document.getElementById('filter-date-from').value;
            const filterDateTo = document.getElementById('filter-date-to').value;

            if (filterDateFrom) {
                const fromDate = new Date(filterDateFrom);
                filteredAndSortedOrders = filteredAndSortedOrders.filter(order => {
                    const orderDate = new Date(order.orderDate);
                    return orderDate >= fromDate;
                });
            }
            if (filterDateTo) {
                const toDate = new Date(filterDateTo);
                filteredAndSortedOrders = filteredAndSortedOrders.filter(order => {
                    const orderDate = new Date(order.orderDate);
                    return orderDate <= toDate;
                });
            }

            // 4. Apply Sorting
            if (currentSortColumn) {
                filteredAndSortedOrders.sort((a, b) => {
                    const valA = a[currentSortColumn];
                    const valB = b[currentSortColumn];

                    if (valA === null || valA === undefined) return currentSortDirection === 'asc' ? 1 : -1;
                    if (valB === null || valB === undefined) return currentSortDirection === 'asc' ? -1 : 1;

                    if (typeof valA === 'string' && typeof valB === 'string') {
                        return currentSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return currentSortDirection === 'asc' ? valA - valB : valB - valA;
                    }
                    // For dates, convert to Date objects for comparison
                    if (currentSortColumn === 'orderDate' || currentSortColumn === 'containerUpDate') {
                        const dateA = new Date(valA);
                        const dateB = new Date(valB);
                        return currentSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                    }
                    return 0; // Fallback
                });
            }

            renderTable(filteredAndSortedOrders);
        }


        // Function to render the table with filtered/sorted data
        function renderTable(ordersToDisplay) {
            const tableBody = document.getElementById('orders-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            if (ordersToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="13" class="text-center py-4 text-gray-500"> 转 爪 转 住.</td></tr>`;
                return;
            }

            ordersToDisplay.forEach(order => {
                const originalIndex = allOrders.indexOf(order); // Get the original index in allOrders
                const { daysPassed, daysPassedUp } = calculateDays(order.orderDate, order.containerUpDate);

                let isOverdue = false;
                // Example overdue logic: if it's an '爪' and daysPassed > 30 (arbitrary threshold)
                // Or if '驻' is expected but not yet marked 'closed' and days passed is high
                if (order.actionType === '爪' && daysPassed > 30 && order.closed !== 'V') {
                    isOverdue = true;
                } else if (order.actionType === '驻' && order.closed !== 'V' && daysPassed > 14) { // Assuming pick up should be faster
                    isOverdue = true;
                }

                const row = tableBody.insertRow();
                if (isOverdue) {
                    row.classList.add('flashing-red');
                }

                // Add row cells based on the specified order of columns
                row.insertCell(0).innerText = order.orderDate || ''; // 转专
                row.insertCell(1).innerText = order.documentId || ''; // 转注
                row.insertCell(2).innerText = order.agentName || ''; // 砖 住
                row.insertCell(3).innerText = order.clientName || ''; // 砖 拽
                row.insertCell(4).innerText = order.address || ''; // 转转
                row.insertCell(5).innerText = order.actionType || ''; // 住 驻注
                row.insertCell(6).innerText = daysPassed; //  砖注专 (专)
                row.insertCell(7).innerText = order.containerDown || ''; // 住'  专
                row.insertCell(8).innerText = order.containerUp || ''; // 住'  注转
                row.insertCell(9).innerText = daysPassedUp !== null ? daysPassedUp : ''; //  砖注专 (注转)
                row.insertCell(10).innerText = order.closed === 'V' ? '住专' : '驻转'; // closed
                row.insertCell(11).innerText = order.notes || ''; // 注专转

                // Actions cell
                const actionsCell = row.insertCell(12);
                actionsCell.classList.add('text-center');
                actionsCell.innerHTML = `
                    <div class="flex justify-center gap-2">
                        <button onclick="openEditModal(${originalIndex})" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out" title="注专">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-9.303 8.303L.36 17.045a1 1 0 00-.083.277l-1 4a1 1 0 001.275 1.275l4-1a1 1 0 00.277-.083l6.094-6.094-2.828-2.828-6.094 6.094z"></path></svg>
                        </button>
                        <button onclick="duplicateOrder(${originalIndex})" class="text-green-600 hover:text-green-800 transition duration-150 ease-in-out" title="砖驻">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z"></path><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z"></path></svg>
                        </button>
                        ${order.closed !== 'V' ? `<button onclick="confirmAction('close', ${originalIndex})" class="text-yellow-600 hover:text-yellow-800 transition duration-150 ease-in-out" title="住专">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"></path></svg>
                        </button>` : ''}
                        <button onclick="confirmAction('delete', ${originalIndex})" class="text-red-600 hover:text-red-800 transition duration-150 ease-in-out" title="拽">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
            });
        }

        // Function to update summary statistics
        function updateSummary() {
            const activeOrders = allOrders.filter(order => order.closed !== 'V');
            const containersInUse = new Set(activeOrders.map(order => order.containerDown).filter(Boolean)).size;
            const activeClients = new Set(activeOrders.map(order => order.clientName).filter(Boolean)).size;
            const totalOrders = allOrders.length;

            let overdueCount = 0;
            activeOrders.forEach(order => {
                const { daysPassed } = calculateDays(order.orderDate);
                if ((order.actionType === '爪' && daysPassed > 30) || (order.actionType === '驻' && daysPassed > 14)) {
                    overdueCount++;
                }
            });

            document.getElementById('containers-in-use').innerText = containersInUse;
            document.getElementById('active-clients').innerText = activeClients;
            document.getElementById('overdue-containers').innerText = overdueCount;
            document.getElementById('total-orders').innerText = totalOrders;
        }

        // Anomaly Detection: Duplicates and inconsistencies
        function checkAnomalies() {
            let alerts = [];
            const activeOrders = allOrders.filter(order => order.closed !== 'V');

            const clientContainers = {}; // clientName: [containerId1, containerId2]
            const containerHistory = {}; // containerId: [{clientName, actionType, orderIndex}]

            activeOrders.forEach((order, idx) => {
                if (order.clientName) {
                    clientContainers[order.clientName] = clientContainers[order.clientName] || [];
                    if (order.containerDown && !clientContainers[order.clientName].includes(order.containerDown)) {
                        clientContainers[order.clientName].push(order.containerDown);
                    }
                }

                if (order.containerDown) {
                    containerHistory[order.containerDown] = containerHistory[order.containerDown] || [];
                    containerHistory[order.containerDown].push({
                        clientName: order.clientName,
                        actionType: order.actionType,
                        orderIndex: idx
                    });
                }
            });

            // Check for multiple active containers for the same client
            for (const client in clientContainers) {
                if (clientContainers[client].length > 1) {
                    alerts.push(`拽 '${client}' 驻注 注 住驻专 转 驻注转 (${clientContainers[client].join(', ')}). 拽   转拽.`);
                }
            }

            // Check for container inconsistencies (e.g., container placed multiple times without being picked up)
            for (const container in containerHistory) {
                const history = containerHistory[container];
                let placementCount = 0;
                let pickupCount = 0;

                history.forEach(entry => {
                    if (entry.actionType === '爪') placementCount++;
                    if (entry.actionType === '驻') pickupCount++;
                });

                if (placementCount > pickupCount + 1) { // More placements than pickups
                    alerts.push(` '${container}'  住驻专 驻注  砖驻转. 拽 转 住专 砖.`);
                }
                if (pickupCount > placementCount) { // More pickups than placements (error)
                     alerts.push(` '${container}' 驻转 转专 驻注 砖. 转 专.`);
                }
            }
            
            // Display alerts if any
            if (alerts.length > 0) {
                showAlert(' 专转 注专转:\n' + alerts.join('\n'));
            }
        }


        // CRUD Operations

        // Open Add Order Modal
        document.getElementById('add-order-btn').addEventListener('click', () => {
            document.getElementById('order-modal-title').innerText = '住祝  砖';
            document.getElementById('order-form').reset(); // Clear form
            document.getElementById('order-index').value = ''; // Clear index for new order
            document.getElementById('closed-status').checked = false; // Default to open
            currentEditingIndex = null;
            openModal('order-modal');
        });

        // Open Edit Order Modal
        function openEditModal(index) {
            currentEditingIndex = index;
            document.getElementById('order-modal-title').innerText = '注专  拽转';
            const order = allOrders[index];

            document.getElementById('order-index').value = index;
            document.getElementById('order-date').value = order.orderDate || '';
            document.getElementById('document-id').value = order.documentId || '';
            document.getElementById('agent-name').value = order.agentName || '';
            document.getElementById('client-name').value = order.clientName || '';
            document.getElementById('address').value = order.address || '';
            document.getElementById('action-type').value = order.actionType || '';
            document.getElementById('container-down').value = order.containerDown || '';
            document.getElementById('container-up').value = order.containerUp || '';
            document.getElementById('notes').value = order.notes || '';
            document.getElementById('closed-status').checked = (order.closed === 'V');

            openModal('order-modal');
        }

        // Submit Add/Edit Form
        document.getElementById('order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const orderData = {
                orderDate: document.getElementById('order-date').value,
                documentId: document.getElementById('document-id').value,
                agentName: document.getElementById('agent-name').value,
                clientName: document.getElementById('client-name').value,
                address: document.getElementById('address').value,
                actionType: document.getElementById('action-type').value,
                containerDown: document.getElementById('container-down').value,
                containerUp: document.getElementById('container-up').value,
                // Only update containerUpDate if containerUp is provided AND it's a new entry or it changed
                containerUpDate: document.getElementById('container-up').value && !allOrders[currentEditingIndex]?.containerUpDate ? new Date().toISOString().slice(0, 10) : (allOrders[currentEditingIndex]?.containerUpDate || ''),
                closed: document.getElementById('closed-status').checked ? 'V' : '',
                notes: document.getElementById('notes').value
            };

            closeModal('order-modal'); // Close modal immediately

            let success = false;
            if (currentEditingIndex !== null) {
                // Update existing order
                orderData.rowIndex = currentEditingIndex + 2; // +2 for header row and 0-based index
                success = await makeRequest('updateOrder', 'POST', orderData);
            } else {
                // Add new order
                success = await makeRequest('addOrder', 'POST', orderData);
            }

            if (success) {
                await fetchOrders(); // Refresh data from sheet
                showAlert('驻注 爪注 爪!');
            } else {
                showAlert('砖 爪注 驻注.  住 砖.');
            }
        });

        // Add Dummy Order
        document.getElementById('add-dummy-order-btn').addEventListener('click', async () => {
            const dummyOrder = {
                orderDate: new Date().toISOString().slice(0, 10),
                documentId: `DUMMY-${Math.floor(Math.random() * 10000)}`,
                agentName: '住 拽',
                clientName: `拽  ${Math.floor(Math.random() * 100)}`,
                address: '专 拽 1, 注专 ',
                actionType: '爪',
                containerDown: `C${Math.floor(Math.random() * 1000)}`,
                containerUp: '',
                containerUpDate: '',
                closed: '',
                notes: ' 转  拽.'
            };

            const success = await makeRequest('addOrder', 'POST', dummyOrder);
            if (success) {
                await fetchOrders();
                showAlert('转  爪专 爪!');
            } else {
                showAlert('砖 爪专转 转 .');
            }
        });

        // Duplicate Order
        async function duplicateOrder(index) {
            const originalOrder = allOrders[index];
            const newOrder = { ...originalOrder };

            // Reset properties for a new, duplicated order
            newOrder.orderDate = new Date().toISOString().slice(0, 10);
            newOrder.documentId = `COPY-${originalOrder.documentId || Math.floor(Math.random() * 10000)}`;
            newOrder.containerUp = ''; // Clear container up for new action
            newOrder.containerUpDate = '';
            newOrder.closed = ''; // New order is open

            // Adjust action type based on original for common scenarios
            if (originalOrder.actionType === '爪') {
                newOrder.actionType = '驻'; // Suggest pickup if original was placement
                newOrder.containerDown = originalOrder.containerDown; // Keep same container if picking up
            } else if (originalOrder.actionType === '驻') {
                newOrder.actionType = '爪'; // Suggest placement if original was pickup
                newOrder.containerDown = ''; // Clear container down for new placement
            } else {
                newOrder.actionType = '驻'; // Generic for other types
            }
            newOrder.notes = `注转拽 : ${originalOrder.documentId || ''} - ${originalOrder.notes || ''}`;

            const success = await makeRequest('addOrder', 'POST', newOrder);
            if (success) {
                await fetchOrders();
                showAlert(' 砖驻 爪!');
            } else {
                showAlert('砖 砖驻 .');
            }
        }

        // Confirmation for Delete/Close
        let pendingAction = { type: null, index: null };
        function confirmAction(type, index) {
            pendingAction = { type, index };
            let message = '';
            if (type === 'delete') {
                message = ' 转  砖专爪 拽   爪转转? 驻注   驻.';
            } else if (type === 'close') {
                message = ' 转  砖专爪 住专  ?  转住 "住专".';
            }
            document.getElementById('confirm-message').innerText = message;
            openModal('confirm-modal');
        }

        document.getElementById('confirm-yes-btn').addEventListener('click', async () => {
            closeModal('confirm-modal');
            const { type, index } = pendingAction;
            let success = false;
            if (type === 'delete') {
                // Delete operation (requires row index for Google Apps Script)
                success = await makeRequest('deleteOrder', 'POST', { rowIndex: index + 2 }); // +2 for header row and 0-based index
            } else if (type === 'close') {
                // Close operation (updates 'closed' status)
                const orderToUpdate = { ...allOrders[index] };
                orderToUpdate.closed = 'V'; // Mark as closed
                orderToUpdate.rowIndex = index + 2;
                // If actionType is '爪' and we are closing it, assume containerUpDate is today and containerUp is containerDown
                if (orderToUpdate.actionType === '爪' && !orderToUpdate.containerUp) {
                    orderToUpdate.containerUpDate = new Date().toISOString().slice(0, 10);
                    orderToUpdate.containerUp = orderToUpdate.containerDown; // Assume same container is picked up
                }
                success = await makeRequest('updateOrder', 'POST', orderToUpdate);
            }

            if (success) {
                await fetchOrders(); // Re-fetch all data to reflect changes
                showAlert(` ${type === 'delete' ? '拽' : '住专'} 爪!`);
            } else {
                showAlert(`砖 爪注 驻注转 ${type === 'delete' ? '拽' : '住专'}.`);
            }
            pendingAction = { type: null, index: null }; // Reset
        });

        // Export Functions
        function exportTableToCSV(filename) {
            const csv = [];
            const rows = document.querySelectorAll("#orders-table-body tr");
            const headerCells = document.querySelectorAll("thead th");
            
            // Get header text
            const header = Array.from(headerCells).map(th => th.innerText).join(',');
            csv.push(header);

            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length -1; j++) { // Exclude the actions column
                    let data = cols[j].innerText.replace(/"/g, '""'); // Escape double quotes
                    row.push(`"${data}"`);
                }
                csv.push(row.join(','));
            }

            const csvFile = new Blob([csv.join('\n')], { type: "text/csv;charset=utf-8;" });
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(csvFile);
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            showAlert(' 爪 爪 -CSV!');
        }

        function exportTableToPDF(filename) {
            showAlert('驻拽爪转 爪 -PDF 专砖转 住驻专 爪转 ( jsPDF). 专注  驻拽爪转 .');
            // This function would typically use a library like jsPDF or html2pdf.
            // Example using a hypothetical library:
            // const element = document.getElementById('orders-table-body').closest('table');
            // html2pdf().from(element).save(filename);
        }

        // Chart Placeholders (actual chart rendering would use a library like Chart.js)
        function renderCharts() {
            // This is where you would integrate Chart.js or another charting library
            // For example:
            // const ctx1 = document.getElementById('chart-containers-by-client').getContext('2d');
            // new Chart(ctx1, { type: 'bar', data: yourData, options: yourOptions });
            
            // For now, they remain placeholders as the prompt specifies to suggest external libraries for full functionality
        }


        // Event Listeners for main buttons and filters
        document.getElementById('refresh-btn').addEventListener('click', fetchOrders);
        document.getElementById('apply-filters-btn').addEventListener('click', applyFiltersAndRenderTable);

        // Add event listeners for search inputs to trigger filtering on input
        document.getElementById('search-client-name').addEventListener('input', applyFiltersAndRenderTable);
        document.getElementById('search-address').addEventListener('input', applyFiltersAndRenderTable);
        document.getElementById('search-container-down').addEventListener('input', applyFiltersAndRenderTable);
        document.getElementById('search-container-up').addEventListener('input', applyFiltersAndRenderTable);
        document.getElementById('filter-status').addEventListener('change', applyFiltersAndRenderTable);
        document.getElementById('filter-date-from').addEventListener('change', applyFiltersAndRenderTable);
        document.getElementById('filter-date-to').addEventListener('change', applyFiltersAndRenderTable);

        // Export button listeners
        document.getElementById('export-excel-btn').addEventListener('click', () => exportTableToCSV('Container_Rentals.csv'));
        document.getElementById('export-pdf-btn').addEventListener('click', () => exportTableToPDF('Container_Rentals.pdf'));

        // Add event listeners for table headers for sorting
        document.querySelectorAll('th[data-sort-by]').forEach(header => {
            header.addEventListener('click', function() {
                const sortBy = this.getAttribute('data-sort-by');
                if (currentSortColumn === sortBy) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = sortBy;
                    currentSortDirection = 'asc';
                }
                applyFiltersAndRenderTable();
            });
        });

        // Initial data load on page load
        window.onload = fetchOrders;

    </script>
</body>
</html>
