<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת CRM לניהול מכולות מתקדם</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7e22ce',
                            800: '#6b21a8',
                            900: '#581c87',
                        },
                        secondary: {
                            100: '#f0f9ff',
                            200: '#e0f2fe',
                            300: '#bae6fd',
                            400: '#7dd3fc',
                            500: '#38bdf8',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        danger: {
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            direction: rtl;
            text-align: right;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            flex-grow: 1;
        }
        
        /* Glassmorphism Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* Buttons */
        .btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-primary {
            background-color: rgba(168, 85, 247, 0.9);
            color: white;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary:hover {
            background-color: rgba(147, 51, 234, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-secondary {
            background-color: rgba(156, 163, 175, 0.2);
            color: #4b5563;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .btn-secondary:hover {
            background-color: rgba(156, 163, 175, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-danger {
            background-color: rgba(249, 115, 22, 0.9);
            color: white;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-danger:hover {
            background-color: rgba(234, 88, 12, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Input Fields */
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(209, 213, 219, 0.5);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        /* Table Styles */
        #ordersTableContainer {
            max-height: 60vh;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid rgba(209, 213, 219, 0.5);
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        #ordersTable {
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        #ordersTable thead th {
            position: sticky;
            top: 0;
            background-color: rgba(249, 250, 251, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(209, 213, 219, 0.5);
        }
        
        #ordersTable tbody tr {
            transition: all 0.2s ease;
        }
        
        .table-row-open {
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        .table-row-open:hover {
            background-color: rgba(240, 249, 255, 0.8);
        }
        
        .table-row-closed {
            background-color: rgba(248, 250, 252, 0.6);
            text-decoration: line-through;
            color: #94a3b8;
        }
        
        .table-row-closed:hover {
            background-color: rgba(224, 231, 240, 0.7);
        }
        
        #ordersTable tbody td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            border-bottom: 1px solid rgba(209, 213, 219, 0.3);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #a855f7;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9333ea;
        }
        
        /* Header Styles */
        .app-header {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            border-radius: 0 0 16px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo-text {
            font-size: 1.75rem;
            font-weight: 700;
            color: #581c87;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .datetime-display {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: #7e22ce;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }
        
        /* Alert Banner */
        .alert-banner {
            background-color: #f97316;
            color: #ffffff;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: sticky;
            top: 0;
            z-index: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .alert-banner:hover {
            background-color: #ea580c;
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(31, 41, 55, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #a855f7;
            width: 64px;
            height: 64px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .glass-card {
                padding: 1rem;
            }
            
            .modal-content {
                padding: 1.5rem;
                width: 95%;
            }
            
            #ordersTable thead th,
            #ordersTable tbody td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <p class="text-white mt-4 text-lg">טוען נתונים...</p>
        </div>
    </div>

    <!-- Header -->
    <div class="app-header">
        <div class="logo-text">
            <i class="fas fa-boxes text-primary-700"></i>
            <span>ניהול מכולות מתקדם</span>
        </div>
        <div id="datetime" class="datetime-display"></div>
    </div>

    <!-- Alert Banner -->
    <div id="alertBanner" class="alert-banner hidden">
        <p><i class="fas fa-exclamation-triangle ml-2"></i> ישנן <span id="exceedingOrdersCount">0</span> הזמנות חורגות. לחץ לסינון מהיר.</p>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 md:px-8 py-6 main-content">
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-card flex items-center justify-between p-6">
                <div>
                    <p class="text-gray-600 text-sm">הזמנות פתוחות</p>
                    <p id="openOrdersCount" class="text-2xl font-bold text-primary-600">0</p>
                </div>
                <i class="fas fa-box-open text-4xl text-primary-400 opacity-70"></i>
            </div>
            
            <div class="glass-card flex items-center justify-between p-6">
                <div>
                    <p class="text-gray-600 text-sm">הזמנות חורגות</p>
                    <p id="exceedingOrdersCountCard" class="text-2xl font-bold text-danger-600">0</p>
                </div>
                <i class="fas fa-bell text-4xl text-danger-400 opacity-70"></i>
            </div>
            
            <div class="glass-card flex items-center justify-between p-6">
                <div>
                    <p class="text-gray-600 text-sm">מכולות בשימוש</p>
                    <p id="inUseContainersCount" class="text-2xl font-bold text-secondary-600">0</p>
                </div>
                <i class="fas fa-shipping-fast text-4xl text-secondary-400 opacity-70"></i>
            </div>
            
            <div class="glass-card flex items-center justify-between p-6">
                <div>
                    <p class="text-gray-600 text-sm">לקוחות פעילים</p>
                    <p id="activeCustomersCount" class="text-2xl font-bold text-blue-600">0</p>
                </div>
                <i class="fas fa-users text-4xl text-blue-400 opacity-70"></i>
            </div>
        </div>

        <!-- Add New Order Button -->
        <div class="flex justify-end mb-6">
            <button id="addOrderBtn" class="btn btn-primary flex items-center">
                <i class="fas fa-plus ml-2"></i> הוסף הזמנה חדשה
            </button>
        </div>

        <!-- Search and Filter Section -->
        <div class="glass-card p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">חיפוש וסינון הזמנות</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div>
                    <label for="searchClientName" class="block text-gray-700 text-sm font-bold mb-2">שם לקוח:</label>
                    <input type="text" id="searchClientName" placeholder="הכנס שם לקוח" class="input-field">
                </div>
                
                <div>
                    <label for="searchAddress" class="block text-gray-700 text-sm font-bold mb-2">כתובת:</label>
                    <input type="text" id="searchAddress" placeholder="הכנס כתובת" class="input-field">
                </div>
                
                <div>
                    <label for="searchActionType" class="block text-gray-700 text-sm font-bold mb-2">סוג פעולה:</label>
                    <select id="searchActionType" class="input-field">
                        <option value="">הכל</option>
                        <option value="הצבה">הצבה</option>
                        <option value="הוצאה">הוצאה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        <option value="החלפה">החלפה</option>
                    </select>
                </div>
                
                <div>
                    <label for="searchStatus" class="block text-gray-700 text-sm font-bold mb-2">סטטוס:</label>
                    <select id="searchStatus" class="input-field">
                        <option value="">הכל</option>
                        <option value="פתוחה">פתוחה</option>
                        <option value="סגורה">סגורה</option>
                    </select>
                </div>
                
                <div>
                    <label for="searchDate" class="block text-gray-700 text-sm font-bold mb-2">תאריך (מתאריך):</label>
                    <input type="date" id="searchDate" class="input-field">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end gap-4">
                <button id="applyFilterBtn" class="btn btn-primary">הפעל סינון</button>
                <button id="clearFilterBtn" class="btn btn-secondary">נקה סינון</button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="glass-card p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">טבלת הזמנות</h2>
            <div id="ordersTableContainer">
                <table id="ordersTable" class="w-full">
                    <thead>
                        <tr>
                            <th>מתאריך</th>
                            <th>תעודה</th>
                            <th>שם סוכן</th>
                            <th>שם לקוח</th>
                            <th>כתובת</th>
                            <th>סוג פעולה</th>
                            <th>ימים שעברו (ירדה)</th>
                            <th>מס" מכולה ירדה</th>
                            <th>מס" מכולה עלתה</th>
                            <th>ימים שעברו (עלתה)</th>
                            <th>סטטוס</th>
                            <th>הערות</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr>
                            <td colspan="13" class="text-center py-4 text-gray-500">טוען הזמנות...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="glass-card p-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">מכולות בשימוש לפי לקוחות</h2>
                <div class="h-80">
                    <canvas id="containersByClientChart"></canvas>
                </div>
            </div>
            
            <div class="glass-card p-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">סוגי פעולות</h2>
                <div class="h-80">
                    <canvas id="actionTypesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Add/Edit Order Modal -->
    <div id="orderModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="orderModalTitle" class="text-2xl font-bold mb-6 text-gray-800">הוסף הזמנה חדשה</h2>
            <button class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal('orderModal')">
                <i class="fas fa-times"></i>
            </button>

            <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="orderRowIndex">
                
                <div>
                    <label for="orderFromDate" class="block text-gray-700 text-sm font-bold mb-2">מתאריך:</label>
                    <input type="date" id="orderFromDate" class="input-field" required>
                </div>
                
                <div>
                    <label for="orderDocumentId" class="block text-gray-700 text-sm font-bold mb-2">תעודה:</label>
                    <input type="text" id="orderDocumentId" class="input-field" required>
                </div>
                
                <div>
                    <label for="orderAgentName" class="block text-gray-700 text-sm font-bold mb-2">שם סוכן:</label>
                    <input type="text" id="orderAgentName" class="input-field" required>
                </div>
                
                <div>
                    <label for="orderClientName" class="block text-gray-700 text-sm font-bold mb-2">שם לקוח:</label>
                    <input type="text" id="orderClientName" class="input-field" required>
                </div>
                
                <div class="md:col-span-2">
                    <label for="orderAddress" class="block text-gray-700 text-sm font-bold mb-2">כתובת:</label>
                    <input type="text" id="orderAddress" class="input-field" required>
                </div>
                
                <div>
                    <label for="orderActionType" class="block text-gray-700 text-sm font-bold mb-2">סוג פעולה:</label>
                    <select id="orderActionType" class="input-field" required>
                        <option value="הצבה">הצבה</option>
                        <option value="הוצאה">הוצאה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        <option value="החלפה">החלפה</option>
                    </select>
                </div>
                
                <div>
                    <label for="orderDaysPassed" class="block text-gray-700 text-sm font-bold mb-2">ימים שעברו (ירדה):</label>
                    <input type="number" id="orderDaysPassed" class="input-field">
                </div>
                
                <div>
                    <label for="orderContainerRemoved" class="block text-gray-700 text-sm font-bold mb-2">מס" מכולה ירדה:</label>
                    <input type="text" id="orderContainerRemoved" class="input-field">
                </div>
                
                <div>
                    <label for="orderContainerAdded" class="block text-gray-700 text-sm font-bold mb-2">מס" מכולה עלתה:</label>
                    <input type="text" id="orderContainerAdded" class="input-field">
                </div>
                
                <div>
                    <label for="orderDaysPassedAdded" class="block text-gray-700 text-sm font-bold mb-2">ימים שעברו (עלתה):</label>
                    <input type="number" id="orderDaysPassedAdded" class="input-field" disabled>
                </div>
                
                <div>
                    <label for="orderStatus" class="block text-gray-700 text-sm font-bold mb-2">סטטוס:</label>
                    <select id="orderStatus" class="input-field" required>
                        <option value="פתוחה">פתוחה</option>
                        <option value="סגורה">סגורה</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label for="orderNotes" class="block text-gray-700 text-sm font-bold mb-2">הערות:</label>
                    <textarea id="orderNotes" rows="3" class="input-field"></textarea>
                </div>
                
                <div class="md:col-span-2 flex justify-end gap-4 mt-6">
                    <button type="submit" class="btn btn-primary" id="saveOrderBtn">שמור הזמנה</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('orderModal')">ביטול</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">פרטי הזמנה</h2>
            <button class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal('orderDetailModal')">
                <i class="fas fa-times"></i>
            </button>

            <div id="orderDetailsContent" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-right">
                <!-- Details will be populated here -->
            </div>

            <div class="flex justify-center gap-4 mt-8">
                <button id="detailEditBtn" class="btn btn-primary flex items-center">
                    <i class="fas fa-edit ml-2"></i> ערוך
                </button>
                <button id="detailDuplicateBtn" class="btn btn-warning flex items-center">
                    <i class="fas fa-copy ml-2"></i> שכפל
                </button>
                <button id="detailCloseBtn" class="btn btn-secondary flex items-center">
                    <i class="fas fa-check-circle ml-2"></i> סגור
                </button>
                <button id="detailDeleteBtn" class="btn btn-danger flex items-center">
                    <i class="fas fa-trash ml-2"></i> מחק
                </button>
            </div>
        </div>
    </div>

    <!-- General Alert Modal -->
    <div id="generalAlertModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <button class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal('generalAlertModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 id="alertModalTitle" class="text-xl font-semibold mb-4 text-gray-800"></h3>
            <p id="alertModalMessage" class="text-gray-700 mb-6"></p>
            <div id="alertModalActions" class="flex justify-center gap-4">
                <button type="button" class="btn btn-primary" onclick="closeModal('generalAlertModal')">אישור</button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwDJZ-rGmv0CS8S_B8TMoSkKxKrzc3D5TVIv5wYaRh8nb0ZXCXHXNxxMJ09fsRnVN2/exec';
        
        // Global variables
        let allOrders = { openOrders: [], closedOrders: [] };
        let filteredOrders = [];
        let containersByClientChart;
        let actionTypesChart;
        
        // Helper Functions
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showGeneralModal(title, message, isConfirm = false, onConfirm = null) {
            document.getElementById('alertModalTitle').innerText = title;
            document.getElementById('alertModalMessage').innerHTML = message;
            
            const actionsDiv = document.getElementById('alertModalActions');
            actionsDiv.innerHTML = '';
            
            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn btn-danger';
                confirmBtn.innerText = 'כן, אשר';
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    closeModal('generalAlertModal');
                };
                actionsDiv.appendChild(confirmBtn);
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.innerText = 'ביטול';
                cancelBtn.onclick = () => closeModal('generalAlertModal');
                actionsDiv.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'btn btn-primary';
                okBtn.innerText = 'אישור';
                okBtn.onclick = () => closeModal('generalAlertModal');
                actionsDiv.appendChild(okBtn);
            }
            
            document.getElementById('generalAlertModal').classList.remove('hidden');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return dateString;
            return date.toLocaleDateString('he-IL', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        function calculateDaysPassed(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            
            const diffTime = today.getTime() - date.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays >= 0 ? diffDays : 0;
        }
        
        function updateLiveDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const formattedDate = now.toLocaleDateString('he-IL', dateOptions);
            const formattedTime = now.toLocaleTimeString('he-IL', timeOptions);
            document.getElementById('datetime').innerText = `${formattedDate} | ${formattedTime}`;
        }
        
        // Data Fetching and Rendering
        
        async function fetchOrders() {
            showLoading();
            try {
                const response = await fetch(`${SCRIPT_URL}?action=list`);
                if (!response.ok) throw new Error(`שגיאת תקשורת: ${response.status}`);
                
                const data = await response.json();
                if (data.status === 'success') {
                    allOrders = data.data;
                    filteredOrders = [...allOrders.openOrders, ...allOrders.closedOrders];
                    updateDashboard();
                    renderOrdersTable(filteredOrders);
                    updateCharts();
                    runAlertChecks();
                } else {
                    showGeneralModal('שגיאה בשליפת נתונים', data.message);
                }
            } catch (error) {
                console.error('שגיאה בטעינת הזמנות:', error);
                showGeneralModal('שגיאה', 'לא ניתן לטעון הזמנות. אנא נסה שוב מאוחר יותר.');
            } finally {
                hideLoading();
            }
        }
        
        function updateDashboard() {
            const openCount = allOrders.openOrders.length;
            document.getElementById('openOrdersCount').innerText = openCount;
            
            const exceedingOrders = allOrders.openOrders.filter(order => {
                const daysPassedAdded = parseInt(order['ימים שעברו (עלתה)']);
                return order['closed'] === 'פתוחה' && daysPassedAdded >= 7;
            });
            
            document.getElementById('exceedingOrdersCount').innerText = exceedingOrders.length;
            document.getElementById('exceedingOrdersCountCard').innerText = exceedingOrders.length;
            
            if (exceedingOrders.length > 0) {
                document.getElementById('alertBanner').classList.remove('hidden');
            } else {
                document.getElementById('alertBanner').classList.add('hidden');
            }
            
            const inUseContainers = new Set(allOrders.openOrders.map(order => order['מס" מכולה עלתה']).filter(Boolean));
            document.getElementById('inUseContainersCount').innerText = inUseContainers.size;
            
            const activeCustomers = new Set(allOrders.openOrders.map(order => order['שם לקוח']).filter(Boolean));
            document.getElementById('activeCustomersCount').innerText = activeCustomers.size;
        }
        
        function renderOrdersTable(ordersToDisplay) {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';
            
            if (ordersToDisplay.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" class="text-center py-4 text-gray-500">אין הזמנות להצגה.</td></tr>';
                return;
            }
            
            ordersToDisplay.forEach(order => {
                const row = document.createElement('tr');
                row.className = order.closed === 'סגורה' ? 'table-row-closed' : 'table-row-open';
                row.dataset.rowIndex = order.rowIndex;
                row.onclick = () => showOrderDetailsModal(order.rowIndex);
                
                const columns = [
                    'מתאריך', 'תעודה', 'שם סוכן', 'שם לקוח', 'כתובת', 'סוג פעולה',
                    'ימים שעברו', 'מס" מכולה ירדה', 'מס" מכולה עלתה', 'ימים שעברו (עלתה)',
                    'closed', 'הערות'
                ];
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-800 border-b border-gray-200';
                    let value = order[col] || '';
                    
                    if (col === 'מתאריך') {
                        value = formatDisplayDate(value);
                    }
                    
                    if (col === 'closed') {
                        td.className += ` font-semibold ${value === 'פתוחה' ? 'text-green-600' : 'text-gray-500'}`;
                    }
                    
                    td.innerText = value;
                    row.appendChild(td);
                });
                
                const actionsTd = document.createElement('td');
                actionsTd.className = 'px-4 py-2 whitespace-nowrap text-sm font-medium border-b border-gray-200';
                actionsTd.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="event.stopPropagation(); editOrder(${order.rowIndex})" class="btn btn-primary p-2 text-sm">
                            <i class="fas fa-edit"></i>
                            <span class="hidden sm:inline mr-1">ערוך</span>
                        </button>
                        <button onclick="event.stopPropagation(); duplicateOrder(${order.rowIndex})" class="btn btn-warning p-2 text-sm">
                            <i class="fas fa-copy"></i>
                            <span class="hidden sm:inline mr-1">שכפל</span>
                        </button>
                        ${order.closed === 'פתוחה' ? `
                        <button onclick="event.stopPropagation(); confirmCloseOrder(${order.rowIndex})" class="btn btn-secondary p-2 text-sm">
                            <i class="fas fa-check-circle"></i>
                            <span class="hidden sm:inline mr-1">סגור</span>
                        </button>
                        ` : ''}
                        <button onclick="event.stopPropagation(); confirmDeleteOrder(${order.rowIndex})" class="btn btn-danger p-2 text-sm">
                            <i class="fas fa-trash"></i>
                            <span class="hidden sm:inline mr-1">מחק</span>
                        </button>
                    </div>
                `;
                row.appendChild(actionsTd);
                tableBody.appendChild(row);
            });
        }
        
        function applyFilter() {
            const clientName = document.getElementById('searchClientName').value.toLowerCase();
            const address = document.getElementById('searchAddress').value.toLowerCase();
            const actionType = document.getElementById('searchActionType').value;
            const status = document.getElementById('searchStatus').value;
            const searchDate = document.getElementById('searchDate').value;
            
            const allCombinedOrders = [...allOrders.openOrders, ...allOrders.closedOrders];
            
            filteredOrders = allCombinedOrders.filter(order => {
                const matchesClient = clientName === '' || (order['שם לקוח'] && order['שם לקוח'].toLowerCase().includes(clientName));
                const matchesAddress = address === '' || (order['כתובת'] && order['כתובת'].toLowerCase().includes(address));
                const matchesActionType = actionType === '' || order['סוג פעולה'] === actionType;
                const matchesStatus = status === '' || order['closed'] === status;
                
                let matchesDate = true;
                if (searchDate) {
                    const orderDate = new Date(order['מתאריך']);
                    const filterDate = new Date(searchDate);
                    matchesDate = orderDate.toDateString() === filterDate.toDateString();
                }
                
                return matchesClient && matchesAddress && matchesActionType && matchesStatus && matchesDate;
            });
            
            renderOrdersTable(filteredOrders);
        }
        
        function clearFilter() {
            document.getElementById('searchClientName').value = '';
            document.getElementById('searchAddress').value = '';
            document.getElementById('searchActionType').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('searchDate').value = '';
            filteredOrders = [...allOrders.openOrders, ...allOrders.closedOrders];
            renderOrdersTable(filteredOrders);
        }
        
        // CRUD Operations
        
        document.getElementById('addOrderBtn').addEventListener('click', () => {
            document.getElementById('orderModalTitle').innerText = 'הוסף הזמנה חדשה';
            document.getElementById('orderForm').reset();
            document.getElementById('orderRowIndex').value = '';
            document.getElementById('orderDaysPassedAdded').disabled = true;
            document.getElementById('orderStatus').value = 'פתוחה';
            document.getElementById('orderModal').classList.remove('hidden');
        });
        
        function editOrder(rowIndex) {
            closeModal('orderDetailModal');
            const orderToEdit = [...allOrders.openOrders, ...allOrders.closedOrders].find(order => order.rowIndex === rowIndex);
            
            if (!orderToEdit) {
                showGeneralModal('שגיאה', 'ההזמנה לא נמצאה לעריכה.');
                return;
            }
            
            document.getElementById('orderModalTitle').innerText = 'ערוך הזמנה';
            document.getElementById('orderRowIndex').value = rowIndex;
            document.getElementById('orderFromDate').value = orderToEdit['מתאריך'] ? new Date(orderToEdit['מתאריך']).toISOString().split('T')[0] : '';
            document.getElementById('orderDocumentId').value = orderToEdit['תעודה'] || '';
            document.getElementById('orderAgentName').value = orderToEdit['שם סוכן'] || '';
            document.getElementById('orderClientName').value = orderToEdit['שם לקוח'] || '';
            document.getElementById('orderAddress').value = orderToEdit['כתובת'] || '';
            document.getElementById('orderActionType').value = orderToEdit['סוג פעולה'] || '';
            document.getElementById('orderDaysPassed').value = orderToEdit['ימים שעברו'] || '';
            document.getElementById('orderContainerRemoved').value = orderToEdit['מס" מכולה ירדה'] || '';
            document.getElementById('orderContainerAdded').value = orderToEdit['מס" מכולה עלתה'] || '';
            document.getElementById('orderDaysPassedAdded').value = orderToEdit['ימים שעברו (עלתה)'] || '';
            document.getElementById('orderDaysPassedAdded').disabled = true;
            document.getElementById('orderStatus').value = orderToEdit['closed'] || 'פתוחה';
            document.getElementById('orderNotes').value = orderToEdit['הערות'] || '';
            
            document.getElementById('orderModal').classList.remove('hidden');
        }
        
        document.getElementById('orderForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            showLoading();
            
            const rowIndex = document.getElementById('orderRowIndex').value;
            const isNew = !rowIndex;
            const action = isNew ? 'add' : 'update';
            
            const formData = {
                'מתאריך': document.getElementById('orderFromDate').value,
                'תעודה': document.getElementById('orderDocumentId').value,
                'שם סוכן': document.getElementById('orderAgentName').value,
                'שם לקוח': document.getElementById('orderClientName').value,
                'כתובת': document.getElementById('orderAddress').value,
                'סוג פעולה': document.getElementById('orderActionType').value,
                'ימים שעברו': document.getElementById('orderDaysPassed').value,
                'מס" מכולה ירדה': document.getElementById('orderContainerRemoved').value,
                'מס" מכולה עלתה': document.getElementById('orderContainerAdded').value,
                'closed': document.getElementById('orderStatus').value,
                'הערות': document.getElementById('orderNotes').value
            };
            
            if (formData['מס" מכולה עלתה'] && formData['מתאריך']) {
                formData['ימים שעברו (עלתה)'] = calculateDaysPassed(formData['מתאריך']);
            } else {
                formData['ימים שעברו (עלתה)'] = '';
            }
            
            const params = new URLSearchParams(formData);
            params.append('action', action);
            if (!isNew) params.append('rowIndex', rowIndex);
            
            try {
                const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    showGeneralModal('הצלחה', data.message);
                    closeModal('orderModal');
                    await fetchOrders();
                } else {
                    showGeneralModal('שגיאה', data.message);
                }
            } catch (error) {
                console.error('שגיאה בשמירת הזמנה:', error);
                showGeneralModal('שגיאה', 'שגיאה בשמירת הזמנה. אנא נסה שוב.');
            } finally {
                hideLoading();
            }
        });
        
        function confirmCloseOrder(rowIndex) {
            closeModal('orderDetailModal');
            showGeneralModal(
                'אשר סגירת הזמנה',
                `האם אתה בטוח שברצונך לסגור את ההזמנה בשורה ${rowIndex}?`,
                true,
                async () => {
                    showLoading();
                    try {
                        const response = await fetch(`${SCRIPT_URL}?action=close&rowIndex=${rowIndex}`);
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            showGeneralModal('הצלחה', data.message);
                            await fetchOrders();
                        } else {
                            showGeneralModal('שגיאה', data.message);
                        }
                    } catch (error) {
                        console.error('שגיאה בסגירת הזמנה:', error);
                        showGeneralModal('שגיאה', 'שגיאה בסגירת הזמנה. אנא נסה שוב.');
                    } finally {
                        hideLoading();
                    }
                }
            );
        }
        
        function confirmDeleteOrder(rowIndex) {
            closeModal('orderDetailModal');
            showGeneralModal(
                'אשר מחיקת הזמנה',
                `האם אתה בטוח שברצונך למחוק את ההזמנה בשורה ${rowIndex}? פעולה זו אינה הפיכה!`,
                true,
                async () => {
                    showLoading();
                    try {
                        const response = await fetch(`${SCRIPT_URL}?action=delete&rowIndex=${rowIndex}`);
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            showGeneralModal('הצלחה', data.message);
                            await fetchOrders();
                        } else {
                            showGeneralModal('שגיאה', data.message);
                        }
                    } catch (error) {
                        console.error('שגיאה במחיקת הזמנה:', error);
                        showGeneralModal('שגיאה', 'שגיאה במחיקת הזמנה. אנא נסה שוב.');
                    } finally {
                        hideLoading();
                    }
                }
            );
        }
        
        async function duplicateOrder(rowIndex) {
            closeModal('orderDetailModal');
            showLoading();
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=duplicate&rowIndex=${rowIndex}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    showGeneralModal('הצלחה', data.message);
                    await fetchOrders();
                } else {
                    showGeneralModal('שגיאה', data.message);
                }
            } catch (error) {
                console.error('שגיאה בשכפול הזמנה:', error);
                showGeneralModal('שגיאה', 'שגיאה בשכפול הזמנה. אנא נסה שוב.');
            } finally {
                hideLoading();
            }
        }
        
        // Order Details Modal
        
        function showOrderDetailsModal(rowIndex) {
            const order = [...allOrders.openOrders, ...allOrders.closedOrders].find(o => o.rowIndex === rowIndex);
            
            if (!order) {
                showGeneralModal('שגיאה', 'פרטי ההזמנה לא נמצאו.');
                return;
            }
            
            const detailsContent = document.getElementById('orderDetailsContent');
            detailsContent.innerHTML = '';
            
            const displayLabels = {
                'מתאריך': 'תאריך:',
                'תעודה': 'מספר תעודה:',
                'שם סוכן': 'סוכן:',
                'שם לקוח': 'לקוח:',
                'כתובת': 'כתובת:',
                'סוג פעולה': 'סוג פעולה:',
                'ימים שעברו': 'ימים שעברו (ירדה):',
                'מס" מכולה ירדה': 'מכולה ירדה:',
                'מס" מכולה עלתה': 'מכולה עלתה:',
                'ימים שעברו (עלתה)': 'ימים שעברו (עלתה):',
                'closed': 'סטטוס:',
                'הערות': 'הערות:'
            };
            
            for (const key in displayLabels) {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'col-span-1 text-gray-600 font-bold text-sm md:text-base';
                labelDiv.innerText = displayLabels[key];
                
                const valueDiv = document.createElement('div');
                valueDiv.className = 'col-span-1 text-gray-800 text-sm md:text-base';
                let displayValue = order[key] || '-';
                
                if (key === 'מתאריך') {
                    displayValue = formatDisplayDate(displayValue);
                }
                
                if (key === 'closed') {
                    valueDiv.className += ` font-semibold ${displayValue === 'פתוחה' ? 'text-green-600' : 'text-gray-500'}`;
                }
                
                valueDiv.innerText = displayValue;
                
                detailsContent.appendChild(labelDiv);
                detailsContent.appendChild(valueDiv);
            }
            
            document.getElementById('detailEditBtn').onclick = () => editOrder(rowIndex);
            document.getElementById('detailDuplicateBtn').onclick = () => duplicateOrder(rowIndex);
            
            const detailCloseBtn = document.getElementById('detailCloseBtn');
            const detailDeleteBtn = document.getElementById('detailDeleteBtn');
            
            if (order.closed === 'פתוחה') {
                detailCloseBtn.classList.remove('hidden');
                detailCloseBtn.onclick = () => confirmCloseOrder(rowIndex);
            } else {
                detailCloseBtn.classList.add('hidden');
            }
            
            detailDeleteBtn.onclick = () => confirmDeleteOrder(rowIndex);
            
            document.getElementById('orderDetailModal').classList.remove('hidden');
        }
        
        // Alert System
        
        function runAlertChecks() {
            const allCombinedOrders = [...allOrders.openOrders, ...allOrders.closedOrders];
            const alerts = [];
            
            // Check for duplicate clients
            const clientNames = {};
            allOrders.openOrders.forEach(order => {
                const client = order['שם לקוח'];
                if (client) clientNames[client] = (clientNames[client] || 0) + 1;
            });
            
            for (const client in clientNames) {
                if (clientNames[client] > 1) {
                    alerts.push(`לקוח כפול: הלקוח "${client}" מופיע ${clientNames[client]} פעמים בהזמנות פתוחות.`);
                }
            }
            
            // Check for duplicate containers
            const containerIds = {};
            allOrders.openOrders.forEach(order => {
                const containerAdded = order['מס" מכולה עלתה'];
                if (containerAdded) containerIds[containerAdded] = (containerIds[containerAdded] || 0) + 1;
            });
            
            for (const container in containerIds) {
                if (containerIds[container] > 1) {
                    alerts.push(`מכולה כפולה: מכולה מספר "${container}" מופיעה ${containerIds[container]} פעמים בהזמנות פתוחות.`);
                }
            }
            
            // Check for exceeding rental days
            allOrders.openOrders.forEach(order => {
                const daysPassedAdded = parseInt(order['ימים שעברו (עלתה)']);
                if (order['closed'] === 'פתוחה' && daysPassedAdded >= 7) {
                    alerts.push(`חריגה בימי שכירות: הזמנה מספר ${order['תעודה']} ללקוח "${order['שם לקוח']}" חורגת בימי השכירות (${daysPassedAdded} ימים).`);
                }
            });
            
            if (alerts.length > 0) {
                const alertsHtml = alerts.map(alert => `<li class="mb-2">${alert}</li>`).join('');
                showGeneralModal(
                    'התראות מערכת',
                    `<ul class="list-disc list-inside text-right">${alertsHtml}</ul>`
                );
            }
        }
        
        // Charts
        
        function updateCharts() {
            renderContainersByClientChart();
            renderActionTypesChart();
        }
        
        function renderContainersByClientChart() {
            const clientContainerCounts = {};
            allOrders.openOrders.forEach(order => {
                if (order['שם לקוח'] && order['מס" מכולה עלתה']) {
                    clientContainerCounts[order['שם לקוח']] = (clientContainerCounts[order['שם לקוח']] || 0) + 1;
                }
            });
            
            const labels = Object.keys(clientContainerCounts);
            const data = Object.values(clientContainerCounts);
            
            const ctx = document.getElementById('containersByClientChart').getContext('2d');
            
            if (containersByClientChart) {
                containersByClientChart.destroy();
            }
            
            containersByClientChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'מספר מכולות בשימוש',
                        data: data,
                        backgroundColor: 'rgba(168, 85, 247, 0.7)',
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'מכולות בשימוש לפי לקוח',
                            font: {
                                size: 16,
                                family: 'Inter'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderActionTypesChart() {
            const actionTypeCounts = {};
            const allCombinedOrders = [...allOrders.openOrders, ...allOrders.closedOrders];
            
            allCombinedOrders.forEach(order => {
                const type = order['סוג פעולה'];
                if (type) actionTypeCounts[type] = (actionTypeCounts[type] || 0) + 1;
            });
            
            const labels = Object.keys(actionTypeCounts);
            const data = Object.values(actionTypeCounts);
            
            const backgroundColors = [
                'rgba(251, 146, 60, 0.7)',
                'rgba(168, 85, 247, 0.7)',
                'rgba(59, 130, 246, 0.7)',
                'rgba(75, 192, 192, 0.7)'
            ];
            
            const borderColors = [
                'rgba(251, 146, 60, 1)',
                'rgba(168, 85, 247, 1)',
                'rgba(59, 130, 246, 1)',
                'rgba(75, 192, 192, 1)'
            ];
            
            const ctx = document.getElementById('actionTypesChart').getContext('2d');
            
            if (actionTypesChart) {
                actionTypesChart.destroy();
            }
            
            actionTypesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'מספר פעולות',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'חלוקת סוגי פעולות',
                            font: {
                                size: 16,
                                family: 'Inter'
                            }
                        }
                    }
                }
            });
        }
        
        // Event Listeners
        
        document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
        document.getElementById('clearFilterBtn').addEventListener('click', clearFilter);
        
        document.getElementById('alertBanner').addEventListener('click', () => {
            document.getElementById('searchStatus').value = 'פתוחה';
            applyFilter();
            showGeneralModal('הזמנות חורגות', 'הטבלה סוננה להצגת הזמנות פתוחות שחורגות מימי השכירות.');
        });
        
        // Initialize
        window.addEventListener('load', () => {
            updateLiveDateTime();
            setInterval(updateLiveDateTime, 1000);
            fetchOrders();
        });
    </script>
</body>
</html>
