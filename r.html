<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª CRM ××ª×§×“××ª ×œ× ×™×”×•×œ ×©×›×™×¨×•×ª ××›×•×œ×•×ª</title>
    
    <!-- Chosen Palette: Calm Neutral Harmony -->
    <!-- Application Structure Plan: The application retains the highly effective three-section structure: Dashboard, Container Inventory, and Treatment Board. This structure provides a clear user flow, starting with a high-level overview (Dashboard), allowing for detailed asset management (Inventory), and focusing on actionable items (Treatment Board). The main interactions involve filtering the central data table from KPI cards and charts, managing orders through modals, and using a drag-and-drop Kanban board for workflow. This task-oriented design was chosen because it aligns perfectly with the typical workflow of a rental manager, prioritizing clarity, efficiency, and quick access to critical information. -->
    <!-- Visualization & Content Choices: 
        - Dashboard KPIs: Goal: Inform. Method: Styled HTML cards. Interaction: Click to filter main table. Justification: Provides a quick, scannable summary of key business metrics.
        - Containers by Customer Chart: Goal: Compare. Method: Horizontal Bar Chart (Chart.js on Canvas). Interaction: Click a bar to filter the table by that customer. Justification: Best for comparing quantities across categories with potentially long labels (customer names).
        - Order Status Chart: Goal: Show Proportions. Method: Doughnut Chart (Chart.js on Canvas). Interaction: Click a slice to filter the table by status. Justification: Modern and clear way to visualize the distribution of a whole.
        - Main Orders Table: Goal: Organize/Inform. Method: Interactive HTML Table. Interaction: Sort, search, filter, click row for details modal. Justification: Standard and effective method for displaying detailed tabular data.
        - Treatment Board: Goal: Organize/Manage Workflow. Method: HTML/CSS Kanban Board. Interaction: Drag-and-drop cards to update status. Justification: Highly intuitive and visual method for managing tasks and their lifecycle.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ×”×’×“×¨×•×ª ××©×ª× ×™× ×¢×‘×•×¨ ×¤×œ×˜×ª ×”×¦×‘×¢×™× ×•×”×¤×•× ×˜×™× */
        :root {
            --color-background: #F4F7F6; /* ×‘×”×™×¨, ×¨×š ×•× ×¢×™× */
            --color-surface: #FFFFFF;
            --color-primary: #3C6E71; /* ×›×—×•×œ-×˜×•×¨×§×™×– ×¢××•×§ */
            --color-primary-light: #61A6AB;
            --color-secondary: #C8D6DB; /* ××¤×•×¨-×›×—×•×œ ×‘×”×™×¨ */
            --color-accent: #FFC0CB; /* ×•×¨×•×“ ×¢×“×™×Ÿ ×›×¦×‘×¢ ×”×“×’×©×” */
            --color-text-base: #2D3A3A;
            --color-text-muted: #6B7280;
            --color-border: #E0E7E9;
            --color-danger: #D64545; /* ××“×•× ×—×–×§ ×™×•×ª×¨ */
            --color-warning: #FFD700; /* ×–×”×‘/×¦×”×•×‘ ×—× */
            --color-success: #5CB85C;
            --color-info: #5BC0DE;

            --font-main: 'Rubik', sans-serif;
        }

        /* ××¦×‘ ×›×”×” - Dark Mode */
        body.dark {
            --color-background: #1C2A3A;
            --color-surface: #2E3C4A;
            --color-primary: #61A6AB;
            --color-primary-light: #89C7CC;
            --color-secondary: #4A5B6B;
            --color-accent: #FFB6C1;
            --color-text-base: #E0E7EB;
            --color-text-muted: #AAB7C3;
            --color-border: #3A4E5E;
            --color-danger: #E57373;
            --color-warning: #FFEB3B;
            --color-success: #8BC34A;
            --color-info: #81D4FA;
        }

        /* ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª ×œ×’×•×£ ×”×“×£ ×•×”×¤×•× ×˜×™× */
        body {
            font-family: var(--font-main);
            background-color: var(--color-background);
            color: var(--color-text-base);
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out;
            line-height: 1.6;
        }

        /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™× */
        .btn {
            padding: 0.85rem 1.8rem;
            border-radius: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            border: 1px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* ×¦×œ ×¢×“×™×Ÿ ×œ×›×œ ×”×›×¤×ª×•×¨×™× */
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            background-image: linear-gradient(to right, var(--color-primary), var(--color-primary-light));
            box-shadow: 0 6px 20px -5px rgba(60, 110, 113, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px -8px rgba(60, 110, 113, 0.6);
            background-image: linear-gradient(to left, var(--color-primary), var(--color-primary-light));
        }

        .btn-secondary {
            background-color: var(--color-surface);
            color: var(--color-text-base);
            border-color: var(--color-border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        }
        body.dark .btn-secondary {
             color: var(--color-text-base);
        }
        .btn-secondary:hover {
            background-color: var(--color-background);
            border-color: var(--color-primary-light);
            color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.06);
        }
        
        /* ×¢×™×¦×•×‘ ×›×¨×˜×™×¡×™× (Cards) */
        .card {
            background-color: var(--color-surface);
            border-radius: 1.25rem; /* ×¤×™× ×•×ª ×¢×’×•×œ×•×ª ×™×•×ª×¨ */
            border: 1px solid var(--color-border);
            box-shadow: 0 6px 20px rgba(0,0,0,0.06); /* ×¦×œ ×¢×“×™×Ÿ ×™×•×ª×¨ */
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }

        /* ×›×¤×ª×•×¨×™ × ×™×•×•×˜ (Tabs) */
        .nav-tab-btn {
            font-size: 1.05rem;
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: var(--color-text-muted);
            transition: all 0.3s ease;
        }
        .nav-tab-btn.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 5px 15px rgba(60, 110, 113, 0.3);
            font-weight: 600;
            transform: translateY(-2px);
        }
        .nav-tab-btn:hover:not(.active) {
            color: var(--color-primary);
            background-color: var(--color-border);
        }
        
        /* ××•×“×œ×™× (Modals) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.6); /* ×¨×§×¢ ×›×”×” ×™×•×ª×¨ */
            backdrop-filter: blur(8px); /* ×˜×©×˜×•×© ×—×–×§ ×™×•×ª×¨ */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--color-surface);
            border-radius: 1.5rem; /* ×¤×™× ×•×ª ×¢×’×•×œ×•×ª ×™×•×ª×¨ */
            box-shadow: 0 15px 45px rgba(0,0,0,0.25);
            border: 1px solid var(--color-border);
            transform: scale(0.9);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* ×§×œ×˜×™ ×˜×§×¡×˜ ×•×‘×—×™×¨×” (Inputs, Selects, Textareas) */
        input, select, textarea {
            background-color: var(--color-background);
            border-color: var(--color-border);
            border-radius: 0.8rem;
            transition: all 0.25s ease;
            padding: 0.75rem 1rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(60, 110, 113, 0.25);
            background-color: var(--color-surface);
        }
        
        /* ×˜×‘×œ××•×ª (Tables) */
        th {
            background-color: var(--color-background);
            font-weight: 600;
            padding: 1rem;
            text-align: right; /* ×™×™×©×•×¨ ×œ×™××™×Ÿ ×¢×‘×•×¨ ×¢×‘×¨×™×ª */
        }
        td {
            padding: 0.9rem;
        }
        
        tr:hover:not(.no-hover) {
            background-color: var(--color-border); /* ×©×™× ×•×™ ×¨×§×¢ ×‘×•×œ×˜ ×™×•×ª×¨ ×‘××¢×‘×¨ ×¢×›×‘×¨ */
        }
        body.dark tr:hover:not(.no-hover) {
            background-color: var(--color-surface);
        }
        
        /* ×¡×˜×˜×•×¡×™× ×‘×˜×‘×œ×” */
        .status-open { color: var(--color-success); font-weight: 700; }
        .status-closed { color: var(--color-text-muted); }
        .status-overdue { color: var(--color-danger); font-weight: 700; }
        .status-pending { color: var(--color-info); font-weight: 700; }
        .status-warning { color: var(--color-warning); font-weight: 700; }
        
        /* ×¢×™×¦×•×‘ ×¡×¤×¦×™×¤×™ ×œ×¡×•×’×™ ×¤×¢×•×œ×” */
        .action-type-×”×•×¨×“×” { background-color: rgba(92, 184, 92, 0.1); } /* Light green */
        body.dark .action-type-×”×•×¨×“×” { background-color: rgba(139, 195, 74, 0.1); }
        .action-type-×”×—×œ×¤×” { background-color: rgba(255, 215, 0, 0.1); } /* Light yellow/gold */
        body.dark .action-type-×”×—×œ×¤×” { background-color: rgba(255, 235, 59, 0.1); }
        .action-type-×”×¢×œ××” { background-color: rgba(214, 69, 69, 0.1); } /* Light red */
        body.dark .action-type-×”×¢×œ××” { background-color: rgba(229, 115, 115, 0.1); }

        /* ××¤×§×˜ ×”×‘×”×•×‘ ×œ×”×–×× ×•×ª ×—×•×¨×’×•×ª */
        .overdue-blinking {
            animation: pulse-border 1.8s infinite alternate;
        }

        @keyframes pulse-border {
            from { box-shadow: 0 0 0 0 rgba(214, 69, 69, 0.4); }
            to { box-shadow: 0 0 0 6px rgba(214, 69, 69, 0.0); }
        }

        /* ×§×•× ×˜×™×™× ×¨ ×œ×ª×¨×©×™××™× */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }

        /* ×›×¤×ª×•×¨×™ ××™×™×§×•× ×™× ×œ×¤×¢×•×œ×•×ª */
        .action-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.4rem; /* ××™×™×§×•× ×™× ×’×“×•×œ×™× ×™×•×ª×¨ */
            padding: 0.4rem;
            margin: 0 0.2rem;
            transition: transform 0.25s ease-in-out, color 0.25s ease-in-out;
            border-radius: 50%; /* ×›×¤×ª×•×¨×™× ×¢×’×•×œ×™× */
        }
        .action-icon-btn:hover {
            transform: scale(1.3); /* ×”×’×“×œ×” ×‘×•×œ×˜×ª ×™×•×ª×¨ */
            background-color: rgba(0,0,0,0.05);
        }
        body.dark .action-icon-btn:hover {
            background-color: rgba(255,255,255,0.08);
        }
        
        /* ××¤×§×˜ ×”×§×œ×“×” ×œ×ª×™×‘×ª ×”×•×“×¢×” */
        .typing-effect::after {
            content: '|';
            animation: blink-caret 0.75s step-end infinite;
        }
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--color-primary); }
        }

        /* ×›×¤×ª×•×¨ ×’×œ×™×œ×” ×œ××¢×œ×” */
        #scroll-to-top-btn {
            display: none; /* Hidden by default */
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--color-primary);
            color: white;
            cursor: pointer;
            padding: 18px; /* ×›×¤×ª×•×¨ ×’×“×•×œ ×™×•×ª×¨ */
            border-radius: 50%;
            font-size: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            transition: background-color 0.3s, opacity 0.3s, transform 0.3s;
        }

        #scroll-to-top-btn:hover {
            background-color: var(--color-primary-light);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* ×˜×¢×™× ×” (Loader) */
        #loader-overlay {
            transition: opacity 0.3s ease;
        }
        #loader-overlay > div {
            border-top-color: var(--color-primary);
        }
    </style>
</head>
<body class="text-base">

    <!-- ×©×›×‘×ª ×˜×¢×™× ×” (Loader Overlay) -->
    <div id="loader-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-[1000] opacity-0 pointer-events-none">
        <div class="w-20 h-20 border-6 border-t-6 border-gray-200 border-t-[var(--color-primary)] rounded-full animate-spin"></div>
    </div>

    <!-- ×§×•× ×˜×™×™× ×¨ ×œ×”×•×“×¢×•×ª ×”×ª×¨××” (Alerts) -->
    <div id="alert-container" class="fixed bottom-6 left-6 z-[1100] space-y-4"></div>

    <!-- ××•×“×œ ×”×•×¡×¤×”/×¢×¨×™×›×ª ×”×–×× ×” (Order Modal) -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-[var(--color-primary)]">×”×•×¡×£ ×”×–×× ×” ×—×“×©×”</h2>
                <button onclick="closeModal('order-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <form id="order-form" class="space-y-5 overflow-y-auto">
                 <div>
                    <label for="×ª××¨×™×š ×”×–×× ×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×ª××¨×™×š ×”×–×× ×”</label>
                    <input type="date" id="×ª××¨×™×š ×”×–×× ×”" name="×ª××¨×™×š ×”×–×× ×”" class="w-full p-2 border" required>
                </div>
                <div>
                    <label for="×ª×¢×•×“×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×ª×¢×•×“×”</label>
                    <input type="text" id="×ª×¢×•×“×”" name="×ª×¢×•×“×”" class="w-full p-2 border" required>
                </div>
                <div>
                    <label for="×©× ×¡×•×›×Ÿ" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×©× ×¡×•×›×Ÿ</label>
                    <input type="text" id="×©× ×¡×•×›×Ÿ" name="×©× ×¡×•×›×Ÿ" class="w-full p-2 border" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="×©× ×œ×§×•×—" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×©× ×œ×§×•×—</label>
                        <input type="text" id="×©× ×œ×§×•×—" name="×©× ×œ×§×•×—" class="w-full p-2 border" required onblur="checkCustomerExistenceAndAutofill()">
                    </div>
                    <div>
                        <label for="×›×ª×•×‘×ª" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×›×ª×•×‘×ª</label>
                        <input type="text" id="×›×ª×•×‘×ª" name="×›×ª×•×‘×ª" class="w-full p-2 border" required onblur="checkCustomerExistenceAndAutofill()">
                    </div>
                </div>
                <div>
                    <label for="×˜×œ×¤×•×Ÿ ×œ×§×•×—" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×˜×œ×¤×•×Ÿ ×œ×§×•×—</label>
                    <input type="tel" id="×˜×œ×¤×•×Ÿ ×œ×§×•×—" name="×˜×œ×¤×•×Ÿ ×œ×§×•×—" class="w-full p-2 border" onblur="checkCustomerExistenceAndAutofill()">
                </div>
                <div>
                    <label for="×¡×•×’ ×¤×¢×•×œ×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×¡×•×’ ×¤×¢×•×œ×”</label>
                    <select id="×¡×•×’ ×¤×¢×•×œ×”" name="×¡×•×’ ×¤×¢×•×œ×”" class="w-full p-2 border" required onchange="handleActionTypeChange()">
                        <option value="×”×•×¨×“×”">×”×•×¨×“×”</option>
                        <option value="×”×¢×œ××”">×”×¢×œ××”</option>
                        <option value="×”×—×œ×¤×”">×”×—×œ×¤×”</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="container-taken-div">
                        <label for="××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”</label>
                        <input type="text" id="××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”" name="××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”" class="w-full p-2 border">
                    </div>
                    <div id="container-brought-div" class="hidden">
                        <label for="××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”</label>
                        <input type="text" id="××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”" name="××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”" class="w-full p-2 border">
                    </div>
                </div>
                <div>
                    <label for="×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™</label>
                    <input type="date" id="×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™" name="×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™" class="w-full p-2 border">
                </div>
                <div>
                    <label for="×”×¢×¨×•×ª" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×”×¢×¨×•×ª</label>
                    <textarea id="×”×¢×¨×•×ª" name="×”×¢×¨×•×ª" rows="3" class="w-full p-2 border"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-[var(--color-border)]">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('order-modal')">×‘×™×˜×•×œ</button>
                    <button type="submit" class="btn btn-primary">×©××•×¨ ×”×–×× ×”</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ××•×“×œ ××™×©×•×¨ ××—×™×§×” (Delete Confirmation Modal) -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">××™×©×•×¨ ××—×™×§×”</h2>
            <p class="mb-6 text-[var(--color-text-muted)]">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×–×× ×” ××¡×¤×¨ <span id="delete-order-id" class="font-bold"></span>? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.</p>
            <div class="flex justify-end gap-3">
                <button type="button" class="btn btn-secondary" onclick="closeModal('delete-confirm-modal')">×‘×™×˜×•×œ</button>
                <button type="button" class="btn bg-[var(--color-danger)] text-white" id="confirm-delete-btn">××—×§</button>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ××™×©×•×¨ ×”×©×œ××” ××•×˜×•××˜×™×ª (Autofill Confirmation Modal) -->
    <div id="autofill-confirm-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-6">
            <h2 id="autofill-customer-name-display" class="text-xl font-bold mb-4 text-[var(--color-primary)]"></h2>
            <p id="autofill-message" class="mb-6 text-[var(--color-text-muted)]"></p>
            <div class="flex justify-center gap-4">
                <button type="button" class="btn btn-primary" onclick="confirmAutofill(true)">×›×Ÿ âœ…</button>
                <button type="button" class="btn btn-secondary" onclick="confirmAutofill(false)">×œ× âŒ</button>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ×¤×¨×˜×™ ×”×–×× ×” (Order Details Modal) -->
    <div id="order-details-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-primary)]">×¤×¨×˜×™ ×”×–×× ×” <span id="details-order-id"></span></h2>
                <button onclick="closeModal('order-details-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <div id="order-details-content" class="space-y-3 overflow-y-auto text-[var(--color-text-base)] text-lg">
                <!-- Details will be populated here -->
            </div>
            <div class="flex justify-end gap-3 p-5 border-t border-[var(--color-border)] mt-4">
                <button type="button" class="btn btn-secondary" onclick="editOrderFromDetails()">×¢×¨×•×š ğŸ“</button>
                <button type="button" class="btn bg-[var(--color-danger)] text-white" onclick="deleteOrderFromDetails()">××—×§ ğŸ—‘ï¸</button>
                <button type="button" class="btn btn-primary" onclick="duplicateOrderFromDetails()">×©×›×¤×œ ğŸ“‹</button>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ×”×™×¡×˜×•×¨×™×™×ª ××›×•×œ×” (Container History Modal) -->
    <div id="container-history-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-3xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-primary)]">×”×™×¡×˜×•×¨×™×™×ª ××›×•×œ×”: <span id="history-container-number"></span></h2>
                <button onclick="closeModal('container-history-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <table class="w-full text-right">
                    <thead>
                        <tr>
                            <th class="p-3">×ª×¢×•×“×”</th>
                            <th class="p-3">×©× ×œ×§×•×—</th>
                            <th class="p-3">×›×ª×•×‘×ª</th>
                            <th class="p-3">×¡×•×’ ×¤×¢×•×œ×”</th>
                            <th class="p-3">×ª××¨×™×š ×”×ª×—×œ×”</th>
                            <th class="p-3">×ª××¨×™×š ×¡×™×•× (×¦×¤×•×™/×‘×¤×•×¢×œ)</th>
                            <th class="p-3">××©×š ×©×”×™×™×” (×™××™×)</th>
                        </tr>
                    </thead>
                    <tbody id="container-history-table-body">
                        <!-- History will be populated here -->
                    </tbody>
                </table>
                <div id="no-container-history" class="text-center text-gray-500 mt-6 hidden text-lg">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×–××™× ×” ×œ××›×•×œ×” ×–×•.</div>
            </div>
        </div>
    </div>
    
    <!-- ××‘× ×” ×”×¢××•×“ ×”×¨××©×™ (Main Page Structure) -->
    <div class="min-h-screen flex flex-col">
        <header class="p-6 text-center border-b border-[var(--color-border)] bg-white shadow-sm relative">
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-2">
                <!-- ×œ×•×’×• ×”×—×‘×¨×” -->
                <img src="https://placehold.co/150x50/3C6E71/FFFFFF?text=YOUR+LOGO" alt="Company Logo" class="h-16 rounded-lg shadow-md border border-[var(--color-border)]">
                <h1 class="text-3xl md:text-4xl font-bold text-[var(--color-primary)] mt-2 md:mt-0">××¢×¨×›×ª CRM ××ª×§×“××ª ×œ× ×™×”×•×œ ×©×›×™×¨×•×ª ××›×•×œ×•×ª</h1>
            </div>
            <p class="text-lg text-[var(--color-text-muted)] mb-4">× ×™×”×•×œ ×§×œ ×•×™×¢×™×œ ×©×œ ×›×œ ×”×–×× ×•×ª ×”××›×•×œ×•×ª</p>
            <!-- ×›×¤×ª×•×¨ ××¢×‘×¨ ×‘×™×Ÿ ××¦×‘×™ ×ª×¦×•×’×” (Light/Dark Mode) -->
            <button id="theme-toggle" class="absolute top-5 left-5 text-2xl p-3 rounded-full hover:bg-[var(--color-border)] transition-colors duration-300">
                <i class="fas fa-sun"></i>
            </button>
        </header>

        <!-- ×¡×¨×’×œ × ×™×•×•×˜ ×¨××©×™ (Navigation Tabs) -->
        <div class="flex justify-center p-4">
            <nav class="card flex gap-3 p-3 shadow-lg">
                <button id="nav-dashboard" class="nav-tab-btn active" onclick="showPage('dashboard')">
                    <i class="fas fa-chart-pie mr-2"></i>×œ×•×— ××—×•×•× ×™×
                </button>
                <button id="nav-container-inventory" class="nav-tab-btn" onclick="showPage('container-inventory')">
                    <i class="fas fa-boxes-stacked mr-2"></i>××œ××™ ××›×•×œ×•×ª
                </button>
                <button id="nav-treatment-board" class="nav-tab-btn" onclick="showPage('treatment-board')">
                    <i class="fas fa-clipboard-list mr-2"></i>×œ×•×— ×˜×™×¤×•×œ
                </button>
                <button id="nav-whatsapp-alerts" class="nav-tab-btn" onclick="showPage('whatsapp-alerts')">
                    <i class="fab fa-whatsapp mr-2"></i>×”×ª×¨××•×ª WhatsApp
                </button>
            </nav>
        </div>

        <!-- ×ª×•×›×Ÿ ×”×¢××•×“×™× ×”×©×•× ×™× (Main Content Area) -->
        <main class="flex-grow p-4 md:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <!-- ×œ×•×— ××—×•×•× ×™× (Dashboard Page) -->
            <section id="dashboard-page" class="page-content space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">×¡×§×™×¨×” ×›×œ×œ×™×ª ğŸ“Š</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">×›××Ÿ × ×™×ª×Ÿ ×œ×¨××•×ª ××ª ×”× ×ª×•× ×™× ×”××¨×›×–×™×™× ×©×œ ×”××¢×¨×›×ª, ×œ× ×”×œ ×”×–×× ×•×ª ×§×™×™××•×ª ×•×œ×™×¦×•×¨ ×—×“×©×•×ª.</p>
                </div>
                <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ××”×™×¨×™× -->
                <div class="flex flex-col md:flex-row justify-center items-center gap-5 flex-wrap">
                    <button class="btn btn-primary" onclick="openOrderModal('add')">
                        <i class="fas fa-plus"></i> ×”×•×¡×£ ×”×–×× ×” ×—×“×©×”
                    </button>
                    <button class="btn bg-[var(--color-danger)] text-white hover:bg-[var(--color-danger)] hover:opacity-90" onclick="filterTable('×—×•×¨×’', null, true); scrollToOrdersTable();">
                        <i class="fas fa-triangle-exclamation"></i> ×”×¦×’ ×”×–×× ×•×ª ×—×•×¨×’×•×ª
                        <span id="overdue-customers-badge" class="ml-2 bg-white text-[var(--color-danger)] px-3 py-1 rounded-full text-sm font-bold shadow-sm">0</span>
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> ×¨×¢× ×Ÿ × ×ª×•× ×™×
                    </button>
                </div>

                <!-- ×›×¨×˜×™×¡×™ KPI (Key Performance Indicators) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable('×¤×ª×•×—', null, true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×–×× ×•×ª ×¤×ª×•×—×•×ª<p id="open-orders-count" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-box-open text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable('×—×•×¨×’', null, true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×–×× ×•×ª ×—×•×¨×’×•×ª<p id="overdue-orders-count" class="text-4xl font-bold text-[var(--color-danger)] mt-2">0</p></div><i class="fas fa-triangle-exclamation text-4xl text-[var(--color-danger)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '××›×•×œ×” ×‘×©×™××•×©', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">××›×•×œ×•×ª ×‘×©×™××•×©<p id="containers-in-use" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-truck-moving text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '×œ×§×•×— ×¤×¢×™×œ', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×œ×§×•×—×•×ª ×¤×¢×™×œ×™×<p id="active-customers-count" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-users text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                </div>

                <!-- ×©×•×¨×” ×—×“×©×” ×œ×›×¤×ª×•×¨×™ ×¡×•×’×™ ×¤×¢×•×œ×” -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '×”×•×¨×“×”', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×•×¨×“×”<p id="action-type-×”×•×¨×“×”-count" class="text-4xl font-bold text-[var(--color-success)] mt-2">0</p></div><i class="fas fa-download text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '×”×—×œ×¤×”', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×—×œ×¤×”<p id="action-type-×”×—×œ×¤×”-count" class="text-4xl font-bold text-[var(--color-warning)] mt-2">0</p></div><i class="fas fa-exchange-alt text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '×”×¢×œ××”', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×¢×œ××”<p id="action-type-×”×¢×œ××”-count" class="text-4xl font-bold text-[var(--color-danger)] mt-2">0</p></div><i class="fas fa-upload text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                </div>
                
                <!-- ×ª×¨×©×™××™× -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">××›×•×œ×•×ª ×‘×©×™××•×© ×œ×¤×™ ×œ×§×•×—</h3>
                        <div class="chart-container">
                            <canvas id="chart-containers-by-customer"></canvas>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">×”×ª×¤×œ×’×•×ª ×”×–×× ×•×ª ×œ×¤×™ ×¡×˜×˜×•×¡</h3>
                        <div class="chart-container">
                            <canvas id="chart-status-pie"></canvas>
                        </div>
                    </div>
                    <!-- ×ª×¨×©×™× ×—×“×© ×œ×¡×•×’ ×¤×¢×•×œ×” -->
                    <div class="card p-6 lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">×”×ª×¤×œ×’×•×ª ×”×–×× ×•×ª ×œ×¤×™ ×¡×•×’ ×¤×¢×•×œ×”</h3>
                        <div class="chart-container">
                            <canvas id="chart-action-type"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ×¨×©×™××ª ×”×–×× ×•×ª ×¨××©×™×ª -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-6 text-[var(--color-text-base)]">×¨×©×™××ª ×”×–×× ×•×ª ğŸ“‹</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
                        <input type="text" id="search-input" placeholder="×—×™×¤×•×© ×—×•×¤×©×™..." class="flex-grow p-3 border text-lg" onkeyup="filterTable()">
                        
                        <!-- ×¤×™×œ×˜×¨×™× ×—×“×©×™× -->
                        <select id="filter-status-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                            <option value="×¤×ª×•×—">×¤×ª×•×—</option>
                            <option value="×—×•×¨×’">×—×•×¨×’</option>
                            <option value="×¡×’×•×¨">×¡×’×•×¨</option>
                        </select>
                        <select id="filter-action-type-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">×›×œ ×¡×•×’×™ ×”×¤×¢×•×œ×•×ª</option>
                            <option value="×”×•×¨×“×”">×”×•×¨×“×”</option>
                            <option value="×”×—×œ×¤×”">×”×—×œ×¤×”</option>
                            <option value="×”×¢×œ××”">×”×¢×œ××”</option>
                        </select>
                        <select id="filter-agent-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">×›×œ ×”×¡×•×›× ×™×</option>
                            <!-- Agents will be populated by JS -->
                        </select>
                        <button class="btn btn-secondary" onclick="resetTableFilters()">
                            <i class="fas fa-filter-circle-xmark mr-2"></i>××™×¤×•×¡ ×¡×™× ×•×Ÿ
                        </button>
                        <div class="flex items-center gap-2">
                            <label for="show-closed-orders" class="text-sm font-medium text-[var(--color-text-muted)]">×”×¦×’ ×¡×’×•×¨×•×ª</label>
                            <input type="checkbox" id="show-closed-orders" onchange="filterTable()" class="w-5 h-5 text-[var(--color-primary)] bg-gray-100 rounded border-gray-300 focus:ring-[var(--color-primary)]">
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-[var(--color-border)]">
                        <table id="orders-table" class="w-full text-right table-auto">
                            <thead class="bg-[var(--color-background)] border-b-2 border-[var(--color-border)] sticky top-0 z-10">
                                <tr>
                                    <th class="p-3">×ª××¨×™×š</th>
                                    <th class="p-3">×ª×¢×•×“×”</th>
                                    <th class="p-3">×œ×§×•×—</th>
                                    <th class="p-3">×›×ª×•×‘×ª</th>
                                    <th class="p-3">×¡×•×’ ×¤×¢×•×œ×”</th>
                                    <th class="p-3">×™××™× ×©×¢×‘×¨×•</th>
                                    <th class="p-3">××›×•×œ×•×ª</th>
                                    <th class="p-3">×¡×˜×˜×•×¡</th>
                                    <th class="p-3">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ××œ××™ ××›×•×œ×•×ª (Container Inventory Page) -->
            <section id="container-inventory-page" class="page-content hidden space-y-10">
                 <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">× ×™×”×•×œ ××œ××™ ××›×•×œ×•×ª ğŸ“¦</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">×¢×§×•×‘ ××—×¨ ×”××™×§×•× ×•×”×–××™× ×•×ª ×©×œ ×›×œ ×”××›×•×œ×•×ª ×‘××¢×¨×›×ª.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-[var(--color-danger)]">××›×•×œ×•×ª ×‘×©×™××•×©</h3>
                        <div class="overflow-x-auto max-h-96 rounded-lg border border-[var(--color-border)]">
                            <table id="containers-in-use-table" class="w-full text-right table-auto">
                                <thead class="bg-[var(--color-background)] sticky top-0 z-10"><tr><th class="p-3">××¡×¤×¨</th><th class="p-3">×œ×§×•×—</th><th class="p-3">×ª××¨×™×š</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-[var(--color-success)]">××›×•×œ×•×ª ×¤× ×•×™×•×ª</h3>
                        <div class="overflow-x-auto max-h-96 rounded-lg border border-[var(--color-border)]">
                            <table id="containers-available-table" class="w-full text-right table-auto">
                                <thead class="bg-[var(--color-background)] sticky top-0 z-10"><tr><th class="p-3">××¡×¤×¨</th><th class="p-3">×ª××¨×™×š ×”×ª×¤× ×•×ª</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ×œ×•×— ×˜×™×¤×•×œ (Treatment Board Page) -->
            <section id="treatment-board-page" class="page-content hidden space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">×œ×•×— ×˜×™×¤×•×œ  Kanban ğŸ› ï¸</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">× ×”×œ ××ª ×”×”×–×× ×•×ª ×”×“×•×¨×©×•×ª ×˜×™×¤×•×œ ×‘×××¦×¢×•×ª ×’×¨×™×¨×” ×•×©×—×¨×•×¨ ×‘×™×Ÿ ×”×¡×˜×˜×•×¡×™× ×”×©×•× ×™×.</p>
                </div>
                <div id="no-treatment-orders" class="text-center text-xl text-[var(--color-text-muted)] hidden p-8 card">××™×Ÿ ×”×–×× ×•×ª ×œ×˜×™×¤×•×œ ×›×¨×’×¢. ×›×œ ×”×›×‘×•×“! ğŸ‰</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div id="column-overdue" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-danger)] mb-4 pb-2 border-b border-[var(--color-border)]">×—×•×¨×’×•×ª ğŸš¨</h3>
                    </div>
                    <div id="column-in-progress" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-info)] mb-4 pb-2 border-b border-[var(--color-border)]">×‘×˜×™×¤×•×œ âš™ï¸</h3>
                    </div>
                    <div id="column-resolved" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-success)] mb-4 pb-2 border-b border-[var(--color-border)]">×˜×•×¤×œ×• âœ…</h3>
                    </div>
                </div>
            </section>

            <!-- ×”×ª×¨××•×ª WhatsApp (WhatsApp Alerts Page) -->
            <section id="whatsapp-alerts-page" class="page-content hidden space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">×œ×•×— ×”×ª×¨××•×ª WhatsApp ğŸ’¬</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">×©×œ×— ×”×•×“×¢×•×ª ××•×‘× ×•×ª ×œ×œ×§×•×—×•×ª ×¢×œ ×—×¨×™×’×•×ª, ×¡×˜×˜×•×¡ ×”×–×× ×•×ª ×•×”×•×“×¢×•×ª ×—×©×•×‘×•×ª × ×•×¡×¤×•×ª.</p>
                </div>

                <div class="card p-8 space-y-5 max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold mb-4 text-[var(--color-primary)]">×©×œ×™×—×ª ×”×•×“×¢×ª WhatsApp</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="whatsapp-customer-name" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×©× ×œ×§×•×—</label>
                            <input type="text" id="whatsapp-customer-name" class="w-full p-2 border" readonly>
                        </div>
                        <div>
                            <label for="whatsapp-phone-number" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
                            <input type="text" id="whatsapp-phone-number" class="w-full p-2 border" readonly>
                        </div>
                        <div class="md:col-span-2"> <!-- ×¢××•×“×” ××—×ª ×œ×›×ª×•×‘×ª -->
                            <label for="whatsapp-address" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×›×ª×•×‘×ª</label>
                            <input type="text" id="whatsapp-address" class="w-full p-2 border" readonly>
                        </div>
                    </div>

                    <div>
                        <label for="message-template-select" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×‘×—×¨ ×ª×‘× ×™×ª ×”×•×“×¢×”</label>
                        <select id="message-template-select" class="w-full p-3 border text-lg" onchange="loadWhatsAppTemplate()">
                            <option value="">×‘×—×¨ ×ª×‘× ×™×ª...</option>
                            <!-- Templates will be populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label for="whatsapp-message-input" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×”×•×“×¢×”</label>
                        <textarea id="whatsapp-message-input" rows="8" class="w-full p-3 border text-lg typing-effect"></textarea>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button class="btn btn-secondary" onclick="clearWhatsAppMessage()">× ×§×”</button>
                        <button class="btn btn-primary" onclick="sendWhatsAppMessage()">×©×œ×— ×”×•×“×¢×”</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ×›×¤×ª×•×¨ ×’×œ×™×œ×” ×œ××¢×œ×” ×¦×£ (Floating Scroll to Top Button) -->
    <button onclick="scrollToTop()" id="scroll-to-top-btn" title="×—×–×•×¨ ×œ××¢×œ×”">
        <i class="fas fa-arrow-up"></i>
    </button>

<script>
    // URL ×©×œ ×”-Google Apps Script ×”××©××© ×›-API
    const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec';
    // URL ×©×œ ×¡×§×¨×™×¤×˜ ×”-Apps Script × ×¤×¨×“ ×œ×œ×•×’×™× ×’ ×©×œ ×”×•×“×¢×•×ª ×•×•××˜×¡××¤.
    // **×—×©×•×‘**: ×™×© ×œ×”×—×œ×™×£ ××ª 'AKfycbx_YOUR_WHATSAPP_SCRIPT_ID_HERE' ×‘-ID ×”×××™×ª×™ ×©×œ ×”×¡×§×¨×™×¤×˜ ×©×œ×š.
    const WHATSAPP_LOG_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_YOUR_WHATSAPP_SCRIPT_ID_HERE/exec'; 
    
    let allOrders = []; // ××¢×¨×š ×”××›×™×œ ××ª ×›×œ ×”×”×–×× ×•×ª ×©× ×˜×¢× ×•
    let currentEditingOrder = null; // ××©×ª× ×” ×œ×©××™×¨×ª ×”×”×–×× ×” ×”× ×¢×¨×›×ª ×›×¨×’×¢
    let autoFillData = null; // × ×ª×•× ×™× ×¢×‘×•×¨ ×”×©×œ××” ××•×˜×•××˜×™×ª ×©×œ ×œ×§×•×—×•×ª
    let charts = {}; // ××•×‘×™×™×§×˜ ×œ××—×¡×•×Ÿ ××•×¤×¢×™ ×ª×¨×©×™××™× (Chart.js)
    const OVERDUE_THRESHOLD_DAYS = 10; // ×¡×£ ×™××™× ×œ××—×¨ ×ª××¨×™×š ×”×”×–×× ×” ×œ×”×’×“×¨×ª ×¡×˜×˜×•×¡ '×—×•×¨×’'

    // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×¤×ª×™×—×” ×•×¡×’×™×¨×ª ××•×“×œ×™×
    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // ×¤×•× ×§×¦×™×•×ª ×œ×”×¦×’×” ×•×”×¡×ª×¨×” ×©×œ ×× ×™××¦×™×™×ª ×”×˜×¢×™× ×”
    function showLoader() { document.getElementById('loader-overlay').classList.remove('opacity-0', 'pointer-events-none'); }
    function hideLoader() { document.getElementById('loader-overlay').classList.add('opacity-0', 'pointer-events-none'); }

    // ×¤×•× ×§×¦×™×” ×œ××¢×‘×¨ ×‘×™×Ÿ ××¦×‘ ×‘×”×™×¨ ×œ×›×”×”
    function toggleTheme() {
        const isDarkMode = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light'); // ×©××•×¨ ×”×¢×“×¤×” ×‘-localStorage
        document.querySelector('#theme-toggle i').className = isDarkMode ? 'fas fa-moon' : 'fas fa-sun'; // ×©× ×” ××™×™×§×•×Ÿ
    }

    // ×¤×•× ×§×¦×™×” ×œ××ª×—×•×œ ××¦×‘ ×”×ª×¦×•×’×” (×›×”×”/×‘×”×™×¨) ×‘×˜×¢×™× ×ª ×”×“×£
    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; // ×‘×“×™×§×” ×× ×”××¢×¨×›×ª ××¢×“×™×¤×” ××¦×‘ ×›×”×”
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.body.classList.add('dark');
            document.querySelector('#theme-toggle i').className = 'fas fa-moon';
        }
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×•×ª ×”×ª×¨××” (alerts) ×œ××©×ª××©
    function showAlert(message, type = 'info') {
        const container = document.getElementById('alert-container');
        const alertItem = document.createElement('div');
        let bgColor, icon, textColor, borderColor; // ×”×•×¡×¤×ª ×¦×‘×¢×™ ×˜×§×¡×˜ ×•×’×‘×•×œ×•×ª
        switch(type) {
            case 'success': bgColor = 'bg-green-50'; borderColor = 'border-green-500'; textColor = 'text-green-700'; icon = 'fa-check-circle'; break;
            case 'error': bgColor = 'bg-red-50'; borderColor = 'border-red-500'; textColor = 'text-red-700'; icon = 'fa-times-circle'; break;
            case 'warning': bgColor = 'bg-yellow-50'; borderColor = 'border-yellow-500'; textColor = 'text-yellow-700'; icon = 'fa-exclamation-triangle'; break;
            default: bgColor = 'bg-blue-50'; borderColor = 'border-blue-500'; textColor = 'text-blue-700'; icon = 'fa-info-circle'; break;
        }
        alertItem.className = `p-4 rounded-lg border-l-4 shadow-md flex items-center gap-3 transform translate-x-full opacity-0 transition-all duration-500 ease-out ${bgColor} ${borderColor} ${textColor}`;
        alertItem.innerHTML = `<i class="fas ${icon}"></i><p>${message}</p>`;
        container.prepend(alertItem); // ×”×•×¡×¤×” ×œ×”×ª×—×œ×” ×›×“×™ ×©×”×”×•×“×¢×•×ª ×”×—×“×©×•×ª ×™×•×¤×™×¢×• ×œ××¢×œ×”
        
        // ×× ×™××¦×™×™×ª ×›× ×™×¡×”
        setTimeout(() => {
            alertItem.style.transform = 'translateX(0)';
            alertItem.style.opacity = '1';
        }, 100);

        // ×× ×™××¦×™×™×ª ×™×¦×™××” ×•×”×¡×¨×”
        setTimeout(() => {
            alertItem.style.transform = 'translateX(100%)';
            alertItem.style.opacity = '0';
            setTimeout(() => alertItem.remove(), 500); // ×”×¡×¨×” ×œ××—×¨ ×¡×™×•× ×”×× ×™××¦×™×”
        }, 5000);
    }

    // ×¤×•× ×§×¦×™×” ×œ×©×œ×™×¤×ª × ×ª×•× ×™× ××”×©×¨×ª (Google Apps Script)
    async function fetchData(action, params = {}, retries = 0) {
        showLoader();
        const urlParams = new URLSearchParams({ action, ...params });
        const url = `${SCRIPT_WEB_APP_URL}?${urlParams.toString()}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª "Service invoked too many times" ×‘×××¦×¢×•×ª exponential backoff
            if (!data.success && data.message && data.message.includes('Service invoked too many times')) {
                const delay = Math.pow(2, retries) * 1000;
                if (retries < 5) { // ××§×¡×™××•× 5 × ×™×¡×™×•× ×•×ª ×—×•×–×¨×™×
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchData(action, params, retries + 1);
                } else {
                    showAlert('×”×©×¨×ª ×¢××•×¡, ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 'error');
                }
            }
            return data;
        } catch (error) {
            showAlert('×©×’×™××ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª.', 'error');
            console.error("Fetch error:", error);
            return { success: false, message: error.message };
        } finally {
            hideLoader();
        }
    }

    // ×¤×•× ×§×¦×™×” ×œ×ª×™×¢×•×“ ×”×•×“×¢×•×ª WhatsApp ×‘×’×™×œ×™×•×Ÿ × ×¤×¨×“
    async function logWhatsAppMessage(docId, message) {
        // ×¤×•× ×§×¦×™×” ×–×• ×©×•×œ×—×ª × ×ª×•× ×™× ×œ×’×™×œ×™×•×Ÿ ×œ×•×’ ×©×œ WhatsApp
        // ×™×© ×œ×•×•×“× ×©×¡×§×¨×™×¤×˜ ×”-Google Apps Script ×¤×•×¨×¡× ×›-web app
        // ×•×©×”×•× ××§×‘×œ ××ª ×”×¤×¨××˜×¨×™× 'docId' ×•-'message' ×•××•×¡×™×£ ××•×ª× ×œ×’×™×œ×™×•×Ÿ "×™×•××Ÿ WhatsApp".
        const url = `${WHATSAPP_LOG_SCRIPT_URL}?action=logMessage&docId=${encodeURIComponent(docId)}&message=${encodeURIComponent(message)}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.success) {
                console.log("WhatsApp message logged successfully.");
            } else {
                console.error("Failed to log WhatsApp message:", data.message);
            }
        } catch (error) {
            console.error("Error logging WhatsApp message:", error);
        }
    }

    // ×˜×¢×™× ×ª ×”×”×–×× ×•×ª ××”×©×¨×ª ×•×¢×™×‘×•×“×Ÿ
    async function loadOrders() {
        const response = await fetchData('list', { status: 'all' });
        if (response.success) {
            allOrders = response.data.map(order => {
                const orderDate = new Date(order['×ª××¨×™×š ×”×–×× ×”']);
                const today = new Date();
                const daysPassed = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                order._daysPassedCalculated = daysPassed; // ×—×™×©×•×‘ ×•×©××™×¨×” ×©×œ ×™××™× ×©×¢×‘×¨×•

                // ×§×‘×™×¢×ª ×¡×˜×˜×•×¡ ××¤×§×˜×™×‘×™ ×œ×ª×¦×•×’×” ×•×œ×œ×•×’×™×§×”
                if (order['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    order._effectiveStatus = '×¡×’×•×¨';
                } else if (daysPassed >= OVERDUE_THRESHOLD_DAYS) { // ×× ×¢×‘×¨×• 10 ×™××™× ××• ×™×•×ª×¨, ×”×”×–×× ×” ×—×•×¨×’×ª
                    order._effectiveStatus = '×—×•×¨×’';
                } else {
                    order._effectiveStatus = '×¤×ª×•×—'; // ×¡×˜×˜×•×¡ ×‘×¨×™×¨×ª ××—×“×œ ×œ×”×–×× ×•×ª ×©××™× ×Ÿ ×¡×’×•×¨×•×ª ×•××™× ×Ÿ ×—×•×¨×’×•×ª
                }
                order.sheetRow = parseInt(order.sheetRow); // ×•×•×“× ×©-sheetRow ×”×•× ××¡×¤×¨
                return order;
            });
            updateDashboard(); // ×¢×“×›×•×Ÿ ×œ×•×— ×”××—×•×•× ×™×
            filterTable(); // ×¡×™× ×•×Ÿ ×•×¨×™× ×“×•×¨ ×”×˜×‘×œ×”
            updateContainerInventory(); // ×¢×“×›×•×Ÿ ××œ××™ ×”××›×•×œ×•×ª
            renderTreatmentBoard(); // ×¨×™× ×“×•×¨ ×œ×•×— ×”×˜×™×¤×•×œ
            populateAgentFilter(); // ××›×œ×•×¡ ×¤×™×œ×˜×¨ ×”×¡×•×›× ×™×
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×–×× ×•×ª.', 'error');
        }
    }

    // ×¢×“×›×•×Ÿ ×›×¨×˜×™×¡×™ KPI ×•×”×ª×¨×©×™××™× ×‘×œ×•×— ×”××—×•×•× ×™×
    function updateDashboard() {
        const openOrders = allOrders.filter(o => o._effectiveStatus === '×¤×ª×•×—');
        const overdueOrders = allOrders.filter(o => o._effectiveStatus === '×—×•×¨×’');
        
        const containersInUse = new Set();
        allOrders.filter(o => o._effectiveStatus !== '×¡×’×•×¨').forEach(order => { // ×¨×§ ×”×–×× ×•×ª ×¤×ª×•×—×•×ª ××• ×—×•×¨×’×•×ª
            String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean).forEach(c => containersInUse.add(c));
            // ×× ×¡×•×’ ×”×¤×¢×•×œ×” ×”×•× ×”×¢×œ××”, ×”××›×•×œ×” ×©×¢×œ×ª×” ××™× ×” × ×—×©×‘×ª ×‘×©×™××•×©
            String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean).forEach(c => containersInUse.delete(c));
        });
        
        // ×œ×§×•×—×•×ª ×¤×¢×™×œ×™× ×”× ××œ×• ×¢× ×”×–×× ×•×ª ×¤×ª×•×—×•×ª ××• ×—×•×¨×’×•×ª
        const activeCustomers = new Set(allOrders.filter(o => o._effectiveStatus !== '×¡×’×•×¨').map(o => o['×©× ×œ×§×•×—']).filter(Boolean));

        document.getElementById('open-orders-count').textContent = openOrders.length;
        document.getElementById('overdue-orders-count').textContent = overdueOrders.length;
        document.getElementById('containers-in-use').textContent = containersInUse.size;
        document.getElementById('active-customers-count').textContent = activeCustomers.size;
        document.getElementById('overdue-customers-badge').textContent = overdueOrders.length;
        
        // ×¢×“×›×•×Ÿ ×¡×¤×™×¨×ª ×¡×•×’×™ ×¤×¢×•×œ×”
        const actionTypeCounts = allOrders.reduce((acc, order) => {
            const type = order['×¡×•×’ ×¤×¢×•×œ×”'];
            if (type) {
                acc[type] = (acc[type] || 0) + 1;
            }
            return acc;
        }, {});

        document.getElementById('action-type-×”×•×¨×“×”-count').textContent = actionTypeCounts['×”×•×¨×“×”'] || 0;
        document.getElementById('action-type-×”×—×œ×¤×”-count').textContent = actionTypeCounts['×”×—×œ×¤×”'] || 0;
        document.getElementById('action-type-×”×¢×œ××”-count').textContent = actionTypeCounts['×”×¢×œ××”'] || 0;

        drawCharts(); // ×¨×™× ×“×•×¨ ×”×ª×¨×©×™××™×
    }

    // ×¨×™× ×“×•×¨ ×˜×‘×œ×ª ×”×”×–×× ×•×ª
    function renderOrdersTable(ordersToRender) {
        const tableBody = document.querySelector('#orders-table tbody');
        tableBody.innerHTML = '';
        if (ordersToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-[var(--color-text-muted)]">××™×Ÿ ×”×–×× ×•×ª ×œ×”×¦×’×” ×‘×¡×™× ×•×Ÿ ×”× ×•×›×—×™.</td></tr>`;
            return;
        }

        ordersToRender.forEach(order => {
            const row = tableBody.insertRow();
            // ×”×—×œ×ª ×¢×™×¦×•×‘ ××•×ª× ×” ×œ×¤×™ ×¡×•×’ ×¤×¢×•×œ×”
            const actionTypeClass = order['×¡×•×’ ×¤×¢×•×œ×”'] ? `action-type-${order['×¡×•×’ ×¤×¢×•×œ×”']}` : '';
            row.className = `border-b border-[var(--color-border)] transition-colors cursor-pointer ${actionTypeClass}`;
            
            // ×”×—×œ×ª ××¤×§×˜ ×”×‘×”×•×‘ ×œ×”×–×× ×•×ª ×—×•×¨×’×•×ª
            if (order._effectiveStatus === '×—×•×¨×’') {
                row.classList.add('overdue-blinking');
            }

            row.dataset.sheetRow = order.sheetRow;
            row.onclick = (e) => {
                // ×× ×›×¤×ª×•×¨ ××• ×ª×’ ××›×•×œ×” × ×œ×—×¥, ×× ×¢ ×”×¦×’×ª ×¤×¨×˜×™ ×”×–×× ×”
                if (!e.target.closest('.action-icon-btn, .container-badge')) { 
                    showOrderDetailsModal(order.sheetRow);
                }
            };

            // ×™×¦×™×¨×ª ×ª×’×™×•×ª ×œ××¡×¤×¨×™ ××›×•×œ×•×ª
            const containersTaken = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const allContainers = new Set([...containersTaken, ...containersBrought]);
            
            const containerHTML = [...allContainers].filter(Boolean).map(c => 
                `<span class="container-badge inline-block bg-[var(--color-secondary)] text-[var(--color-text-base)] text-xs font-semibold px-2.5 py-0.5 rounded-full cursor-pointer hover:bg-[var(--color-primary)] hover:text-white transition-colors" onclick="event.stopPropagation(); showContainerHistory('${c.trim()}')">ğŸ“¦ ${c.trim()}</span>`
            ).join(' ');
            
            row.innerHTML = `
                <td class="p-3 font-medium">${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                <td class="p-3 font-medium">${order['×ª×¢×•×“×”'] || ''}</td>
                <td class="p-3 font-semibold">${order['×©× ×œ×§×•×—'] || ''}</td>
                <td class="p-3 font-medium">${order['×›×ª×•×‘×ª'] || ''}</td>
                <td class="p-3">${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
                <td class="p-3">${order._daysPassedCalculated || ''}</td>
                <td class="p-3">${containerHTML}</td>
                <td class="p-3"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                <td class="p-3 whitespace-nowrap">
                    <button class="action-icon-btn whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppAlertsForOrder(${order.sheetRow})" title="×©×œ×— WhatsApp"><i class="fab fa-whatsapp text-green-500"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})" title="×¢×¨×•×š"><i class="fas fa-edit text-[var(--color-info)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})" title="×©×›×¤×œ"><i class="fas fa-copy text-[var(--color-primary)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['×ª×¢×•×“×”']}')" title="××—×§"><i class="fas fa-trash text-[var(--color-danger)]"></i></button>
                </td>
            `;
        });
    }

    // ×¤×•× ×§×¦×™×” ×œ×¡×™× ×•×Ÿ ×˜×‘×œ×ª ×”×”×–×× ×•×ª
    function filterTable(statusFilterParam = null, actionTypeFilterParam = null, isExplicitButtonFilter = false) {
        const searchText = document.getElementById('search-input').value.toLowerCase();
        const selectedStatusFilter = document.getElementById('filter-status-select').value;
        const selectedActionTypeFilter = document.getElementById('filter-action-type-select').value;
        const selectedAgentFilter = document.getElementById('filter-agent-select').value;
        let showClosed = document.getElementById('show-closed-orders').checked;

        // ×× ×‘×•×¦×¢ ×¡×™× ×•×Ÿ ××¤×•×¨×© ×¢"×™ ×›×¤×ª×•×¨ (×œ××©×œ, "×”×¦×’ ×”×–×× ×•×ª ×—×•×¨×’×•×ª"), ×“×¨×•×¡ ××ª ××¦×‘ ×ª×™×‘×ª ×”×¡×™××•×Ÿ ×•×”×—×™×¤×•×©
        if (isExplicitButtonFilter) {
            if (statusFilterParam === '×—×•×¨×’') {
                showClosed = false;
                document.getElementById('show-closed-orders').checked = false;
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = '×—×•×¨×’';
                document.getElementById('filter-action-type-select').value = 'all';
                document.getElementById('filter-agent-select').value = 'all';
            } else if (actionTypeFilterParam) { // ×¢×‘×•×¨ ×›×¤×ª×•×¨×™ ×¡×•×’×™ ×¤×¢×•×œ×”
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = 'all';
                document.getElementById('filter-action-type-select').value = actionTypeFilterParam;
                document.getElementById('filter-agent-select').value = 'all';
                showClosed = document.getElementById('show-closed-orders').checked; // ×©××•×¨ ××ª ××¦×‘ ×ª×™×‘×ª ×”×¡×™××•×Ÿ ×”×§×™×™×
            }
            // ×× ×–×• ×œ×—×™×¦×” ×¢×œ KPI ×©×œ× ××’×“×™×¨×” ×¡×˜×˜×•×¡/×¡×•×’ ×¤×¢×•×œ×” ×‘××¤×•×¨×©, ××¤×¡ ×¤×™×œ×˜×¨×™× ××—×¨×™×
            else if (statusFilterParam === '×¤×ª×•×—' || actionTypeFilterParam === '××›×•×œ×” ×‘×©×™××•×©' || actionTypeFilterParam === '×œ×§×•×— ×¤×¢×™×œ') {
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = statusFilterParam || 'all';
                document.getElementById('filter-action-type-select').value = 'all';
                document.getElementById('filter-agent-select').value = 'all';
                showClosed = false;
                document.getElementById('show-closed-orders').checked = false;
            }
        }

        const filtered = allOrders.filter(order => {
            // ×—×™×¤×•×© ×—×•×¤×©×™
            const matchesSearch = Object.values(order).some(val => String(val).toLowerCase().includes(searchText));
            
            // ×”×—×œ×ª ×¤×™×œ×˜×¨ ×¡×˜×˜×•×¡ ××”×“×¨×•×¤×“××•×Ÿ ××• ×›×¤×ª×•×¨ ××¤×•×¨×©
            let matchesStatus = true;
            const currentStatusFilter = isExplicitButtonFilter && statusFilterParam ? statusFilterParam : selectedStatusFilter;
            if (currentStatusFilter !== 'all') {
                matchesStatus = (order._effectiveStatus === currentStatusFilter);
            }

            // ×”×—×œ×ª ×¤×™×œ×˜×¨ ×¡×•×’ ×¤×¢×•×œ×” ××”×“×¨×•×¤×“××•×Ÿ ××• ×›×¤×ª×•×¨ ××¤×•×¨×©
            let matchesActionType = true;
            const currentActionTypeFilter = isExplicitButtonFilter && actionTypeFilterParam ? actionTypeFilterParam : selectedActionTypeFilter;
            if (currentActionTypeFilter !== 'all') {
                if (currentActionTypeFilter === '××›×•×œ×” ×‘×©×™××•×©') {
                    // ××›×•×œ×” ×‘×©×™××•×© × ×—×©×‘×ª ×× ×”×™× ×™×¨×“×” ×‘×”×–×× ×” ×¤×ª×•×—×” ××• ×—×•×¨×’×ª
                    matchesActionType = (String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean).length > 0 && order._effectiveStatus !== '×¡×’×•×¨' && order['×¡×•×’ ×¤×¢×•×œ×”'] !== '×”×¢×œ××”');
                } else if (currentActionTypeFilter === '×œ×§×•×— ×¤×¢×™×œ') {
                     // ×œ×§×•×— ×¤×¢×™×œ ×× ×™×© ×œ×• ×”×–×× ×” ×¤×ª×•×—×” ××• ×—×•×¨×’×ª
                     matchesActionType = (order._effectiveStatus !== '×¡×’×•×¨');
                }
                else {
                    matchesActionType = (order['×¡×•×’ ×¤×¢×•×œ×”'] === currentActionTypeFilter);
                }
            }

            // ×”×—×œ×ª ×¤×™×œ×˜×¨ ×¡×•×›×Ÿ ××”×“×¨×•×¤×“××•×Ÿ
            let matchesAgent = true;
            if (selectedAgentFilter !== 'all') {
                matchesAgent = (order['×©× ×¡×•×›×Ÿ'] === selectedAgentFilter);
            }

            // ×”×—×œ×ª "×”×¦×’ ×¡×’×•×¨×•×ª" ××—×¨×•×Ÿ
            let matchesShowClosed = true;
            if (!showClosed) {
                matchesShowClosed = (order._effectiveStatus === '×¤×ª×•×—' || order._effectiveStatus === '×—×•×¨×’');
            }
            
            return matchesSearch && matchesStatus && matchesActionType && matchesAgent && matchesShowClosed;
        });
        renderOrdersTable(filtered);
    }
    
    // ××™×¤×•×¡ ×›×œ ×”×¤×™×œ×˜×¨×™× ×‘×˜×‘×œ×”
    function resetTableFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('filter-status-select').value = 'all';
        document.getElementById('filter-action-type-select').value = 'all';
        document.getElementById('filter-agent-select').value = 'all';
        document.getElementById('show-closed-orders').checked = false;
        filterTable(); // ×”×¤×¢×œ ××—×“×© ××ª ×”×¡×™× ×•×Ÿ ×¢× ×”×¢×¨×›×™× ×”×××•×¤×¡×™×
    }

    // ××›×œ×•×¡ ×¤×™×œ×˜×¨ ×”×¡×•×›× ×™× ×¢× ×¡×•×›× ×™× ×™×™×—×•×“×™×™×
    function populateAgentFilter() {
        const agentSelect = document.getElementById('filter-agent-select');
        agentSelect.innerHTML = '<option value="all">×›×œ ×”×¡×•×›× ×™×</option>';
        const uniqueAgents = [...new Set(allOrders.map(order => order['×©× ×¡×•×›×Ÿ']))].filter(Boolean).sort();
        uniqueAgents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent;
            option.textContent = agent;
            agentSelect.appendChild(option);
        });
    }

    // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×¢×™×¦×•×‘ ×ª××¨×™×š
    function formatDate(dateInput) {
        if (!dateInput) return '';
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return dateInput; // ×× ×”×ª××¨×™×š ×œ× ×ª×§×™×Ÿ, ×”×—×–×¨ ××ª ×”×§×œ×˜ ×”××§×•×¨×™
        return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×©×™××•×© ×‘××›×•×œ×” (×•×•×œ×™×“×¦×™×”)
    function validateContainerUsage(containerNum, currentOrderSheetRow = null) {
        if (!containerNum) return true; // ×× ×œ× ×”×•×–× ×” ××›×•×œ×”, ××™×Ÿ ×§×•× ×¤×œ×™×§×˜

        const isContainerCurrentlyInUse = allOrders.some(order => {
            // ×“×œ×’ ×¢×œ ×”×”×–×× ×” ×”× ×¢×¨×›×ª ×›×¨×’×¢ ×‘×‘×“×™×§×” ×–×•
            if (order.sheetRow === currentOrderSheetRow) {
                return false;
            }
            // ××›×•×œ×” × ×—×©×‘×ª '×‘×©×™××•×©' ×× ×”×™× ×™×¨×“×” ×‘×”×–×× ×” ×¤×ª×•×—×”/×—×•×¨×’×ª ×•×¢×“×™×™×Ÿ ×œ× ×”×•×¢×œ×ª×” ×‘××•×ª×” ×”×–×× ×”
            const containersTakenByOrder = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBroughtByOrder = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

            const isTaken = containersTakenByOrder.includes(containerNum);
            const isBrought = containersBroughtByOrder.includes(containerNum);

            // ××›×•×œ×” ×‘×©×™××•×© ×× ×”×™× ×™×¨×“×” ×•×˜×¨× ×”×•×¢×œ×ª×” ×‘×”×§×©×¨ ×©×œ ×”×–×× ×” ×¤×ª×•×—×”/×—×•×¨×’×ª
            return (order._effectiveStatus === '×¤×ª×•×—' || order._effectiveStatus === '×—×•×¨×’') && isTaken && !isBrought;
        });
        
        return !isContainerCurrentlyInuse; // True ×× ×”××›×•×œ×” ××™× ×” ×‘×©×™××•×© ×›×¨×’×¢
    }

    // ×¤×ª×™×—×ª ××•×“×œ ×”×”×–×× ×” (×”×•×¡×¤×”/×¢×¨×™×›×”/×©×›×¤×•×œ)
    function openOrderModal(mode, sheetRow = null) {
        const form = document.getElementById('order-form');
        form.reset(); // ××™×¤×•×¡ ×”×˜×•×¤×¡
        currentEditingOrder = null;
        autoFillData = null;

        if (mode === 'add') {
            document.getElementById('modal-title').textContent = '×”×•×¡×£ ×”×–×× ×” ×—×“×©×”';
            document.getElementById('×ª××¨×™×š ×”×–×× ×”').valueAsDate = new Date(); // ×ª××¨×™×š ×‘×¨×™×¨×ª ××—×“×œ: ×”×™×•×
            form.onsubmit = async e => { e.preventDefault(); await addOrder(); };
        } else if (mode === 'edit' && sheetRow) {
            document.getElementById('modal-title').textContent = '×¢×¨×•×š ×”×–×× ×”';
            currentEditingOrder = allOrders.find(order => order.sheetRow === sheetRow);
            if (currentEditingOrder) {
                Object.keys(currentEditingOrder).forEach(key => {
                    const input = form.elements[key];
                    if (input) {
                        if (input.type === 'date' && currentEditingOrder[key]) {
                            input.value = new Date(currentEditingOrder[key]).toISOString().split('T')[0];
                        } else {
                            input.value = currentEditingOrder[key];
                        }
                    }
                });
                form.onsubmit = async e => { e.preventDefault(); await editOrder(sheetRow); };
            }
        } else if (mode === 'duplicate' && sheetRow) {
            document.getElementById('modal-title').textContent = '×©×›×¤×œ ×”×–×× ×”';
            const originalOrder = allOrders.find(order => order.sheetRow === sheetRow);
            if (originalOrder) {
                Object.keys(originalOrder).forEach(key => {
                    const input = form.elements[key];
                    // ×©×›×¤×œ ××ª ×¨×•×‘ ×”×©×“×•×ª, ××š × ×§×” ×©×“×•×ª ×™×™×—×•×“×™×™× ×œ×”×–×× ×” ×—×“×©×”
                    if (input && !['×ª×¢×•×“×”', '×ª××¨×™×š ×¡×’×™×¨×”', '×™××™× ×©×¢×‘×¨×•', '××¡×¤×¨×™ ××›×•×œ×•×ª', '_effectiveStatus', '_daysPassedCalculated', 'sheetRow'].includes(key)) {
                         if (input.type === 'date' && originalOrder[key]) {
                            input.value = new Date(originalOrder[key]).toISOString().split('T')[0];
                        } else {
                            input.value = originalOrder[key];
                        }
                    }
                });
                document.getElementById('×ª××¨×™×š ×”×–×× ×”').valueAsDate = new Date(); // ×ª××¨×™×š ×—×“×© ×¢×‘×•×¨ ×”×–×× ×” ××©×•×›×¤×œ×ª
                document.getElementById('×ª×¢×•×“×”').value = ''; // × ×§×” ××¡×¤×¨ ×ª×¢×•×“×”
                form.onsubmit = async e => { e.preventDefault(); await addOrder(); }; // ×˜×¤×œ ×›×”×–×× ×” ×—×“×©×”
            }
        }
        handleActionTypeChange(); // ×¢×“×›×Ÿ ×©×“×•×ª ××›×•×œ×” ×œ×¤×™ ×¡×•×’ ×¤×¢×•×œ×”
        openModal('order-modal');
    }

    // ×˜×™×¤×•×œ ×‘×©×™× ×•×™ ×¡×•×’ ×”×¤×¢×•×œ×” ×‘××•×“×œ ×”×”×–×× ×” (×”×¦×’×ª/×”×¡×ª×¨×ª ×©×“×•×ª ××›×•×œ×”)
    function handleActionTypeChange() {
        const actionType = document.getElementById('×¡×•×’ ×¤×¢×•×œ×”').value;
        const takenDiv = document.getElementById('container-taken-div');
        const broughtDiv = document.getElementById('container-brought-div');
        takenDiv.classList.toggle('hidden', !['×”×•×¨×“×”', '×”×—×œ×¤×”'].includes(actionType));
        broughtDiv.classList.toggle('hidden', !['×”×¢×œ××”', '×”×—×œ×¤×”'].includes(actionType));
    }

    // ×”×•×¡×¤×ª ×”×–×× ×” ×—×“×©×”
    async function addOrder() {
        const form = document.getElementById('order-form');
        const formData = new FormData(form);
        const orderData = Object.fromEntries(formData.entries());
        
        // ×•×•×œ×™×“×¦×™×™×ª ×©×™××•×© ×‘××›×•×œ×” ×¢×‘×•×¨ ×¤×¢×•×œ×•×ª '×”×•×¨×“×”' ××• '×”×—×œ×¤×”'
        if (['×”×•×¨×“×”', '×”×—×œ×¤×”'].includes(orderData['×¡×•×’ ×¤×¢×•×œ×”'])) {
            const containerTaken = String(orderData['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').trim();
            if (containerTaken && !validateContainerUsage(containerTaken)) {
                showAlert(`××›×•×œ×” ${containerTaken} ×›×‘×¨ ×‘×©×™××•×© ×‘×”×–×× ×” ×¤×ª×•×—×”. ×× × ×•×“× ×©×”×™× ×¤× ×•×™×”.`, 'error');
                return;
            }
        }

        orderData['×¡×˜×˜×•×¡'] = '×¤×ª×•×—'; // ×”×–×× ×•×ª ×—×“×©×•×ª ×”×Ÿ ×ª××™×“ ×¤×ª×•×—×•×ª ×‘×”×ª×—×œ×”
        
        const response = await fetchData('add', { data: JSON.stringify(orderData) });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('order-modal');
            loadOrders(); // ×˜×¢×Ÿ ××—×“×© ××ª ×”×”×–×× ×•×ª ×›×“×™ ×œ×¨×¢× ×Ÿ ××ª ×”×ª×¦×•×’×”
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×”×•×¡×¤×ª ×”×–×× ×”', 'error');
        }
    }

    // ×¢×¨×™×›×ª ×”×–×× ×” ×§×™×™××ª
    async function editOrder(sheetRow) {
        const form = document.getElementById('order-form');
        const formData = new FormData(form);
        const updateData = Object.fromEntries(formData.entries());
        
        // ×•×•×œ×™×“×¦×™×™×ª ×©×™××•×© ×‘××›×•×œ×” ×¢×‘×•×¨ ×¤×¢×•×œ×•×ª '×”×•×¨×“×”' ××• '×”×—×œ×¤×”'
        if (['×”×•×¨×“×”', '×”×—×œ×¤×”'].includes(updateData['×¡×•×’ ×¤×¢×•×œ×”'])) {
            const containerTaken = String(updateData['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').trim();
            if (containerTaken && !validateContainerUsage(containerTaken, sheetRow)) { // ×”×¢×‘×¨ ××ª sheetRow ×”× ×•×›×—×™ ×›×“×™ ×œ× ×œ×›×œ×•×œ ××•×ª×• ×‘×‘×“×™×§×”
                showAlert(`××›×•×œ×” ${containerTaken} ×›×‘×¨ ×‘×©×™××•×© ×‘×”×–×× ×” ×¤×ª×•×—×” ××—×¨×ª. ×× × ×•×“× ×©×”×™× ×¤× ×•×™×”.`, 'error');
                return;
            }
        }

        // ××œ ×ª××¤×©×¨ ×œ×©× ×•×ª ×¡×˜×˜×•×¡ ×™×©×™×¨×•×ª ××˜×•×¤×¡ ×–×”, ××œ× ×¨×§ ××œ×•×— ×”×§× ×‘×Ÿ
        if (updateData.hasOwnProperty('×¡×˜×˜×•×¡')) {
            delete updateData['×¡×˜×˜×•×¡'];
        }
        
        const response = await fetchData('edit', { id: sheetRow, data: JSON.stringify(updateData) });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('order-modal');
            loadOrders();
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×–×× ×”', 'error');
        }
    }

    // ×©×›×¤×•×œ ×”×–×× ×” (×¤×•×ª×— ××•×“×œ "×”×•×¡×£ ×”×–×× ×”" ×¢× × ×ª×•× ×™× ××©×•×›×¤×œ×™×)
    async function duplicateOrder(sheetRow) {
        openOrderModal('duplicate', sheetRow);
    }

    // ×¤×ª×™×—×ª ××•×“×œ ××™×©×•×¨ ××—×™×§×”
    function openDeleteConfirmModal(sheetRow, orderId) {
        document.getElementById('delete-order-id').textContent = orderId;
        document.getElementById('confirm-delete-btn').onclick = () => deleteOrder(sheetRow);
        openModal('delete-confirm-modal');
    }

    // ××—×™×§×ª ×”×–×× ×”
    async function deleteOrder(sheetRow) {
        const response = await fetchData('delete', { id: sheetRow });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('delete-confirm-modal');
            loadOrders();
        } else {
            showAlert(response.message || '×©×’×™××” ×‘××—×™×§×ª ×”×–×× ×”', 'error');
        }
    }
    
    // ×‘×“×™×§×ª ×§×™×•× ×œ×§×•×— ×•×”×©×œ××” ××•×˜×•××˜×™×ª ×©×œ ×¤×¨×˜×™×
    function checkCustomerExistenceAndAutofill() {
        const customerName = document.getElementById('×©× ×œ×§×•×—').value.trim();
        const address = document.getElementById('×›×ª×•×‘×ª').value.trim();
        const phone = document.getElementById('×˜×œ×¤×•×Ÿ ×œ×§×•×—').value.trim();

        if (!customerName && !address && !phone) return; // ××™×Ÿ ××¡×¤×™×§ ××™×“×¢ ×œ×‘×“×™×§×”

        let latestOrder = null;
        // ××¦× ××ª ×”×”×–×× ×” ×”××—×¨×•× ×” ×©×œ ×”×œ×§×•×— ×”×ª×•××
        latestOrder = allOrders
            .filter(o => {
                const matchesName = customerName ? o['×©× ×œ×§×•×—'] === customerName : true;
                const matchesAddress = address ? o['×›×ª×•×‘×ª'] === address : true;
                const matchesPhone = phone ? o['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] === phone : true;
                return matchesName && matchesAddress && matchesPhone;
            })
            .sort((a, b) => new Date(b['×ª××¨×™×š ×”×–×× ×”']) - new Date(a['×ª××¨×™×š ×”×–×× ×”']))[0]; // ××™×™×Ÿ ××”×—×“×© ×œ×™×©×Ÿ

        // ×× × ××¦××” ×”×–×× ×” ×§×•×“××ª ×•×–×• ×œ× ×¢×¨×™×›×” ×©×œ ×”×–×× ×” ×§×™×™××ª
        if (latestOrder && !currentEditingOrder) {
            autoFillData = latestOrder;
            document.getElementById('autofill-customer-name-display').textContent = `×”×œ×§×•×— ${latestOrder['×©× ×œ×§×•×—']} ×–×•×”×”!`;
            document.getElementById('autofill-message').innerHTML = `×”×œ×§×•×— **${latestOrder['×©× ×œ×§×•×—']}** ×–×•×”×” ××”×–×× ×” ×§×•×“××ª ××ª××¨×™×š **${formatDate(latestOrder['×ª××¨×™×š ×”×–×× ×”'])}**. ×”×× ×‘×¨×¦×•× ×š ×œ××œ× ××ª ×¤×¨×˜×™×• ××•×˜×•××˜×™×ª?`;
            openModal('autofill-confirm-modal');
        }
    }

    // ××™×©×•×¨/×‘×™×˜×•×œ ×”×©×œ××” ××•×˜×•××˜×™×ª
    function confirmAutofill(confirm) {
        if (confirm && autoFillData) {
            Object.keys(autoFillData).forEach(key => {
                const input = document.getElementById(key);
                // ××œ× ××ª ×”×©×“×•×ª ×‘×˜×•×¤×¡, ××š ×“×œ×’ ×¢×œ ×©×“×•×ª ×¡×¤×¦×™×¤×™×™×
                if (input && !['×ª×¢×•×“×”', '×ª××¨×™×š ×”×–×× ×”', '×ª××¨×™×š ×¡×’×™×¨×”', '×™××™× ×©×¢×‘×¨×•', '××¡×¤×¨×™ ××›×•×œ×•×ª', '_effectiveStatus', '_daysPassedCalculated', 'sheetRow'].includes(key)) {
                     if (input.type === 'date' && autoFillData[key]) {
                        input.value = new Date(autoFillData[key]).toISOString().split('T')[0];
                    } else {
                        input.value = autoFillData[key];
                    }
                }
            });
            document.getElementById('×ª××¨×™×š ×”×–×× ×”').valueAsDate = new Date(); // ×ª××¨×™×š ×—×“×©
            document.getElementById('×ª×¢×•×“×”').value = ''; // × ×§×” ××¡×¤×¨ ×ª×¢×•×“×”
            handleActionTypeChange(); // ×¢×“×›×Ÿ ×©×“×•×ª ××›×•×œ×”
        }
        closeModal('autofill-confirm-modal');
        autoFillData = null;
    }

    // ×”×¦×’×ª ×¤×¨×˜×™ ×”×–×× ×” ×‘××•×“×œ
    function showOrderDetailsModal(sheetRow) {
        const order = allOrders.find(o => o.sheetRow === sheetRow);
        if (!order) {
            showAlert('×¤×¨×˜×™ ×”×–×× ×” ×œ× × ××¦××•.', 'error');
            return;
        }

        document.getElementById('details-order-id').textContent = order['×ª×¢×•×“×”'] || '×œ× ×™×“×•×¢';
        const detailsContent = document.getElementById('order-details-content');
        detailsContent.innerHTML = `
            <p><strong>×ª××¨×™×š ×”×–×× ×”:</strong> ${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</p>
            <p><strong>×¡×˜×˜×•×¡:</strong> <span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></p>
            <p><strong>×œ×§×•×—:</strong> ${order['×©× ×œ×§×•×—'] || ''}</p>
            <p><strong>×›×ª×•×‘×ª:</strong> ${order['×›×ª×•×‘×ª'] || ''}</p>
            <p><strong>×˜×œ×¤×•×Ÿ ×œ×§×•×—:</strong> ${order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] || ''}</p>
            <p><strong>×¡×•×›×Ÿ:</strong> ${order['×©× ×¡×•×›×Ÿ'] || ''}</p>
            <p><strong>×¡×•×’ ×¤×¢×•×œ×”:</strong> ${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</p>
            <p><strong>××›×•×œ×” ×™×¨×“×”:</strong> ${order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || ''}</p>
            <p><strong>××›×•×œ×” ×¢×œ×ª×”:</strong> ${order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || ''}</p>
            <p><strong>×™××™× ×©×¢×‘×¨×•:</strong> ${order._daysPassedCalculated || ''}</p>
            <p><strong>×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™:</strong> ${formatDate(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'])}</p>
            <p><strong>×”×¢×¨×•×ª:</strong> ${order['×”×¢×¨×•×ª'] || ''}</p>
            ${order['×ª××¨×™×š ×¡×’×™×¨×”'] ? `<p><strong>×ª××¨×™×š ×¡×’×™×¨×”:</strong> ${formatDate(order['×ª××¨×™×š ×¡×’×™×¨×”'])}</p>` : ''}
        `;
        
        const actionButtonsDiv = document.querySelector('#order-details-modal .flex.justify-end.gap-3');
        actionButtonsDiv.dataset.sheetRow = sheetRow; // ×©××•×¨ ××ª sheetRow ×¢×œ ×”×›×¤×ª×•×¨×™×

        openModal('order-details-modal');
    }

    // ×¢×¨×™×›×ª ×”×–×× ×” ×××•×“×œ ×”×¤×¨×˜×™×
    function editOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-end.gap-3').dataset.sheetRow;
        closeModal('order-details-modal');
        openOrderModal('edit', parseInt(sheetRow));
    }

    // ××—×™×§×ª ×”×–×× ×” ×××•×“×œ ×”×¤×¨×˜×™×
    function deleteOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-end.gap-3').dataset.sheetRow;
        const order = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        closeModal('order-details-modal');
        if (order) {
            openDeleteConfirmModal(parseInt(sheetRow), order['×ª×¢×•×“×”']);
        }
    }

    // ×©×›×¤×•×œ ×”×–×× ×” ×××•×“×œ ×”×¤×¨×˜×™×
    function duplicateOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-end.gap-3').dataset.sheetRow;
        closeModal('order-details-modal');
        openOrderModal('duplicate', parseInt(sheetRow));
    }

    // ×”×¦×’×ª ×”×™×¡×˜×•×¨×™×™×ª ××›×•×œ×” ×‘××•×“×œ
    function showContainerHistory(containerNumber) {
        document.getElementById('history-container-number').textContent = containerNumber;
        const historyTableBody = document.getElementById('container-history-table-body');
        historyTableBody.innerHTML = '';
        document.getElementById('no-container-history').classList.add('hidden');

        const containerMovements = allOrders
            .filter(order => {
                const containersTaken = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                return containersTaken.includes(containerNumber) || containersBrought.includes(containerNumber);
            })
            .sort((a, b) => new Date(a['×ª××¨×™×š ×”×–×× ×”']) - new Date(b['×ª××¨×™×š ×”×–×× ×”'])); // ××™×™×Ÿ ×›×¨×•× ×•×œ×•×’×™×ª

        if (containerMovements.length === 0) {
            document.getElementById('no-container-history').classList.remove('hidden');
        } else {
            containerMovements.forEach(order => {
                const startDate = new Date(order['×ª××¨×™×š ×”×–×× ×”']);
                // ×ª××¨×™×š ×¡×™×•× ×™×›×•×œ ×œ×”×™×•×ª ×ª××¨×™×š ×¡×’×™×¨×”, ×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™, ××• ×ª××¨×™×š ×”×™×•× ×× ×¢×“×™×™×Ÿ ×¤×ª×•×—
                const endDate = order['×ª××¨×™×š ×¡×’×™×¨×”'] ? new Date(order['×ª××¨×™×š ×¡×’×™×¨×”']) : (order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? new Date(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']) : new Date());
                
                let durationDays = 'N/A';
                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                    durationDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
                    durationDays = Math.max(0, durationDays); // ×œ×•×•×“× ×©×”××¡×¤×¨ ×œ× ×©×œ×™×œ×™
                }

                const row = historyTableBody.insertRow();
                row.className = 'border-b border-[var(--color-border)]';
                row.innerHTML = `
                    <td class="p-2">${order['×ª×¢×•×“×”'] || ''}</td>
                    <td class="p-2 font-medium">${order['×©× ×œ×§×•×—'] || ''}</td>
                    <td class="p-2">${order['×›×ª×•×‘×ª'] || ''}</td>
                    <td class="p-2">${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
                    <td class="p-2">${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                    <td class="p-2">${order['×ª××¨×™×š ×¡×’×™×¨×”'] ? formatDate(order['×ª××¨×™×š ×¡×’×™×¨×”']) : (order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? formatDate(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']) : '×˜×¨× × ×¡×’×¨')}</td>
                    <td class="p-2">${durationDays !== 'N/A' ? `${durationDays} ×™××™×` : 'N/A'}</td>
                `;
            });
        }
        openModal('container-history-modal');
    }

    // ×¨×™× ×“×•×¨ ×”×ª×¨×©×™××™× ×‘×××¦×¢×•×ª Chart.js
    function drawCharts() {
        // × ×ª×•× ×™ ××›×•×œ×•×ª ×‘×©×™××•×© ×œ×¤×™ ×œ×§×•×— (×¨×§ ×”×–×× ×•×ª ×¤×ª×•×—×•×ª/×—×•×¨×’×•×ª)
        const customerData = allOrders.reduce((acc, order) => {
            if (order._effectiveStatus !== '×¡×’×•×¨') {
                const count = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean).length;
                if (count > 0 && order['×¡×•×’ ×¤×¢×•×œ×”'] !== '×”×¢×œ××”') { // ×¨×§ ××›×•×œ×•×ª ×©×”×•×¨×“×• ×•×¢×“×™×™×Ÿ ×‘×©×™××•×©
                    acc[order['×©× ×œ×§×•×—']] = (acc[order['×©× ×œ×§×•×—']] || 0) + count;
                }
            }
            return acc;
        }, {});
        const sortedCustomers = Object.entries(customerData).sort((a, b) => b[1] - a[1]).slice(0, 10); // 10 ×”×œ×§×•×—×•×ª ×”××•×‘×™×œ×™×

        // × ×ª×•× ×™ ×”×ª×¤×œ×’×•×ª ×¡×˜×˜×•×¡×™×
        const statusData = allOrders.reduce((acc, order) => {
            const status = order._effectiveStatus || '×œ× ×™×“×•×¢';
            acc[status] = (acc[status] || 0) + 1;
            return acc;
        }, {});

        // × ×ª×•× ×™ ×”×ª×¤×œ×’×•×ª ×¡×•×’×™ ×¤×¢×•×œ×”
        const actionTypeChartData = allOrders.reduce((acc, order) => {
            const actionType = order['×¡×•×’ ×¤×¢×•×œ×”'] || '×œ× ×™×“×•×¢';
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        // ××—×–×•×¨ ×¢×¨×›×™ ××©×ª× ×™ CSS ×‘××•×¤×Ÿ ×“×™× ××™
        const computedStyle = getComputedStyle(document.documentElement);
        const surfaceColor = computedStyle.getPropertyValue('--color-surface').trim();
        const primaryColor = computedStyle.getPropertyValue('--color-primary').trim();
        const dangerColor = computedStyle.getPropertyValue('--color-danger').trim();
        const successColor = computedStyle.getPropertyValue('--color-success').trim();
        const warningColor = computedStyle.getPropertyValue('--color-warning').trim();
        const textBaseColor = computedStyle.getPropertyValue('--color-text-base').trim();

        // ×”×’×“×¨×ª ×¦×‘×¢×™× ×¢×‘×•×¨ ×”×ª×¨×©×™××™× (××©×ª××©×™× ×›×¢×ª ×‘××©×ª× ×™ CSS ×©××•×—×–×¨×•)
        const chartColors = {
            '×¤×ª×•×—': successColor,
            '×—×•×¨×’': dangerColor,
            '×¡×’×•×¨': 'rgba(108, 117, 125, 0.8)', // ××¤×•×¨ - × ×©××¨ ×§×‘×•×¢ ×× ××™×Ÿ ××©×ª× ×” CSS ×¡×¤×¦×™×¤×™
            '×”×•×¨×“×”': successColor,
            '×”×—×œ×¤×”': warningColor,
            '×”×¢×œ××”': dangerColor
        };

        // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×”×¡×¨×ª ××œ×¤× ×-rgba, ×× ×§×™×™×
        const getOpaqueColor = (color) => {
            if (color.startsWith('rgba')) {
                return color.replace(/, ?\d(\.\d+)?\)$/, ')').replace('rgba', 'rgb');
            }
            return color;
        };


        // ×ª×¨×©×™× ××›×•×œ×•×ª ×œ×¤×™ ×œ×§×•×— (×‘×¨)
        if (charts.customerChart) charts.customerChart.destroy();
        charts.customerChart = new Chart(document.getElementById('chart-containers-by-customer').getContext('2d'), {
            type: 'bar',
            data: {
                labels: sortedCustomers.map(c => c[0]),
                datasets: [{
                    label: '××¡×¤×¨ ××›×•×œ×•×ª ×‘×©×™××•×©',
                    data: sortedCustomers.map(c => c[1]),
                    backgroundColor: primaryColor, // ×©×™××•×© ×‘×¦×‘×¢ ×”×¨××©×™ ×©××•×—×–×¨
                    borderColor: getOpaqueColor(primaryColor), // ×•×’×¨×¡×ª×• ×”××˜×•××™×ª ×œ×’×‘×•×œ
                    borderWidth: 1,
                    borderRadius: 8 // ×¤×™× ×•×ª ××¢×•×’×œ×•×ª ×œ×¢××•×“×•×ª
                }]
            },
            options: {
                indexAxis: 'y', // ×ª×¨×©×™× ×‘×¨ ××•×¤×§×™
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { display: false } // ×”×¡×ª×¨×ª ×§×•×•×™ ×¨×©×ª
                    },
                    y: {
                        grid: { display: false } // ×”×¡×ª×¨×ª ×§×•×•×™ ×¨×©×ª
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const customerName = sortedCustomers[index][0];
                        document.getElementById('search-input').value = customerName;
                        filterTable();
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });

        // ×ª×¨×©×™× ×¡×˜×˜×•×¡×™× (×“×•× ××˜)
        if (charts.statusChart) charts.statusChart.destroy();
        charts.statusChart = new Chart(document.getElementById('chart-status-pie').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusData),
                datasets: [{
                    data: Object.values(statusData),
                    backgroundColor: Object.keys(statusData).map(status => chartColors[status] || '#bdc3c7'),
                    borderColor: surfaceColor, // ×©×™××•×© ×‘×¦×‘×¢ ×”××©×˜×— ×©××•×—×–×¨
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom',
                        labels: {
                            color: textBaseColor // ×©×™××•×© ×‘×¦×‘×¢ ×˜×§×¡×˜ ×‘×¡×™×¡ ×©××•×—×–×¨
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const statusClicked = Object.keys(statusData)[index];
                        document.getElementById('search-input').value = '';
                        document.getElementById('show-closed-orders').checked = (statusClicked === '×¡×’×•×¨');
                        document.getElementById('filter-status-select').value = statusClicked;
                        filterTable(statusClicked, null, true);
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });

        // ×ª×¨×©×™× ×¡×•×’×™ ×¤×¢×•×œ×” (×‘×¨)
        if (charts.actionTypeChart) charts.actionTypeChart.destroy();
        charts.actionTypeChart = new Chart(document.getElementById('chart-action-type').getContext('2d'), {
            type: 'bar',
            data: {
                labels: Object.keys(actionTypeChartData),
                datasets: [{
                    label: '××¡×¤×¨ ×¤×¢×•×œ×•×ª',
                    data: Object.values(actionTypeChartData),
                    backgroundColor: Object.keys(actionTypeChartData).map(type => chartColors[type] || '#bdc3c7'),
                    // ×©×™××•×© ×‘×¤×•× ×§×¦×™×™×ª ×”×¢×–×¨ ×›×“×™ ×œ×§×‘×œ ×’×‘×•×œ ××˜×•× ××¦×‘×¢ ×”×¨×§×¢
                    borderColor: Object.keys(actionTypeChartData).map(type => getOpaqueColor(chartColors[type] || '#bdc3c7')),
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { display: false }
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const actionTypeClicked = Object.keys(actionTypeChartData)[index];
                        document.getElementById('search-input').value = '';
                        document.getElementById('filter-action-type-select').value = actionTypeClicked;
                        filterTable(null, actionTypeClicked, true);
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });
    }

    // ×¢×“×›×•×Ÿ ×˜×‘×œ××•×ª ××œ××™ ×”××›×•×œ×•×ª (×‘×©×™××•×© ×•×¤× ×•×™×•×ª)
    function updateContainerInventory() {
        const inUseTableBody = document.querySelector('#containers-in-use-table tbody');
        const availableTableBody = document.querySelector('#containers-available-table tbody');
        inUseTableBody.innerHTML = '';
        availableTableBody.innerHTML = '';

        const containerStates = {}; // containerNum: { status: 'in-use' | 'available', lastRelevantActivityDate: Date, currentOrder?: Object }

        // ×©×œ×‘ 1: ××ª×—×•×œ ××¦×‘×™ ××›×•×œ×•×ª ×¢× ×ª××¨×™×š ×”×¤×¢×™×œ×•×ª ×”×¨×œ×•×•× ×˜×™ ×”××—×¨×•×Ÿ
        // ×¢×‘×¨ ×¢×œ ×”×–×× ×•×ª ×‘×¡×“×¨ ×›×¨×•× ×•×œ×•×’×™ ×”×¤×•×š (××”×—×“×© ×œ×™×©×Ÿ) ×›×“×™ ×œ××¦×•× ××ª ×”×¤×¢×™×œ×•×ª ×”×¨×œ×•×•× ×˜×™×ª ×”××—×¨×•× ×”.
        [...allOrders].sort((a, b) => new Date(b['×ª××¨×™×š ×”×–×× ×”']) - new Date(a['×ª××¨×™×š ×”×–×× ×”'])).forEach(order => {
            const orderDate = new Date(order['×ª××¨×™×š ×”×–×× ×”']);
            const containersTaken = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

            // ×× ××›×•×œ×” ×”×•×¢×œ×ª×”, ××• ×× ×”×”×–×× ×” × ×¡×’×¨×”, ×”×™× ×–××™× ×”/×”×•×—×–×¨×”
            // ×‘×“×•×§ ×§×•×“× ××ª ×”××›×•×œ×•×ª ×©×”×•×¢×œ×•
            containersBrought.forEach(c => {
                 if (c && (!containerStates[c] || orderDate > containerStates[c].lastRelevantActivityDate)) {
                    containerStates[c] = {
                        status: 'available', // ×”××›×•×œ×” ×”×•×—×–×¨×” ××• ×”×¤×›×” ×œ×–××™× ×”
                        lastRelevantActivityDate: orderDate
                    };
                }
            });
            // ×‘×“×•×§ ××›×•×œ×•×ª ×©×”×•×¨×“×• ×¨×§ ×× ×”×Ÿ ×œ× ×”×•×¢×œ×• ×‘××•×ª×” ×”×–×× ×”
            containersTaken.forEach(c => {
                if (c && !containersBrought.includes(c)) { // ×× ×”××›×•×œ×” ×œ× ×”×•×¢×œ×ª×”
                    if (!containerStates[c] || orderDate > containerStates[c].lastRelevantActivityDate) {
                        if (order._effectiveStatus !== '×¡×’×•×¨') { // ×× ×”×”×–×× ×” ×¤×ª×•×—×”/×—×•×¨×’×ª
                            containerStates[c] = {
                                status: 'in-use', // ×”××›×•×œ×” ×™×¨×“×” ×•×”×™× ×‘×©×™××•×©
                                lastRelevantActivityDate: orderDate,
                                currentOrder: order
                            };
                        } else { // ×× ×”×”×–×× ×” ×¡×’×•×¨×”, ×”×™× ×–××™× ×”
                            containerStates[c] = {
                                status: 'available',
                                lastRelevantActivityDate: orderDate
                            };
                        }
                    }
                }
            });
        });

        // ×©×œ×‘ 2: ××›×œ×•×¡ ×”×˜×‘×œ××•×ª ×¢×œ ×‘×¡×™×¡ ××¦×‘×™ ×”××›×•×œ×•×ª ×”×¡×•×¤×™×™×
        Object.entries(containerStates).sort((a,b) => a[0].localeCompare(b[0])).forEach(([num, state]) => {
            const row = document.createElement('tr');
            row.className = 'border-b border-[var(--color-border)]';
            if (state.status === 'in-use') {
                row.innerHTML = `<td class="p-3"><span class="cursor-pointer hover:text-[var(--color-primary)]" onclick="showContainerHistory('${num}')">ğŸ“¦ ${num}</span></td><td class="p-3">${state.currentOrder['×©× ×œ×§×•×—']}</td><td class="p-3">${formatDate(state.currentOrder['×ª××¨×™×š ×”×–×× ×”'])}</td>`;
                inUseTableBody.appendChild(row);
            } else { // status === 'available'
                let estimatedAvailableDate = new Date(state.lastRelevantActivityDate);
                // ×× ×”×™× ×”×¤×›×” ×œ×–××™× ×” ×¢×§×‘ ×”×•×¨×“×” ×©× ×¡×’×¨×”, ××• ×”×¢×œ××”, ×”×™× ×–××™× ×” ××™×“ ××”×ª××¨×™×š ×”×–×”
                // ××™×Ÿ ×¦×•×¨×š ×œ×”×•×¡×™×£ OVERDUE_THRESHOLD_DAYS ×¢×‘×•×¨ ×–××™× ×•×ª, ×›×™ ×–×” ×›×‘×¨ ××©×§×£ ×¤×¢×•×œ×” ×©×¡×™×™××” ××ª ×”×©×™××•×©.
                
                row.innerHTML = `<td class="p-3"><span class="cursor-pointer hover:text-[var(--color-primary)]" onclick="showContainerHistory('${num}')">ğŸ“¦ ${num}</span></td><td class="p-3">${formatDate(estimatedAvailableDate)}</td>`;
                availableTableBody.appendChild(row);
            }
        });
    }


    // ×¨×™× ×“×•×¨ ×œ×•×— ×”×˜×™×¤×•×œ (Kanban Board)
    function renderTreatmentBoard() {
        const columns = {
            overdue: document.getElementById('column-overdue'),
            'in-progress': document.getElementById('column-in-progress'),
            resolved: document.getElementById('column-resolved'),
        };
        // × ×§×” ××ª ×›×œ ×”×›×¨×˜×™×¡×™× ×”×§×™×™××™× ×‘×›×œ ×¢××•×“×”
        Object.values(columns).forEach(col => col.querySelectorAll('.kanban-item').forEach(item => item.remove()));

        // ×¡× ×Ÿ ×”×–×× ×•×ª ×œ×˜×™×¤×•×œ: ×”×–×× ×•×ª ×—×•×¨×’×•×ª (×©×¡×˜×˜×•×¡×Ÿ ×”×•× '×—×•×¨×’' ××• ×©×”×Ÿ '×¤×ª×•×—×•×ª' ×•×¢×‘×¨×• ××ª ×¡×£ ×”×—×¨×™×’×”)
        const ordersForTreatment = allOrders.filter(o => o._effectiveStatus === '×—×•×¨×’' || (o._effectiveStatus === '×¤×ª×•×—' && o._daysPassedCalculated >= OVERDUE_THRESHOLD_DAYS));
        
        // ×”×¦×’/×”×¡×ª×¨ ×”×•×“×¢×ª "××™×Ÿ ×”×–×× ×•×ª ×œ×˜×™×¤×•×œ"
        document.getElementById('no-treatment-orders').classList.toggle('hidden', ordersForTreatment.length > 0);

        ordersForTreatment.forEach(order => {
            const item = document.createElement('div');
            item.className = 'kanban-item card p-4 cursor-grab bg-white border border-[var(--color-border)] rounded-lg shadow-sm';
            item.draggable = true; // ××¤×©×¨×•×ª ×’×¨×™×¨×”
            item.dataset.sheetRow = order.sheetRow; // ×©××•×¨ ××ª sheetRow ×‘-dataset
            item.ondragstart = e => e.dataTransfer.setData('text/plain', order.sheetRow); // ×”×¢×‘×¨ ××ª sheetRow ×‘×’×¨×™×¨×”
            item.innerHTML = `
                <p class="font-bold text-lg text-[var(--color-text-base)]">${order['×©× ×œ×§×•×—']}</p>
                <p class="text-sm text-[var(--color-text-muted)]">×ª×¢×•×“×”: ${order['×ª×¢×•×“×”']}</p>
                <p class="text-sm mt-2"><span class="font-semibold text-[var(--color-danger)]">${order._daysPassedCalculated || 0}</span> ×™××™× ×©×¢×‘×¨×•</p>
                <div class="flex justify-end gap-1 mt-3">
                    <button class="action-icon-btn whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppAlertsForOrder(${order.sheetRow})" title="×©×œ×— WhatsApp"><i class="fab fa-whatsapp text-green-500"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})" title="×¢×¨×•×š"><i class="fas fa-edit text-[var(--color-info)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})" title="×©×›×¤×œ"><i class="fas fa-copy text-[var(--color-primary)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['×ª×¢×•×“×”']}')" title="××—×§"><i class="fas fa-trash text-[var(--color-danger)]"></i></button>
                </div>
            `;
            // ×§×‘×¢ ××ª ×”×¢××•×“×” ×”× ×›×•× ×”: 'overdue' ×× ×”×¡×˜×˜×•×¡ ×”××¤×§×˜×™×‘×™ ×”×•× '×—×•×¨×’', ××—×¨×ª 'in-progress'
            const targetColumn = order._effectiveStatus === '×—×•×¨×’' ? 'overdue' : 'in-progress';
            columns[targetColumn].appendChild(item);
        });
    }
    
    // ×× ×™×¢×ª ×¤×¢×•×œ×ª ×‘×¨×™×¨×ª ×”××—×“×œ ×©×œ ×”×“×¤×“×¤×Ÿ ×‘×’×¨×™×¨×”
    function allowDrop(event) { event.preventDefault(); }

    // ×˜×™×¤×•×œ ×‘×©×—×¨×•×¨ ×¤×¨×™×˜ ×‘×œ×•×— ×”×§× ×‘×Ÿ
    async function drop(event) {
        event.preventDefault();
        const sheetRow = event.dataTransfer.getData('text/plain');
        const targetColumn = event.currentTarget;
        const statusMap = {
            'column-overdue': '×¤×ª×•×—', // ×”×–×× ×” ×©×¢×‘×¨×” ×œ×¢××•×“×ª "×—×•×¨×’×•×ª" ×¢×“×™×™×Ÿ × ×—×©×‘×ª "×¤×ª×•×—×”" ×‘×’×™×œ×™×•×Ÿ. ×”×¡×˜×˜×•×¡ ×”××¤×§×˜×™×‘×™ ×™×§×‘×¢ ×¢"×™ ×™××™× ×©×¢×‘×¨×•
            'column-in-progress': '×¤×ª×•×—',
            'column-resolved': '×¡×’×•×¨'
        };
        const newSheetStatus = statusMap[targetColumn.id];
        if (!newSheetStatus) return;

        const updateData = { '×¡×˜×˜×•×¡': newSheetStatus };
        // ×× ×¡×˜×˜×•×¡ ×—×“×© ×”×•× '×¡×’×•×¨', ×¢×“×›×Ÿ ×’× ××ª ×ª××¨×™×š ×”×¡×’×™×¨×”
        if (newSheetStatus === '×¡×’×•×¨') {
            updateData['×ª××¨×™×š ×¡×’×™×¨×”'] = new Date().toISOString().split('T')[0];
        }
        
        const response = await fetchData('edit', { id: sheetRow, data: JSON.stringify(updateData) });
        if (response.success) {
            showAlert('×¡×˜×˜×•×¡ ×”×–×× ×” ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
            loadOrders(); // ×˜×¢×Ÿ ××—×“×© ××ª ×”×”×–×× ×•×ª ×›×“×™ ×œ×¨×¢× ×Ÿ ××ª ×”×œ×•×—
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡', 'error');
        }
    }

    // ×¨×¢× ×•×Ÿ × ×ª×•× ×™×
    function refreshData() {
        showAlert('××¨×¢× ×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.', 'info');
        loadOrders();
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×¢××•×“ ×¡×¤×¦×™×¤×™ ×•×¢×“×›×•×Ÿ × ×™×•×•×˜
    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById(`${pageId}-page`).classList.remove('hidden');
        document.querySelectorAll('.nav-tab-btn').forEach(b => b.classList.toggle('active', b.id === `nav-${pageId}`));
        if (pageId === 'whatsapp-alerts') {
            populateWhatsAppTemplates(); // ××›×œ×¡ ×ª×‘× ×™×•×ª ×•×•××˜×¡××¤ ×‘×¢×ª ××¢×‘×¨ ×œ×¢××•×“
        }
    }

    // ×œ×•×’×™×§×ª ×”×ª×¨××•×ª WhatsApp
    const whatsappTemplates = [
        { name: '×‘×¨×›×” - ×—. ×¡×‘×Ÿ', message: '×©×œ×•× [×©× ×œ×§×•×—] ×™×§×¨/×”, ×ª×•×“×” ×©×‘×—×¨×ª ×‘-×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ! ×× ×• ×œ×¨×©×•×ª×š ×‘×›×œ ×©××œ×”. ğŸ¤”ğŸ‘·â€â™‚ï¸ğŸ—ï¸' },
        { name: '×”×¦×‘×ª ××›×•×œ×” - ×”× ×—×™×•×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”××›×•×œ×” ×œ×”×–×× ×” [×ª×¢×•×“×”] ×”×•×¦×‘×” ×‘×”×¦×œ×—×”. ×× × ×•×•×“× ×’×™×©×” × ×•×—×” ×œ×¤×™× ×•×™. ×œ×©××œ×•×ª: [×˜×œ×¤×•×Ÿ ×¢×¡×§].' },
        { name: '×”×ª×¨××” - ×œ×¤× ×™ ×—×¨×™×’×” (8 ×™××™×)', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] × ××¦××ª ××¦×œ×š ×›-8 ×™××™×. ×œ×ª×©×•××ª ×œ×‘×š, ××¢×œ 10 ×™××™× ××ª××¨×™×š ×”×–×× ×”, ×”××›×•×œ×” × ×—×©×‘×ª ×—×•×¨×’×ª. ×× × ×¦×•×¨ ×§×©×¨ ×œ×ª×™××•× ×”××©×š. âš ï¸' },
        { name: '×”×ª×¨××” - ×—×•×¨×’×ª (10 ×™××™× +)', message: '×”×•×“×¢×” ×—×©×•×‘×”: ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] ×—×•×¨×’×ª ×××•×¢×“ ×”×©×›×™×¨×•×ª ×‘-[×™××™× ×—×•×¨×’×™×] ×™××™×. ×× × ×¦×•×¨ ×§×©×¨ ×‘×”×§×“× ×œ×ª×™××•× ×”×—×œ×¤×”/×¤×™× ×•×™ ×“×—×•×£: [×˜×œ×¤×•×Ÿ ×¢×¡×§]. ğŸš¨' },
        { name: '×ª×™××•× ×”×—×œ×¤×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×œ×’×‘×™ ×”×–×× ×” [×ª×¢×•×“×”], × ×©××— ×œ×ª×× ×”×—×œ×¤×”. ××ª×™ × ×•×— ×œ×š ×©× ×’×™×¢? ×× × ×”×©×‘ ×œ×”×•×“×¢×” ×–×•. ğŸ—“ï¸' },
        { name: '×ª×™××•× ×”×•×¦××”', message: '×©×œ×•× [×©× ×œ×§×•×—], × ×©××— ×œ×ª×× ×”×•×¦××ª ××›×•×œ×” ×¢×‘×•×¨ ×”×–×× ×” [×ª×¢×•×“×”]. ××ª×™ × ×•×— ×œ×š ×©× ×’×™×¢? ×× × ×”×©×‘ ×œ×”×•×“×¢×” ×–×•. ğŸ—“ï¸' },
        { name: '×ª×–×›×•×¨×ª - ×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™', message: '×©×œ×•× [×©× ×œ×§×•×—], ×ª×–×›×•×¨×ª: ×ª××¨×™×š ×”×¡×™×•× ×”×¦×¤×•×™ ×©×œ ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] ×”×•× ×‘-[×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]. ×× × ×¦×•×¨ ×§×©×¨ ×× ×ª×¨×¦×” ×œ×”××¨×™×š ××• ×œ×ª×× ×¤×™× ×•×™. ğŸ””' },
        { name: '×”×•×“×¢×” ×›×œ×œ×™×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×‘×”××©×š ×œ×”×–×× ×” [×ª×¢×•×“×”], ×¨×¦×™×ª×™ ×œ×¢×“×›×Ÿ...' },
        { name: '×”×•×“×¢×” ×¢×œ ×”×’×¢×ª ××›×•×œ×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] ×”×’×™×¢×” ×œ×™×¢×“×”. ×ª×•×“×” ×©×‘×—×¨×ª ×‘× ×•! ğŸ‰' },
        { name: '×”×•×“×¢×” ×¢×œ ××™×¡×•×£ ××›×•×œ×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] × ××¡×¤×” ×‘×”×¦×œ×—×”. × ×©××— ×œ×©×¨×ª ××•×ª×š ×©×•×‘ ×‘×¢×ª×™×“! ğŸ‘‹' },
        { name: '×©××œ×•×ª ×›×œ×œ×™×•×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ×¢×•××“×™× ×œ×¨×©×•×ª×š ×œ×›×œ ×©××œ×” ××• ×‘×§×©×” ×œ×’×‘×™ ×”×©×™×¨×•×ª ×©×œ× ×•. â“' },
        { name: '×ª×œ×•× ×”/×‘×¢×™×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”×‘× ×• ×©×™×© ×œ×š ×‘×¢×™×” ×¢× ×”×–×× ×” [×ª×¢×•×“×”]. ×× ×• ××¦×˜×¢×¨×™× ×¢×œ ××™ ×”× ×•×—×•×ª ×•× ×—×–×•×¨ ××œ×™×š ×‘×”×§×“× ×œ×˜×¤×œ ×‘×¢× ×™×™×Ÿ. ğŸ˜”' },
        { name: '×‘×§×©×ª ×—×•×•×ª ×“×¢×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ××§×•×•×™× ×©× ×”× ×™×ª ××”×©×™×¨×•×ª ×©×œ× ×• ×‘×”×–×× ×” [×ª×¢×•×“×”]. × ×©××— ×× ×ª×•×›×œ/×™ ×œ×”×©××™×¨ ×—×•×•×ª ×“×¢×ª ×§×¦×¨×”. â­' },
        { name: '×”×¦×¢×ª ×©×™×¨×•×ª×™× × ×•×¡×¤×™×', message: '×©×œ×•× [×©× ×œ×§×•×—], ×¨××™× ×• ×©××ª×” ×œ×§×•×— ×¤×¢×™×œ. ××•×œ×™ ×™×¢× ×™×™×Ÿ ××•×ª×š ×œ×œ××•×“ ×¢×œ ×”×©×™×¨×•×ª×™× ×”×—×“×©×™× ×©×œ× ×•? âœ¨' },
        { name: '×¢×“×›×•×Ÿ ×–××™× ×•×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×¨×¦×™× ×• ×œ×¢×“×›×Ÿ ×œ×’×‘×™ ×–××™× ×•×ª ×”××›×•×œ×•×ª. ×›×¨×’×¢ ×™×© ×œ× ×•... â„¹ï¸' },
        { name: '××™×©×•×¨ ×”×–×× ×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”×–×× ×ª×š ××¡×¤×¨ [×ª×¢×•×“×”] ××•×©×¨×” ×‘×”×¦×œ×—×”! ×ª××¨×™×š ××¡×¤×§×” ×¦×¤×•×™: [×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]. âœ…' },
        { name: '×”×•×“×¢×” ×¢×œ ×¢×™×›×•×‘', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ××ª× ×¦×œ×™× ×¢×œ ×¢×™×›×•×‘ ×§×œ ×‘××¡×¤×§×ª ×”××›×•×œ×” ×œ×”×–×× ×” [×ª×¢×•×“×”]. ×× ×• ×¦×•×¤×™× ×©×ª×’×™×¢ ×‘-[×ª××¨×™×š ×—×“×©]. â³' },
        { name: '×ª×•×“×” ×¢×œ ×ª×©×œ×•×', message: '×©×œ×•× [×©× ×œ×§×•×—], ×§×™×‘×œ× ×• ××ª ×”×ª×©×œ×•× ×¢×‘×•×¨ ×”×–×× ×” [×ª×¢×•×“×”]. ×ª×•×“×” ×¨×‘×”! ğŸ™' },
        { name: '×‘×§×©×ª ×ª×©×œ×•×', message: '×©×œ×•× [×©× ×œ×§×•×—], ×ª×–×›×•×¨×ª ×œ×’×‘×™ ×ª×©×œ×•× ×¢×‘×•×¨ ×”×–×× ×” [×ª×¢×•×“×”]. ×× × ×‘×¦×¢ ××ª ×”×ª×©×œ×•× ×‘×”×§×“×. ğŸ’¸' },
        { name: '×¤× ×•×™ ×‘××§×•×', message: '×©×œ×•× [×©× ×œ×§×•×—], ×œ×’×‘×™ ×”×–×× ×” [×ª×¢×•×“×”], × ××©×¨ ×›×™ ×‘×•×¦×¢ ×¤×™× ×•×™ ××›×•×œ×” ×‘××ª×¨. ×× ×• ××¢×¨×™×›×™× ××ª ×©×™×ª×•×£ ×”×¤×¢×•×œ×”. ğŸ‘' },
        { name: '××™×©×•×¨ ×§×‘×œ×ª ××¡××›×™×', message: '×©×œ×•× [×©× ×œ×§×•×—], ××™×©×•×¨ ×§×‘×œ×ª ×”××¡××›×™× ×”×“×¨×•×©×™× ×¢×‘×•×¨ ×”×–×× ×” [×ª×¢×•×“×”]. ×ª×•×“×” ×¢×œ ×©×™×ª×•×£ ×”×¤×¢×•×œ×”. ğŸ“„' },
        { name: '×¢×“×›×•×Ÿ ×©×¢×•×ª ×¤×¢×™×œ×•×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×œ×ª×©×•××ª ×œ×™×‘×š, ×©×¢×•×ª ×”×¤×¢×™×œ×•×ª ×©×œ× ×• ×¢×•×“×›× ×•. ×¤×¨×˜×™× ×‘××ª×¨: [×§×™×©×•×¨ ×œ××ª×¨]. â°' },
        { name: '×”×•×“×¢×” ×¢×œ ×©×™×¨×•×ª ×—×“×©', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ×©××—×™× ×œ×”×•×“×™×¢ ×¢×œ ×©×™×¨×•×ª ×—×“×© ×©×œ× ×•: [×©× ×©×™×¨×•×ª]. ×œ×¤×¨×˜×™× × ×•×¡×¤×™×: [×§×™×©×•×¨]. ğŸ†•' },
        { name: '××™×¨×•×¢ ×—×‘×¨×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ××–××™× ×™× ××•×ª×š ×œ××™×¨×•×¢ ×—×‘×¨×” ××™×•×—×“ ×©×™×ª×§×™×™× ×‘-[×ª××¨×™×š ××™×¨×•×¢]. ×¤×¨×˜×™× ×•×”×¨×©××”: [×§×™×©×•×¨]. ğŸ¥³' },
        { name: '×˜×™×¤×™× ×œ×ª×—×–×•×§×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”× ×” ×›××” ×˜×™×¤×™× ×—×©×•×‘×™× ×œ×ª×—×–×•×§×” × ×›×•× ×” ×©×œ ×”××›×•×œ×” ×©×œ×š. ğŸ’¡' },
        { name: '×©×™× ×•×™ ×¤×¨×˜×™ ×§×©×¨', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×©×™× ×™×ª ×¤×¨×˜×™ ×§×©×¨, ×× × ×¢×“×›×Ÿ ××•×ª× ×• ×›×“×™ ×©× ×•×›×œ ×œ×”××©×™×š ×œ×ª×ª ×©×™×¨×•×ª ××™×˜×‘×™. ğŸ“' },
        { name: '×¡×§×¨ ×©×‘×™×¢×•×ª ×¨×¦×•×Ÿ', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ××‘×§×©×™× ××ª ×¢×–×¨×ª×š ×‘××™×œ×•×™ ×¡×§×¨ ×©×‘×™×¢×•×ª ×¨×¦×•×Ÿ ×§×¦×¨ ×›×“×™ ×©× ×•×›×œ ×œ×”×©×ª×¤×¨. ğŸ˜Š' },
        { name: '×—×’ ×©××—', message: '×—×’ ×©××— [×©× ×œ×§×•×—]! ××›×•×œ× ×• ×‘-×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ. ğŸŠ' },
        { name: '×©× ×” ×˜×•×‘×”', message: '×©× ×” ×˜×•×‘×” ×•××‘×•×¨×›×ª [×©× ×œ×§×•×—]! ×××—×œ×™× ×œ×š ×©× ×” ×©×œ ×”×¦×œ×—×” ×•×©×’×©×•×’. ğŸŒŸ' },
        { name: '×¡×•×£ ×©× ×” ××–×¨×—×™×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×ª×•×“×” ×¢×œ ×©× ×” × ×¤×œ××” ×©×œ ×©×™×ª×•×£ ×¤×¢×•×œ×”. × ×©××— ×œ×”××©×™×š ×œ×©×¨×ª ××•×ª×š ×’× ×‘×©× ×” ×”×‘××”! ğŸ‘‹' }
    ];

    let currentTypingIndex = 0;
    let currentTypingTemplateMessage = '';
    let typingInterval = null;

    // ××›×œ×•×¡ ×ª×‘× ×™×•×ª ×”×•×“×¢×•×ª WhatsApp ×‘×“×¨×•×¤×“××•×Ÿ
    function populateWhatsAppTemplates() {
        const select = document.getElementById('message-template-select');
        select.innerHTML = '<option value="">×‘×—×¨ ×ª×‘× ×™×ª...</option>';
        whatsappTemplates.forEach((template, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = template.name;
            select.appendChild(option);
        });
    }

    // ×˜×¢×™× ×ª ×ª×‘× ×™×ª ×”×•×“×¢×ª WhatsApp × ×‘×—×¨×ª ×¢× ××™×œ×•×™ ××•×˜×•××˜×™ ×©×œ × ×ª×•× ×™× ×¨×œ×•×•× ×˜×™×™×
    function loadWhatsAppTemplate() {
        const select = document.getElementById('message-template-select');
        const messageInput = document.getElementById('whatsapp-message-input');
        const selectedIndex = select.value;

        // × ×§×” ×˜×™×™××¨ ×§×•×“× ×× ×§×™×™×
        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        messageInput.value = ''; // × ×§×” ××ª ×ª×™×‘×ª ×”×˜×§×¡×˜ ××™×“ ×œ×¤× ×™ ××¤×§×˜ ×”×”×§×œ×“×”

        if (selectedIndex !== "") {
            const template = whatsappTemplates[parseInt(selectedIndex)];
            let message = template.message;
            
            // × ×¡×” ×œ××œ× placeholder-×™× ×‘×”×ª×‘×¡×¡ ×¢×œ ×”×œ×§×•×—/×”×–×× ×” ×©× ×‘×—×¨×• (×× ×–××™× ×™×)
            const customerName = document.getElementById('whatsapp-customer-name').value;
            const phoneNumber = document.getElementById('whatsapp-phone-number').value; 
            const address = document.getElementById('whatsapp-address').value;
            const orderId = document.getElementById('details-order-id').textContent; // ××’×™×¢ ×××•×“×œ ×¤×¨×˜×™ ×”×–×× ×” ××• ×œ×•×— ×§× ×‘×Ÿ
            
            message = message.replace('[×©× ×œ×§×•×—]', customerName || '×”×œ×§×•×—');
            message = message.replace('[×ª×¢×•×“×”]', orderId || '×œ× ×™×“×•×¢');
            message = message.replace('[×˜×œ×¤×•×Ÿ ×¢×¡×§]', '050-1234567'); // ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×§×‘×•×¢ ×œ×¢×¡×§
            message = message.replace('[×›×ª×•×‘×ª]', address || '');
            
            const selectedOrder = allOrders.find(o => o['×ª×¢×•×“×”'] === orderId);
            if (selectedOrder) {
                if (selectedOrder._effectiveStatus === '×—×•×¨×’' && selectedOrder._daysPassedCalculated) {
                    message = message.replace('[×™××™× ×—×•×¨×’×™×]', selectedOrder._daysPassedCalculated);
                }
                if (selectedOrder['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']) {
                    message = message.replace('[×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]', formatDate(selectedOrder['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']));
                }
                // ×× ×™×© placeholder ×¢×‘×•×¨ ×ª××¨×™×š ×—×“×© (×œ××©×œ, ×œ×¢×™×›×•×‘×™×)
                 if (selectedOrder['×ª××¨×™×š ×—×“×©']) { 
                    message = message.replace('[×ª××¨×™×š ×—×“×©]', formatDate(selectedOrder['×ª××¨×™×š ×—×“×©']));
                }
            }

            // ×”×¡×¨ ×›×œ placeholder ×©× ×•×ª×¨ ×•×œ× ××•×œ×
            message = message.replace(/\[.*?\]/g, ''); 

            currentTypingTemplateMessage = message;
            currentTypingIndex = 0;
            messageInput.classList.add('typing-effect'); // ×”×¤×¢×œ ××¤×§×˜ ×”×§×œ×“×”
            typingInterval = setInterval(() => {
                if (currentTypingIndex < currentTypingTemplateMessage.length) {
                    messageInput.value += currentTypingTemplateMessage.charAt(currentTypingIndex);
                    currentTypingIndex++;
                    messageInput.scrollTop = messageInput.scrollHeight; // ×’×œ×•×œ ×œ×ª×—×ª×™×ª ×ª×™×‘×ª ×”×˜×§×¡×˜
                } else {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    messageInput.classList.remove('typing-effect'); // ×”×¡×¨ ××¤×§×˜ ×”×§×œ×“×” ×‘×¡×™×•×
                }
            }, 30); // ××”×™×¨×•×ª ×”×§×œ×“×” (××™×œ×™×©× ×™×•×ª ×œ××•×ª)
        }
    }

    // × ×™×§×•×™ ×©×“×•×ª ×”×•×“×¢×ª WhatsApp
    function clearWhatsAppMessage() {
        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        document.getElementById('whatsapp-message-input').value = '';
        document.getElementById('whatsapp-message-input').classList.remove('typing-effect');
        document.getElementById('message-template-select').value = '';
        document.getElementById('whatsapp-customer-name').value = '';
        document.getElementById('whatsapp-phone-number').value = '';
        document.getElementById('whatsapp-address').value = '';
        document.getElementById('details-order-id').textContent = ''; // × ×§×” ID ×”×–×× ×” ××©×•×™×š
    }

    // ×©×œ×™×—×ª ×”×•×“×¢×ª WhatsApp (×¤×ª×™×—×ª ×•×•××˜×¡××¤ ×•×¨×™×©×•× ×‘×œ×•×’)
    function sendWhatsAppMessage() {
        const customerName = document.getElementById('whatsapp-customer-name').value;
        const phoneNumber = document.getElementById('whatsapp-phone-number').value;
        const message = document.getElementById('whatsapp-message-input').value;
        const orderDocId = document.getElementById('details-order-id').textContent; // ×§×‘×œ ID ××¡××š ×¢×‘×•×¨ ×œ×•×’×™× ×’

        if (!phoneNumber) {
            showAlert('×× × ×‘×—×¨ ×œ×§×•×— ×¢× ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ××• ×”×–×Ÿ ××¡×¤×¨.', 'warning');
            return;
        }
        if (!message.trim()) {
            showAlert('×”×”×•×“×¢×” ×¨×™×§×”. ×× × ×›×ª×•×‘ ×”×•×“×¢×” ××• ×‘×—×¨ ×ª×‘× ×™×ª.', 'warning');
            return;
        }

        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank'); // ×¤×ª×— ×§×™×©×•×¨ ×œ×•×•××˜×¡××¤ ×‘×—×œ×•×Ÿ ×—×“×©
        
        showAlert('×¤×•×ª×— WhatsApp ×œ×©×œ×™×—×ª ×”×•×“×¢×”...', 'info');

        // ×¨×©×•× ××ª ×”×”×•×“×¢×” ×œ×’×™×œ×™×•×Ÿ Google Sheets
        logWhatsAppMessage(orderDocId, message);
    }

    // ×¤×ª×™×—×ª ×¢××•×“ ×”×ª×¨××•×ª WhatsApp ×¢×‘×•×¨ ×”×–×× ×” ×¡×¤×¦×™×¤×™×ª
    function openWhatsAppAlertsForOrder(sheetRow) {
        const order = allOrders.find(o => o.sheetRow === sheetRow);
        if (!order) {
            showAlert('×”×–×× ×” ×œ× × ××¦××”.', 'error');
            return;
        }
        
        showPage('whatsapp-alerts');
        document.getElementById('whatsapp-customer-name').value = order['×©× ×œ×§×•×—'] || '';
        document.getElementById('whatsapp-phone-number').value = order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] || '';
        document.getElementById('whatsapp-address').value = order['×›×ª×•×‘×ª'] || '';
        document.getElementById('details-order-id').textContent = order['×ª×¢×•×“×”'] || ''; // ×©××•×¨ ××ª ×”-ID ×©×œ ×”××¡××š ×¢×‘×•×¨ ×œ×•×’×™× ×’

        // × ×¡×” ×œ×‘×—×•×¨ ×ª×‘× ×™×ª ×¨×œ×•×•× ×˜×™×ª ××¨××©
        if (order._effectiveStatus === '×—×•×¨×’') {
            document.getElementById('message-template-select').value = whatsappTemplates.findIndex(t => t.name.includes('×—×•×¨×’×ª')).toString();
        } else if (order._daysPassedCalculated >= (OVERDUE_THRESHOLD_DAYS - 2) && order._effectiveStatus === '×¤×ª×•×—') { 
            document.getElementById('message-template-select').value = whatsappTemplates.findIndex(t => t.name.includes('×œ×¤× ×™ ×—×¨×™×’×”')).toString();
        } else {
            document.getElementById('message-template-select').value = ''; // ×‘×¨×™×¨×ª ××—×“×œ
        }
        loadWhatsAppTemplate(); // ×˜×¢×Ÿ ××ª ×”×ª×‘× ×™×ª ×©× ×‘×—×¨×” (××• × ×‘×—×¨×” ××¨××©)
    }

    // ×¤×•× ×§×¦×™×•× ×œ×™×•×ª "×’×œ×•×œ ×œ××¢×œ×”"
    const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

    // ×”×¦×’/×”×¡×ª×¨ ×›×¤×ª×•×¨ ×”×’×œ×™×œ×” ×œ××¢×œ×” ×‘×”×ª×× ×œ××™×§×•× ×”×’×œ×™×œ×”
    window.onscroll = function() {
        if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) { /* ×¡×£ ×’×œ×™×œ×” ×’×‘×•×” ×™×•×ª×¨ */
            scrollToTopBtn.style.display = "block";
            scrollToTopBtn.style.opacity = "1";
        } else {
            scrollToTopBtn.style.opacity = "0";
            setTimeout(() => { scrollToTopBtn.style.display = "none"; }, 300); /* ×”×¡×ª×¨ ×œ××—×¨ ××¢×‘×¨ ×× ×™××¦×™×” */
        }
    };

    // ×’×œ×™×œ×” ×—×œ×§×” ×œ×¨××© ×”×“×£
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: "smooth"
        });
    }

    // ×’×œ×™×œ×” ×—×œ×§×” ×œ×˜×‘×œ×ª ×”×”×–×× ×•×ª
    function scrollToOrdersTable() {
        document.getElementById('orders-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ×”×¨×¦×ª ×¤×•× ×§×¦×™×•×ª ××ª×—×•×œ ×‘×˜×¢×™× ×ª ×”×“×£
    window.onload = () => {
        initializeTheme(); // ××ª×—×œ ××¦×‘ ×ª×¦×•×’×”
        loadOrders(); // ×˜×¢×Ÿ ×”×–×× ×•×ª
        populateWhatsAppTemplates(); // ××›×œ×¡ ×ª×‘× ×™×•×ª ×•×•××˜×¡××¤
    };
</script>

</body>
</html>
