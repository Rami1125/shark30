<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转 CRM  砖专转 转 - 砖专</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base Variables (Desktop-first) */
        :root {
            --color-primary: #3B82F6; /* Tailwind Blue */
            --color-primary-light: #DBEAFE;
            --color-primary-dark: #1E40AF;
            --color-secondary: #6B7280; /* Gray */
            --color-secondary-light: #F3F4F6;
            --color-secondary-dark: #374151;
            --color-accent: #6D28D9; /* Purple */
            --color-accent-light: #EDE9FE;
            --color-accent-dark: #4C1D95;
            --color-background: #F8FAFC; /* Soft light background */
            --color-card-bg: #FFFFFF;
            --color-text-dark: #1F2937;
            --color-text-medium: #4B5563;
            --color-text-light: #9CA3AF;
            --color-success: #22C55E;
            --color-success-light: #DCFCE7;
            --color-success-dark: #16A34A;
            --color-error: #DC2626;
            --color-error-light: #FEE2E2;
            --color-error-dark: #991B1B;
            --color-warning: #F59E0B;
            --color-warning-light: #FFFBEB;
            --color-warning-dark: #B45309;

            --border-radius-base: 16px;
            --box-shadow-base: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        /* Global settings for Inter Font and smooth scrolling */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: var(--color-background);
            color: var(--color-text-medium);
            overflow-x: hidden;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Loading spinner mechanism */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--color-primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Base card style */
        .card {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius-base);
            box-shadow: var(--box-shadow-base);
            padding: 1.8rem;
            transition: all 0.25s ease-in-out;
            border: 1px solid #E5E7EB;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            transform: translateY(-5px);
        }

        /* Base button style - modern, with shine and hover effects */
        .btn {
            padding: 0.9rem 1.6rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            text-align: center;
            border: none;
            position: relative;
            overflow: hidden;
            background-image: linear-gradient(to right, var(--color-accent), var(--color-accent-dark));
            color: #FFFFFF;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            min-width: 140px;
            font-size: 1rem;
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.7); /* Stronger shine effect for buttons */
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
        }

        /* Specific button shades */
        .btn-primary {
            background-image: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, var(--color-primary-dark), var(--color-primary));
        }

        .btn-secondary {
            background-image: linear-gradient(to right, #E5E7EB, #D1D5DB);
            color: var(--color-text-medium);
        }
        .btn-secondary:hover {
            background-image: linear-gradient(to right, #D1D5DB, #9CA3AF);
            color: var(--color-text-dark);
        }

        .btn-danger {
            background-image: linear-gradient(to right, var(--color-error), var(--color-error-dark));
            color: #FFFFFF;
        }
        .btn-danger:hover {
            background-image: linear-gradient(to right, var(--color-error-dark), var(--color-error));
        }

        /* "Overdue Customers" button - deeper red */
        #overdue-customers-btn, #overdue-customers-btn-mobile {
            background-image: linear-gradient(to right, #B91C1C, #DC2626);
        }
        #overdue-customers-btn:hover, #overdue-customers-btn-mobile:hover {
            background-image: linear-gradient(to right, #991B1B, #B91C1C);
        }

        /* Table action button style (icons) */
        .action-btn {
            background: none;
            border: none;
            color: var(--color-secondary);
            padding: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            border-radius: 50%; /* Make them perfectly round */
            width: 40px; /* Fixed size */
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .action-btn:hover {
            color: var(--color-primary);
            background-color: var(--color-primary-light);
            transform: scale(1.2); /* More pronounced jump */
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.15);
        }

        /* Table styles */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius-base);
            box-shadow: var(--box-shadow-base);
            border: 1px solid #D1D5DB;
            background-color: var(--color-card-bg);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background-color: var(--color-card-bg);
            min-width: 850px;
        }

        th, td {
            padding: 1.2rem 1.5rem;
            text-align: right;
            border-bottom: 1px solid rgba(0,0,0,0.05); /* Very light separator */
            white-space: nowrap;
            position: relative;
            font-weight: 600;
            color: var(--color-text-medium);
            font-size: 1.05rem;
        }
        
        td {
            font-size: 1.05rem;
        }

        th {
            background-color: var(--color-background); /* Use variable */
            font-weight: 800;
            color: var(--color-text-dark);
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            font-size: 1.15rem;
            padding: 1.5rem; /* More padding for headers */
        }

        tr:hover {
            background-color: var(--color-primary-light);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.15);
            transform: translateY(-3px);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }


        /* Specific styles for status */
        .status-open, .status-closed, .status-overdue, .status-warning, .status-pending {
            padding: 0.3em 0.8em;
            border-radius: 9999px; /* Fully rounded pills */
            font-weight: 700;
            font-size: 0.9rem;
            display: inline-block;
            text-shadow: none; /* Remove default text shadow for better contrast */
        }
        .status-open { background-color: var(--color-success-light); color: var(--color-success-dark); }
        .status-closed { background-color: var(--color-secondary-light); color: var(--color-text-medium); }
        .status-overdue { background-color: var(--color-error-light); color: var(--color-error-dark); animation: pulse-red 1.5s infinite alternate; }
        .status-warning { background-color: var(--color-warning-light); color: var(--color-warning-dark); }
        .status-pending { background-color: var(--color-primary-light); color: var(--color-primary-dark); }

        /* Style for rows overdue by 110 days (in main table) */
        .overdue-110-days {
            background-color: #FEF2F2 !important;
            color: #B91C1C !important;
            font-weight: 800 !important;
            border-left: 6px solid #B91C1C;
            box-shadow: 0 0 15px rgba(185, 28, 28, 0.15) !important;
        }
        .overdue-110-days:hover {
            background-color: #FEE7E7 !important;
        }

        /* Style for closed rows */
        .closed-order-row {
            background-color: #F9FAFB !important;
            color: #9CA3AF !important;
            text-decoration: line-through;
            opacity: 0.7;
            font-style: italic;
            font-weight: 500 !important;
            text-shadow: none;
        }
        .closed-order-row a, .closed-order-row button {
            pointer-events: none;
            opacity: 0.4;
        }


        /* Modal (Pop-up) style - includes image background */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Slightly less opaque for better blur visibility */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease; /* Faster transition */
            backdrop-filter: blur(10px); /* Stronger blur */
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--color-card-bg);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4); /* Deeper, softer shadow */
            width: auto; /* Let content dictate width */
            max-width: 600px; /* Default max width for forms */
            max-height: 90vh; /* Max height to prevent overflow on smaller screens */
            overflow-y: auto; /* Allow scrolling for long content */
            transform: translateY(-20px) scale(0.95); /* More subtle entry */
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s ease-out; /* Spring-like transition */
            position: relative;
            background-image: url('https://images.unsplash.com/photo-1541888946114-1e5f0d2c3e41?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1740&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.5); /* Shiny transparent border */
            z-index: 101; /* Ensure it's above the overlay */
        }
        .modal-content:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.92); /* More transparent white layer over image */
            z-index: 0;
        }
        .modal-content > * {
            position: relative;
            z-index: 1;
        }
        .modal-content h2 { /* Headers inside modal */
            font-size: 2.2rem;
            font-weight: 800;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }
        .modal-content p { /* Paragraphs inside modal */
            font-size: 1.1rem;
            font-weight: 500;
            text-shadow: 0 0 0.5px rgba(0, 0, 0, 0.1);
        }


        .modal-overlay.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        /* Full-width modal for tables */
        .modal-full-width {
            max-width: 98%;
            height: 95%;
            max-height: 95%;
            padding: 1.5rem; /* Slightly reduced padding */
            border-radius: 15px; /* Consistent rounded corners */
        }
        .modal-full-width .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 1.5rem;
            background-color: #FDFDFD;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .modal-full-width .modal-body table {
            width: 100%;
            min-width: unset;
        }
        .modal-full-width .modal-body .table-container {
             width: 100%;
        }


        /* Close button in modal */
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            left: 1rem; /* Positioning for RTL */
            font-size: 2rem;
            cursor: pointer;
            color: var(--color-text-light); /* Lighter gray for subtle close */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.2); /* Semi-transparent background */
        }
        .modal-close-btn:hover {
            color: var(--color-error);
            background-color: var(--color-error-light);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.2);
        }

        /* Tooltip style (customized for buttons) */
        .custom-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 9px 14px;
            border-radius: 8px;
            font-size: 1rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-shadow: none;
        }

        .action-btn:hover .custom-tooltip {
            opacity: 1;
            visibility: visible;
        }


        /* Styles for charts (D3) */
        .chart-container {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius-base);
            box-shadow: var(--box-shadow-base);
            padding: 1.8rem;
            border: 1px solid #E5E7EB;
            height: 450px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease-in-out;
        }
        .chart-container:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }
        .chart-container h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }


        .chart-container svg {
            width: 100%;
            height: 100%;
        }

        .chart-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.99);
            z-index: 99;
            padding: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .chart-fullscreen svg {
            max-width: 95%;
            max-height: 95%;
            width: auto;
            height: auto;
        }

        .chart-fullscreen .close-fullscreen-btn {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            font-size: 2.2rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-medium);
            z-index: 10;
        }

        /* Notification Pop-ups (toast messages) */
        #alert-container {
            position: fixed;
            bottom: 25px;
            left: 25px;
            z-index: 110;
            display: flex;
            flex-direction: column-reverse;
            gap: 12px;
        }

        .alert-item {
            background-color: var(--color-card-bg);
            padding: 1.1rem 1.4rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 1.2rem;
            width: 380px;
            opacity: 0;
            transform: translateX(-120%);
            animation: slideIn 0.4s forwards ease-out;
            position: relative;
            border-left: 6px solid;
            font-size: 1rem;
            font-weight: 600;
        }

        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-item.alert-error { border-color: var(--color-error); color: var(--color-error); }
        .alert-item.alert-warning { border-color: var(--color-warning); color: var(--color-warning);}
        .alert-item.alert-info { border-color: var(--color-primary); color: var(--color-primary);}
        .alert-item.alert-success { border-color: var(--color-success); color: var(--color-success);}
        .alert-item p { color: var(--color-text-dark); }


        .alert-item .close-alert-btn {
            position: absolute;
            top: 0.6rem;
            left: 0.6rem;
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            color: var(--color-secondary);
            transition: color 0.2s;
        }
        .alert-item .close-alert-btn:hover {
            color: var(--color-error);
        }

        /* Input field styling */
        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 0.85rem;
            border: 1px solid #C4D0DB;
            border-radius: 10px;
            font-size: 1.1rem;
            color: var(--color-text-dark);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            font-weight: 500;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25), inset 0 1px 3px rgba(0,0,0,0.05);
        }

        /* General style for page headers */
        .page-header {
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--color-text-dark);
            margin-bottom: 2rem;
            text-align: center;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.25);
            letter-spacing: -0.02em;
        }
        .page-header + p {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Style for page navigation bar */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 3rem;
            background-color: var(--color-primary-light);
            border-radius: 18px;
            padding: 0.7rem;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border: 1px solid #C5DBFA;
        }

        .nav-tab-btn {
            padding: 0.9rem 1.8rem;
            border-radius: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            color: var(--color-text-medium);
            background-color: transparent;
            border: none;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .nav-tab-btn span {
            position: relative;
            z-index: 2;
        }

        .nav-tab-btn.active {
            background-image: linear-gradient(to right, var(--color-accent), var(--color-accent-dark));
            color: #FFFFFF;
            box-shadow: 0 5px 15px rgba(109, 40, 217, 0.4);
            transform: translateY(-3px) scale(1.02);
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.7);
        }

        .nav-tab-btn:not(.active):hover {
            background-color: #DDEEFF;
            color: var(--color-primary);
        }

        /* Print button */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-table, #printable-table * {
                visibility: visible;
            }
            #printable-table {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        /* Order card style in POPUP */
        .order-card-detail {
            background-color: #F8F9FA;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.08);
            border: 1px solid #E0E0E0;
        }
        .order-card-detail p {
            font-size: 1.15rem;
            font-weight: 500;
            margin-bottom: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: var(--color-text-medium);
        }
        .order-card-detail strong {
            color: var(--color-text-dark);
            min-width: 130px;
            font-weight: 700;
        }
        .order-card-detail .icon {
            color: var(--color-accent);
            font-size: 1.2em;
        }


        .history-section-toggle {
            display: block;
            width: 100%;
            padding: 0.9rem;
            background-image: linear-gradient(to right, var(--color-accent), var(--color-accent-dark));
            color: white;
            border-radius: 10px;
            font-weight: 700;
            margin-top: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            text-align: center;
            border: none;
            box-shadow: 0 4px 10px rgba(109, 40, 217, 0.3);
            font-size: 1.1rem;
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.7);
        }
        .history-section-toggle:hover {
            background-image: linear-gradient(to right, var(--color-accent-dark), var(--color-accent));
            box-shadow: 0 6px 15px rgba(109, 40, 217, 0.45);
            transform: translateY(-2px);
        }
        .history-section-toggle .fas {
            transition: transform 0.3s ease-in-out;
        }
        .history-section-toggle.active .fas {
            transform: rotate(180deg);
        }

        .history-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s ease-in-out;
        }
        .history-content.active {
            max-height: 700px;
        }

        /* New styles for container inventory page - side-by-side tables */
        .inventory-flex-container {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .inventory-flex-container > div {
            flex: 1;
            min-width: 380px;
            margin-bottom: 1.5rem;
        }
        .inventory-flex-container h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }


        /* Treatment Board style */
        .overdue-treatment-row {
            background-color: #FFF6F6 !important;
            border-left: 8px solid var(--color-error);
        }
        .overdue-treatment-row:hover {
            background-color: #FFEAEA !important;
        }
        .overdue-days-badge {
            display: inline-block;
            background-color: var(--color-error);
            color: white;
            padding: 0.3em 0.7em;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.95em;
            margin-right: 0.5rem;
            animation: pulse-red 1.5s infinite alternate;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.7);
        }
        @keyframes pulse-red {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.9; }
        }

        /* Raised cube frame for sections on the page */
        .main-content-wrapper {
            border: 2px solid #E0E0E0;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            background-color: var(--color-card-bg);
            margin-bottom: 3rem;
        }

        /* Container number "cube" / pill */
        .container-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.4em 0.9em;
            background-color: var(--color-accent);
            color: white;
            border-radius: 9999px; /* Fully rounded */
            font-weight: 700;
            font-size: 0.9rem;
            margin: 0 0.2em;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            gap: 0.3em;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.7);
        }

        .container-pill .fas {
            font-size: 1em;
            color: rgba(255,255,255,0.8);
        }

        .container-pill:hover {
            transform: translateY(-1px) scale(1.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            background-color: var(--color-primary); /* Darker blue on hover */
        }

        .container-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .container-pill:hover::before {
            left: 100%;
        }

        /* Row styling based on "住 驻注" */
        .row-专 { background-color: #ECFDF5 !important; } /* Light Green */
        .row-驻 { background-color: #FFFBEB !important; } /* Light Yellow */
        .row-注 { background-color: #FEF2F2 !important; } /* Light Red */
        .row-转--转拽 { background-color: #EFF6FF !important; } /* Light Blue */

        /* Ensure higher priority for overdue/closed rows if they overlap */
        .overdue-110-days { background-color: #FDE2E2 !important; }
        .closed-order-row { background-color: #F3F4F6 !important; }


        /* Styles for new filter buttons */
        .btn-filter {
            padding: 0.7rem 1.4rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-align: center;
            border: none;
            position: relative;
            overflow: hidden;
            background-image: linear-gradient(to right, var(--color-accent), var(--color-accent-dark));
            color: #FFFFFF;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            font-size: 1rem;
            min-width: 120px;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.7);
        }

        .btn-filter:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }
        .btn-filter::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .btn-filter:hover::before {
            left: 100%;
        }

        /* Specific colors for filter buttons */
        .btn-filter-pickup { background-image: linear-gradient(to right, #34D399, #10B981); } /* Greenish for Pickup */
        .btn-filter-exchange { background-image: linear-gradient(to right, #FCD34D, #FBBF24); color: var(--color-text-medium); } /* Yellow for Exchange */
        .btn-filter-return { background-image: linear-gradient(to right, #EF4444, #DC2626); } /* Red for Return */
        .btn-filter-pending { background-image: linear-gradient(to right, #60A5FA, #3B82F6); } /* Blue for Pending/Faulty */

        /* Ensure buttons don't wrap too aggressively */
        .flex-wrap { flex-wrap: wrap; }
        .flex-wrap > .btn { margin-bottom: 0.5rem; }

        /* Style for the new export buttons pop-up */
        .export-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            align-items: center;
        }
        .export-buttons-container .btn {
            min-width: 180px;
        }

        /* Mobile Action Bar */
        .mobile-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--color-card-bg);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            padding: 0.8rem 1rem;
            display: none; /* Hidden by default, shown by media query */
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .mobile-action-bar .btn {
            flex: 1;
            margin: 0 0.2rem;
            padding: 0.6rem 0.8rem;
            font-size: 0.85rem;
            min-width: unset;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        .mobile-action-bar .btn i {
            font-size: 1.2rem;
            margin: 0;
        }


        /* --- MOBILE RESPONSIVENESS (max-width: 768px) --- */
        @media (max-width: 768px) {
            :root {
                --color-primary: #8B5CF6; /* Lighter Purple for mobile */
                --color-primary-light: #F3ECFF;
                --color-primary-dark: #6D28D9;
                --color-secondary: #B1B7C1; /* Lighter Gray */
                --color-secondary-light: #F9FAFB;
                --color-secondary-dark: #7B8794;
                --color-accent: #3B82F6; /* Blue as accent for mobile */
                --color-accent-light: #DBEAFE;
                --color-accent-dark: #2563EB;
                --color-background: #FFFFFF; /* White background for app feel */
                --color-card-bg: #F9FAFB;
                --color-text-dark: #333333;
                --color-text-medium: #555555;
                --color-text-light: #AAAAAA;
                --color-success-light: #D1FAE5;
                --color-error-light: #FEECEB;
                --color-warning-light: #FFF7DB;

                --border-radius-base: 8px;
                --box-shadow-base: 0 4px 10px rgba(0,0,0,0.08);
            }

            body {
                font-size: 1rem;
                padding: 0; /* Remove overall padding */
            }

            .page-header {
                font-size: 2.5rem;
                margin-bottom: 1.5rem;
                text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            }
            .page-header + p {
                font-size: 1rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.5rem;
                margin-bottom: 2rem;
                box-shadow: none; /* Remove shadows */
                border: none;
                background-color: transparent;
            }
            .nav-tab-btn {
                padding: 0.7rem 1rem;
                font-size: 0.9rem;
                min-width: unset;
                flex-grow: 1;
                margin: 0.2rem;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .nav-tab-btn.active {
                 box-shadow: 0 3px 8px rgba(0,0,0,0.2);
                 transform: translateY(-1px) scale(1.01);
            }

            .main-content-wrapper {
                padding: 1rem;
                margin-bottom: 2rem;
                border-radius: 0;
                box-shadow: none;
                border: none;
            }

            .card {
                padding: 1.2rem;
                border-radius: 12px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            }
            .card p.text-3xl { font-size: 2rem; }
            .card i.text-4xl { font-size: 3rem; }

            .btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.95rem;
                min-width: 120px;
                gap: 0.5rem;
            }
            .btn-filter {
                 min-width: unset;
                 flex-grow: 1;
            }

            /* Hide actual tables and charts on smaller screens */
            .table-container:not(#generic-table-modal .table-container),
            .chart-container {
                display: none;
            }

            /* Show specific buttons for mobile to open content in modals */
            .mobile-view-button-group {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1.5rem;
                margin-bottom: 70px; /* Space for fixed action bar */
            }
            .mobile-view-button {
                display: block;
                width: 100%;
                text-align: center;
            }

            /* Ensure modals are truly full screen on mobile */
            .modal-content {
                width: 100%;
                max-width: 100%;
                height: auto; /* Adjust height to content */
                min-height: 70vh; /* Minimum height for better app feel */
                margin: 0;
                padding: 1rem;
                border-radius: 0;
                top: auto; /* Override top position */
                bottom: 0; /* Position at bottom */
                left: 0;
                transform: translateY(100%); /* Slide up from bottom */
                transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
                background-image: none !important; /* Remove background image for cleaner mobile modals */
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            }
            .modal-content:before {
                background-color: var(--color-card-bg); /* Use solid color for overlay on mobile */
            }
            .modal-overlay.active .modal-content {
                transform: translateY(0); /* Slide fully into view */
            }

            .modal-full-width {
                height: 100%; /* Take full height for full-screen tables */
                border-radius: 0;
            }
            .modal-close-btn {
                top: 0.5rem;
                left: 0.5rem;
                font-size: 1.8rem;
                width: 40px;
                height: 40px;
            }
            .modal-content h2 { font-size: 1.8rem; }
            .modal-content p, .order-card-detail p { font-size: 0.95rem; }
            .order-card-detail strong { min-width: 100px; }

            /* Generic table modal specific adjustments */
            #generic-table-modal .modal-body {
                padding: 0.5rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
             #generic-table-modal .modal-body table {
                min-width: 600px;
                width: auto;
            }
            #generic-table-modal .modal-body th,
            #generic-table-modal .modal-body td {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
            .chart-fullscreen svg {
                max-width: 98%;
                max-height: 98%;
            }

            /* Filter/Search bar for orders table in modal */
            .modal-full-width .modal-body .flex-col.md\\:flex-row {
                flex-direction: column;
            }
            .modal-full-width .modal-body .flex-col.md\\:flex-row > * {
                width: 100%;
            }
            .modal-full-width .modal-body .flex-col.md\\:flex-row input,
            .modal-full-width .modal-body .flex-col.md\\:flex-row select {
                margin-bottom: 0.5rem;
            }

            /* Mobile Action Bar visible */
            .mobile-action-bar {
                display: flex;
            }
        }

        /* Mobile table as cards overrides */
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #ddd;
                margin-bottom: 1rem;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                background-color: var(--color-card-bg);
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right;
                font-size: 0.9rem;
                padding: 0.7rem 1rem;
            }
            td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 700;
                color: var(--color-text-dark);
                font-size: 0.95rem;
            }
            .actions-cell {
                display: flex;
                justify-content: flex-start;
                padding-left: 10px;
                gap: 0.5rem;
                margin-top: 0.5rem;
                border-top: 1px dashed rgba(0,0,0,0.05);
                padding-top: 0.7rem;
            }
            /* Specific overrides for container pills within mobile cards to ensure readability */
            .container-pill {
                font-size: 0.8rem; /* Smaller font for pills in mobile cards */
                padding: 0.2em 0.6em;
            }
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading spinner -->
    <div id="loader-overlay" class="loader-overlay hidden">
        <div class="loader"></div>
    </div>

    <!-- Container for Alerts -->
    <div id="alert-container"></div>

    <!-- Modal for Add/Edit Order -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeOrderModal()"><i class="fas fa-times"></i></button>
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700">住祝  砖</h2>
            <form id="order-form" class="space-y-4">
                <div>
                    <label for="转专 " class="block text-sm font-medium text-gray-700 mb-1">转专 </label>
                    <input type="date" id="转专 " name="转专 " class="form-input" required>
                </div>
                <div>
                    <label for="转注" class="block text-sm font-medium text-gray-700 mb-1">转注</label>
                    <input type="text" id="转注" name="转注" class="form-input" required>
                </div>
                <div>
                    <label for="砖 住" class="block text-sm font-medium text-gray-700 mb-1">砖 住</label>
                    <input type="text" id="砖 住" name="砖 住" class="form-input" required>
                </div>
                <div>
                    <label for="砖 拽" class="block text-sm font-medium text-gray-700 mb-1">砖 拽</label>
                    <input type="text" id="砖 拽" name="砖 拽" class="form-input" required onblur="checkCustomerExistenceAndAutofill()">
                </div>
                <div>
                    <label for="转转" class="block text-sm font-medium text-gray-700 mb-1">转转</label>
                    <input type="text" id="转转" name="转转" class="form-input" required onblur="checkCustomerExistenceAndAutofill()">
                </div>
                <div>
                    <label for="住 驻注" class="block text-sm font-medium text-gray-700 mb-1">住 驻注</label>
                    <select id="住 驻注" name="住 驻注" class="form-select" required onchange="handleActionTypeChange()">
                        <option value="专">专</option>
                        <option value="注">注</option>
                        <option value="驻">驻</option>
                    </select>
                </div>
                <div id="container-taken-div">
                    <label for="住驻专  专" class="block text-sm font-medium text-gray-700 mb-1">住驻专  专 ( )</label>
                    <input type="text" id="住驻专  专" name="住驻专  专" class="form-input">
                </div>
                <div id="container-brought-div" class="hidden">
                    <label for="住驻专  注转" class="block text-sm font-medium text-gray-700 mb-1">住驻专  注转</label>
                    <input type="text" id="住驻专  注转" name="住驻专  注转" class="form-input">
                </div>
                <div>
                    <label for="转专 住 爪驻" class="block text-sm font-medium text-gray-700 mb-1">转专 住 爪驻</label>
                    <input type="date" id="转专 住 爪驻" name="转专 住 爪驻" class="form-input">
                </div>
                <div>
                    <label for="注专转" class="block text-sm font-medium text-gray-700 mb-1">注专转</label>
                    <textarea id="注专转" name="注专转" rows="3" class="form-textarea"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()"></button>
                    <button type="submit" class="btn btn-primary">砖专 </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Close Order -->
    <div id="close-order-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeCloseOrderModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">住专 </h2>
            <p class="mb-4 text-gray-600"> 转  砖专爪 住专 转  住驻专 <span id="close-order-id" class="font-bold"></span>?</p>
            <div class="mb-4">
                <label for="close-notes" class="block text-sm font-medium text-gray-700 mb-1">注专转 住 (驻爪)</label>
                <textarea id="close-notes" rows="3" class="form-textarea"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" class="btn btn-secondary" onclick="closeCloseOrderModal()"></button>
                <button type="button" class="btn btn-primary" id="confirm-close-btn">砖专 住专</button>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeDeleteConfirmModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">砖专 拽</h2>
            <p class="mb-6 text-gray-600"> 转  砖专爪 拽 转  住驻专 <span id="delete-order-id" class="font-bold"></span>? 驻注  转 驻.</p>
            <div class="flex justify-end gap-3">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()"></button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">拽</button>
            </div>
        </div>
    </div>

    <!-- Modal for Overdue Customers -->
    <div id="overdue-customers-modal" class="modal-overlay">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeOverdueCustomersModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">拽转 专 砖专转</h2>
            <div class="modal-body table-container">
                <table id="overdue-customers-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>砖 拽</th>
                            <th>转注</th>
                            <th>转转</th>
                            <th> 砖注专</th>
                            <th>住驻专 转</th>
                            <th>注专转</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Content will be loaded here -->
                    </tbody>
                </table>
                <p id="no-overdue-customers" class="text-center text-gray-500 mt-4 hidden"> 拽转 专 驻 专注. </p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeOverdueCustomersModal()">住专</button>
            </div>
        </div>
    </div>

    <!-- Modal for Auto-fill Confirmation -->
    <div id="autofill-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideAutofillConfirmModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">拽 !</h2>
            <p class="mb-6 text-gray-600">拽/转转  注专转. 转专爪   转 转  专?</p>
            <div class="flex justify-center gap-4">
                <button type="button" class="btn btn-primary" onclick="confirmAutofill(true)"></button>
                <button type="button" class="btn btn-secondary" onclick="confirmAutofill(false)"></button>
            </div>
        </div>
    </div>

    <!-- Modal for Order Details / Customer History -->
    <div id="order-details-modal" class="modal-overlay">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeOrderDetailsModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">驻专 </h2>
            <div class="modal-body">
                <div id="current-order-card" class="order-card-detail">
                    <!-- Current order details will be loaded here -->
                </div>

                <button class="history-section-toggle" onclick="toggleCustomerHistorySection()">
                    <span id="history-toggle-text">爪 住专转 拽</span> <i class="fas fa-chevron-down ml-2"></i>
                </button>

                <div id="customer-history-section" class="history-content table-container mt-4">
                    <table id="customer-history-table" class="min-w-full">
                        <thead>
                            <tr>
                                <th>转专 </th>
                                <th>转注</th>
                                <th>住 驻注</th>
                                <th>住驻专  专</th>
                                <th>住驻专  注转</th>
                                <th>住住</th>
                                <th> 砖注专</th>
                                <th>转专 住专</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Content will be loaded here -->
                        </tbody>
                    </table>
                    <p id="no-customer-history" class="text-center text-gray-500 mt-4 hidden"> 住专转 转 注专 拽 .</p>
                </div>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeOrderDetailsModal()">住专</button>
            </div>
        </div>
    </div>

    <!-- Modal for Container History -->
    <div id="container-history-modal" class="modal-overlay">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeContainerHistoryModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">住专转 : <span id="history-container-number"></span></h2>
            <div class="modal-body table-container">
                <table id="container-history-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>转专 </th>
                            <th>转注</th>
                            <th>砖 拽</th>
                            <th>住 驻注</th>
                            <th>住驻专  专</th>
                            <th>住驻专  注转</th>
                            <th>住住 </th>
                            <th>转专 住 爪驻</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Content will be loaded here -->
                    </tbody>
                </table>
                <p id="no-container-history" class="text-center text-gray-500 mt-4 hidden"> 住专转 砖 注专  .</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeContainerHistoryModal()">住专</button>
            </div>
        </div>
    </div>

    <!-- New: Modal for Containers on Sites -->
    <div id="containers-on-site-modal" class="modal-overlay">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeContainersOnSiteModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">转 转专</h2>
            <div class="modal-body table-container">
                <table id="containers-on-site-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>砖 拽</th>
                            <th>转转</th>
                            <th>转 砖砖 驻注</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Containers data will be loaded here -->
                    </tbody>
                </table>
                <p id="no-active-containers-msg" class="text-center text-gray-500 mt-4 hidden"> 转 驻注转 专注 转专.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeContainersOnSiteModal()">住专</button>
            </div>
        </div>
    </div>

    <!-- New: Modal for Export Actions -->
    <div id="export-actions-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeExportActionsModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">驻注转 爪 驻住</h2>
            <div class="export-buttons-container">
                <button class="btn btn-secondary" onclick="printTable()">
                    <i class="fas fa-print ml-2"></i> 驻住 
                </button>
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    <i class="fas fa-file-excel ml-2"></i> 爪 拽住
                </button>
            </div>
        </div>
    </div>

    <!-- New: Generic Table Display Modal for Mobile -->
    <div id="generic-table-modal" class="modal-overlay">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeGenericTableModal()"><i class="fas fa-times"></i></button>
            <h2 id="generic-table-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700"></h2>
            <div class="modal-body table-container">
                <!-- Search and Filter will be injected here for orders table -->
                <div id="generic-table-filters" class="hidden flex flex-col md:flex-row gap-4 mb-6 w-full">
                    <input type="text" id="generic-search-input" placeholder="驻砖..."
                           class="flex-grow px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                           onkeyup="filterGenericTable()">
                    <select id="generic-filter-status" onchange="filterGenericTable()"
                            class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="all"> 住住</option>
                        <option value="驻转">驻转</option>
                        <option value="专">专</option>
                        <option value="住专">住专</option>
                        <option value="转/ 转拽">转/ 转拽</option>
                    </select>
                     <select id="generic-filter-action-type" onchange="filterGenericTable()"
                            class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="all"> 住 驻注转</option>
                        <option value="专">专</option>
                        <option value="注">注</option>
                        <option value="驻">驻</option>
                    </select>
                </div>
                <table id="generic-table-content" class="min-w-full">
                    <thead>
                        <tr></tr>
                    </thead>
                    <tbody>
                        <tr></tr>
                    </tbody>
                </table>
                 <p id="no-generic-table-data" class="text-center text-gray-500 mt-4 hidden"> 转 爪.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeGenericTableModal()">住专</button>
            </div>
        </div>
    </div>


    <div class="min-h-screen flex flex-col p-4 md:p-8">
        <header class="mb-8 text-center flex flex-col items-center justify-center">
            <div class="flex items-center justify-center mb-4">
                <img src="https://placehold.co/80x80/6D28D9/FFFFFF?text=CRM" alt="Company Logo" class="h-20 w-20 rounded-full shadow-lg border-2 border-purple-300 mr-4">
                <h1 class="page-header m-0">注专转 CRM 转</h1>
            </div>
            <p class="text-lg text-gray-600 mb-2"> 砖专转 转 拽转 注转</p>
            <div class="text-sm text-gray-500 font-mono tracking-wide">
                <span id="current-date" class="mr-2 text-purple-600 font-semibold"></span> |
                <span id="current-time" class="ml-2 text-blue-600 font-semibold animate-pulse"></span>
            </div>
        </header>

        <!-- Page navigation bar -->
        <nav class="nav-tabs">
            <button id="nav-dashboard" class="nav-tab-btn active" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt ml-2"></i> 砖专 转 转
            </button>
            <button id="nav-container-inventory" class="nav-tab-btn" onclick="showPage('container-inventory')">
                <i class="fas fa-boxes ml-2"></i>  转
            </button>
            <button id="nav-treatment-board" class="nav-tab-btn" onclick="showPage('treatment-board')">
                <i class="fas fa-exclamation-circle ml-2"></i>  驻 (转 专砖转 转住转)
            </button>
        </nav>

        <main class="flex-grow">
            <!-- Dashboard and Orders Table -->
            <section id="dashboard-page" class="page-content main-content-wrapper">
                <!-- Top buttons - now moved to mobile-action-bar for small screens -->
                <div class="hidden md:flex flex-col md:flex-row justify-center items-center mb-8 gap-4 flex-wrap">
                    <button class="btn btn-primary" onclick="openOrderModal('add')">
                        <i class="fas fa-plus-circle ml-2"></i> 住祝  砖
                    </button>
                    <button class="btn btn-danger" id="overdue-customers-btn" onclick="openOverdueCustomersModal()">
                        <i class="fas fa-hand-paper ml-2"></i> 拽转 专 驻 <span id="overdue-customers-badge" class="mr-2 bg-white text-red-600 px-2 py-1 rounded-full text-xs font-bold">0</span>
                    </button>
                    <button class="btn btn-primary" onclick="openContainersOnSiteModal()">
                        <i class="fas fa-map-marked-alt ml-2"></i> 转 转专
                    </button>
                    <button class="btn btn-secondary" onclick="openExportActionsModal()">
                        <i class="fas fa-cogs ml-2"></i> 驻注转 爪
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt ml-2"></i> 专注 转
                    </button>
                </div>

                <!-- Dashboard cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">转 驻转转</p>
                            <p id="open-orders-count" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <i class="fas fa-box-open text-blue-500 text-4xl opacity-75"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">转 专转</p>
                            <p id="overdue-orders-count" class="text-3xl font-bold text-red-500 mt-1">0</p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl opacity-75"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">转 砖砖</p>
                            <p id="containers-in-use" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <i class="fas fa-truck-moving text-green-500 text-4xl opacity-75"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">拽转 驻注</p>
                            <p id="active-customers-count" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <i class="fas fa-users text-purple-500 text-4xl opacity-75"></i>
                    </div>
                </div>

                <!-- Charts and diagrams -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div id="chart-containers-by-customer" class="chart-container">
                        <button class="action-btn absolute top-3 left-3 z-10" onclick="toggleFullscreen('chart-containers-by-customer')">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                        <h3 class="text-lg font-bold mb-4 text-gray-700">转 砖砖 驻 拽</h3>
                    </div>
                    <div id="chart-status-pie" class="chart-container">
                        <button class="action-btn absolute top-3 left-3 z-10" onclick="toggleFullscreen('chart-status-pie')">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                        <h3 class="text-lg font-bold mb-4 text-gray-700">拽转 转 驻 住住</h3>
                    </div>
                </div>

                <!-- Dynamic orders table - visible only on desktop, replaced by button on mobile -->
                <div class="hidden md:block">
                    <div class="card p-6 mb-8">
                        <h2 class="text-2xl font-bold mb-6 text-gray-700">专砖转 转</h2>

                        <!-- Search and filter bar -->
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <input type="text" id="search-input" placeholder="驻砖 驻 拽, 转注, 转转, ..."
                                   class="flex-grow px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                   onkeyup="filterTable()">
                            <select id="filter-status" onchange="filterTable()"
                                    class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="all"> 住住</option>
                                <option value="驻转">驻转</option>
                                <option value="专">专</option>
                                <option value="住专">住专</option>
                                <option value="转/ 转拽">转/ 转拽</option>
                            </select>
                            <select id="filter-action-type" onchange="filterTable()"
                                    class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="all"> 住 驻注转</option>
                                <option value="专">专</option>
                                <option value="注">注</option>
                                <option value="驻">驻</option>
                            </select>
                        </div>

                        <div class="table-container" id="printable-table">
                            <table id="orders-table">
                                <thead>
                                    <tr>
                                        <th>转专 </th>
                                        <th>转注</th>
                                        <th>砖 住</th>
                                        <th><i class="fas fa-user-circle ml-2"></i> 砖 拽</th>
                                        <th>转转</th>
                                        <th>住 驻注</th>
                                        <th> 砖注专</th>
                                        <th><i class="fas fa-box ml-2"></i> 转 拽砖专转</th>
                                        <th>住住</th>
                                        <th>注专转</th>
                                        <th>转专 住 爪驻</th>
                                        <th>注专转 住</th>
                                        <th>转专 住专</th>
                                        <th> 砖注专 (注转)</th>
                                        <th class="w-24">驻注转</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Order data will be loaded here using JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- "View Orders Table" button - visible only on mobile -->
                <div class="block md:hidden mobile-view-button-group">
                    <button class="btn btn-primary mobile-view-button" onclick="openGenericTableModal('orders-table', '专砖转 转', allOrders)">
                        <i class="fas fa-list-alt ml-2"></i> 爪驻 转 转
                    </button>
                </div>

            </section>

            <!-- Container Inventory Page -->
            <section id="container-inventory-page" class="page-content hidden main-content-wrapper">
                <h2 class="page-header"> 转</h2>
                <div class="inventory-flex-container mb-8">
                    <div class="card p-6 flex-1 hidden md:block">
                        <h3 class="text-xl font-bold mb-4 text-gray-700">转 砖砖 <i class="fas fa-truck-moving text-red-500 mr-2"></i></h3>
                        <div class="table-container">
                            <table id="containers-in-use-table" class="min-w-full">
                                <thead>
                                    <tr>
                                        <th>住驻专 </th>
                                        <th>拽</th>
                                        <th>转专 驻注</th>
                                        <th>转注</th>
                                        <th>住住</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Inventory data will be loaded here -->
                                </tbody>
                            </table>
                            <p id="no-containers-in-use" class="text-center text-gray-500 mt-4 hidden"> 转 砖砖 专注. </p>
                        </div>
                    </div>

                    <div class="card p-6 flex-1 hidden md:block">
                        <h3 class="text-xl font-bold mb-4 text-gray-700">转 驻转 <i class="fas fa-boxes text-green-500 mr-2"></i></h3>
                        <div class="table-container">
                            <table id="containers-available-table" class="min-w-full">
                                <thead>
                                    <tr>
                                        <th>住驻专 </th>
                                        <th>转专 驻</th>
                                        <th> 拽砖专</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Inventory data will be loaded here -->
                                </tbody>
                            </table>
                            <p id="no-containers-available" class="text-center text-gray-500 mt-4 hidden"> 转 驻转 专注.</p>
                        </div>
                    </div>
                </div>

                <!-- Buttons for viewing inventory tables - visible only on mobile -->
                <div class="block md:hidden mobile-view-button-group">
                    <button class="btn btn-primary mobile-view-button" onclick="openGenericTableModal('containers-in-use-table', '转 砖砖', getContainersInUseData())">
                        <i class="fas fa-truck-moving ml-2"></i> 爪驻 转 砖砖
                    </button>
                    <button class="btn btn-secondary mobile-view-button" onclick="openGenericTableModal('containers-available-table', '转 驻转', getContainersAvailableData())">
                        <i class="fas fa-boxes ml-2"></i> 爪驻 转 驻转
                    </button>
                </div>
            </section>

            <!-- Treatment Board Page -->
            <section id="treatment-board-page" class="page-content hidden main-content-wrapper">
                <h2 class="page-header"> 驻 - 转 专砖转 转住转</h2>
                <p class="text-lg text-gray-600 mb-6 text-center"> 转爪 转  转 专转 砖专砖转 驻 .</p>
                <div class="card p-6 mb-8 hidden md:block">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">转 专转 <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i></h3>
                    <div class="table-container">
                        <table id="treatment-table" class="min-w-full">
                            <thead>
                                <tr>
                                    <th>转专 </th>
                                    <th>转注</th>
                                    <th><i class="fas fa-user-circle ml-2"></i> 砖 拽</th>
                                    <th>转转</th>
                                    <th>住 驻注</th>
                                    <th><i class="fas fa-calendar-times ml-2"></i>  专</th>
                                    <th><i class="fas fa-box ml-2"></i> 转 拽砖专转</th>
                                    <th>注专转</th>
                                    <th class="w-24">驻注转</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Content will be loaded here -->
                            </tbody>
                        </table>
                        <p id="no-treatment-orders" class="text-center text-gray-500 mt-4 hidden"> 转 驻 专注.  ! </p>
                    </div>
                </div>

                <!-- Button for viewing treatment board - visible only on mobile -->
                <div class="block md:hidden mobile-view-button-group">
                    <button class="btn btn-danger mobile-view-button" onclick="openGenericTableModal('treatment-table', ' 驻', getTreatmentData())">
                        <i class="fas fa-exclamation-circle ml-2"></i> 爪驻  驻
                    </button>
                </div>
            </section>

        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm pb-16 md:pb-4"> <!-- Added padding for mobile action bar -->
            <p>&copy; 2025 注专转 CRM 转.  转 砖专转.</p>
        </footer>
    </div>

    <!-- Mobile Action Bar - always visible on mobile -->
    <div class="mobile-action-bar md:hidden">
        <button class="btn btn-primary" onclick="openOrderModal('add')">
            <i class="fas fa-plus-circle"></i> <span> 砖</span>
        </button>
        <button class="btn btn-danger" id="overdue-customers-btn-mobile" onclick="openOverdueCustomersModal()">
            <i class="fas fa-hand-paper"></i> <span>专 (<span id="overdue-customers-badge-mobile">0</span>)</span>
        </button>
        <button class="btn btn-primary" onclick="openContainersOnSiteModal()">
            <i class="fas fa-map-marked-alt"></i> <span>转专</span>
        </button>
        <button class="btn btn-secondary" onclick="openExportActionsModal()">
            <i class="fas fa-cogs"></i> <span>爪</span>
        </button>
        <button class="btn btn-secondary" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i> <span>专注</span>
        </button>
    </div>


    <script>
        // TODO: Replace SCRIPT_WEB_APP_URL with your Web App URL after deploying Code.gs
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec';
        let allOrders = []; // Raw data of all orders
        let currentEditingOrder = null; // Variable to store order during editing
        let autoFillData = null; // To store data for autofill
        
        let genericTableCurrentData = []; // Data for the generic table modal
        let genericTableType = ''; // 'orders', 'inUse', 'available', 'treatment'


        // General helper functions
        function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }

        /**
         * Displays a pop-up message to the user.
         * @param {string} message The message to display.
         * @param {'success'|'error'|'warning'|'info'} type The message type (affects color).
         */
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertItem = document.createElement('div');
            alertItem.className = `alert-item alert-${type} flex items-center gap-2`;
            alertItem.innerHTML = `
                ${type === 'success' ? '<i class="fas fa-check-circle text-green-600"></i>' : ''}
                ${type === 'error' ? '<i class="fas fa-times-circle text-red-600"></i>' : ''}
                ${type === 'warning' ? '<i class="fas fa-exclamation-triangle text-orange-600"></i>' : ''}
                ${type === 'info' ? '<i class="fas fa-info-circle text-blue-600"></i>' : ''}
                <p class="text-sm font-medium text-gray-800 flex-grow">${message}</p>
                <button class="close-alert-btn" onclick="this.closest('.alert-item').remove()"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(alertItem);

            // Remove the alert automatically after a few seconds
            setTimeout(() => {
                alertItem.style.opacity = '0';
                alertItem.style.transform = 'translateX(-100%)';
                setTimeout(() => alertItem.remove(), 300); // Remove from DOM after animation
            }, 5000);
        }

        /**
         * Sends a Fetch request to Google Apps Script.
         * Implements exponential backoff for retries.
         * @param {string} action The action to perform in the script (e.g., 'list', 'add').
         * @param {Object} params Additional parameters for the request.
         * @param {number} retries Current retry count.
         * @returns {Promise<Object>} Response object from the server.
         */
        async function fetchData(action, params = {}, retries = 0) {
            showLoader();
            const urlParams = new URLSearchParams({ action, ...params });
            const url = `${SCRIPT_WEB_APP_URL}?${urlParams.toString()}`;
            const MAX_RETRIES = 5;
            const BASE_DELAY = 1000; // 1 second

            try {
                const response = await fetch(url);
                const data = await response.json();
                hideLoader();
                if (!data.success) {
                    showAlert(data.message || '砖 爪注 驻注.', 'error');
                }
                return data;
            } catch (error) {
                hideLoader();
                if (retries < MAX_RETRIES) {
                    const delay = BASE_DELAY * Math.pow(2, retries) + Math.random() * 500; // Add jitter
                    console.warn(`Fetch error for action "${action}". Retrying in ${delay / 1000}s... (Attempt ${retries + 1}/${MAX_RETRIES})`, error);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchData(action, params, retries + 1);
                } else {
                    console.error('砖转 Fetch 住驻转:', error);
                    showAlert('砖 转拽砖专转 注 砖专转 专 住驻专 住转: ' + error.message, 'error');
                    return { success: false, message: '砖 转拽砖专转 注 砖专转: ' + error.message };
                }
            }
        }

        /**
         * Loads all orders from the sheet and updates the UI.
         */
        async function loadOrders() {
            const response = await fetchData('list', { status: 'all' });
            if (response.success) {
                allOrders = response.data;
                updateDashboard();
                filterTable(); // Call filter function to render the table with full data initially
                checkAlerts(allOrders); // Run alert checks
                drawCharts(allOrders); // Draw charts
                updateContainerInventory(); // Update container inventory
                // If the treatment board page is active, re-render it
                if (!document.getElementById('treatment-board-page').classList.contains('hidden')) {
                    renderTreatmentTable(allOrders);
                }
            }
        }

        /**
         * Updates the dashboard cards.
         */
        function updateDashboard() {
            const openOrders = allOrders.filter(o => o['住住'] !== '住专' && o['住住'] !== '转/ 转拽');
            const overdueOrders = allOrders.filter(o => o['住住'] === '专');

            const containersInUse = new Set();
            openOrders.forEach(order => {
                if (order['住 驻注'] === '专' || order['住 驻注'] === '驻') {
                    const containers = (String(order['住驻专  专'] || order['住驻专 转'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    containers.forEach(container => {
                        if (container) containersInUse.add(container);
                    });
                }
            });

            const activeCustomers = new Set();
            openOrders.forEach(order => {
                if (order['砖 拽']) {
                    activeCustomers.add(order['砖 拽'].trim());
                }
            });

            document.getElementById('open-orders-count').textContent = openOrders.length;
            document.getElementById('overdue-orders-count').textContent = overdueOrders.length;
            document.getElementById('containers-in-use').textContent = containersInUse.size;
            document.getElementById('active-customers-count').textContent = activeCustomers.size;

            // Update the "Overdue Customers" badge
            document.getElementById('overdue-customers-badge').textContent = overdueOrders.length;
            if (document.getElementById('overdue-customers-badge-mobile')) {
                document.getElementById('overdue-customers-badge-mobile').textContent = overdueOrders.length;
            }
        }

        /**
         * Renders the orders table in the UI.
         * @param {Array<Object>} ordersToRender The orders to display in the table.
         * @param {HTMLElement} tableBodyElement The tbody to render (default: #orders-table tbody)
         */
        function renderOrdersTable(ordersToRender, tableBodyElement = document.querySelector('#orders-table tbody')) {
            tableBodyElement.innerHTML = ''; // Clear existing content

            if (ordersToRender.length === 0) {
                return;
            }

            ordersToRender.forEach(order => {
                const row = tableBodyElement.insertRow();
                row.dataset.sheetRow = order.sheetRow;
                row.dataset.customerName = order['砖 拽'];
                row.dataset.customerAddress = order['转转'];

                row.style.cursor = 'pointer';
                row.onclick = () => showOrderDetails(order);

                let rowActionClass = '';
                if (order['住住'] === '住专') {
                    rowActionClass = 'closed-order-row';
                } else if (order['住住'] !== '住专' && order[' 砖注专'] && parseInt(order[' 砖注专']) > 110) {
                    rowActionClass = 'overdue-110-days';
                } else {
                    switch (order['住 驻注']) {
                        case '专': rowActionClass = 'row-专'; break;
                        case '驻': rowActionClass = 'row-驻'; break;
                        case '注': rowActionClass = 'row-注'; break;
                        default:
                            if (order['住住'] === '转/ 转拽') {
                                rowActionClass = 'row-转--转拽';
                            }
                            break;
                    }
                }
                if (rowActionClass) {
                    row.classList.add(rowActionClass);
                }


                row.insertCell().setAttribute('data-label', '转专 ');
                row.cells[0].textContent = formatDate(order['转专 ']);

                const docIdCell = row.insertCell();
                docIdCell.setAttribute('data-label', '转注');
                docIdCell.innerHTML = `
                    <div class="tooltip-container">
                        ${order['转注']}
                        <span class="custom-tooltip">住: ${order['砖 住'] || ' 注'}</span>
                    </div>
                `;
                row.insertCell().setAttribute('data-label', '砖 住');
                row.cells[2].textContent = order['砖 住'] || '';

                row.insertCell().setAttribute('data-label', '砖 拽');
                row.cells[3].textContent = order['砖 拽'] || '';

                row.insertCell().setAttribute('data-label', '转转');
                row.cells[4].textContent = order['转转'] || '';

                row.insertCell().setAttribute('data-label', '住 驻注');
                row.cells[5].textContent = order['住 驻注'] || '';

                row.insertCell().setAttribute('data-label', ' 砖注专');
                row.cells[6].textContent = order[' 砖注专'] !== undefined ? order[' 砖注专'] : '';

                const containersCell = row.insertCell();
                containersCell.setAttribute('data-label', '转 拽砖专转');
                let containersToDisplay = '';
                let containerNumbersForHistory = [];

                if (order['住 驻注'] === '专') {
                    containersToDisplay = String(order['住驻专  专'] || order['住驻专 转'] || '');
                    containerNumbersForHistory = containersToDisplay.split(',').map(c => c.trim()).filter(c => c);
                } else if (order['住 驻注'] === '注') {
                    containersToDisplay = String(order['住驻专  注转'] || order['住驻专 转'] || '');
                    containerNumbersForHistory = containersToDisplay.split(',').map(c => c.trim()).filter(c => c);
                } else if (order['住 驻注'] === '驻') {
                    const taken = String(order['住驻专  专'] || '');
                    const brought = String(order['住驻专  注转'] || '');
                    if (taken && brought) {
                        containersToDisplay = `专: ${taken}, 注转: ${brought}`;
                        containerNumbersForHistory = [taken, brought].map(c => c.trim()).filter(c => c);
                    } else if (taken) {
                        containersToDisplay = `专: ${taken}`;
                        containerNumbersForHistory = [taken].map(c => c.trim()).filter(c => c);
                    } else if (brought) {
                        containersToDisplay = `注转: ${brought}`;
                        containerNumbersForHistory = [brought].map(c => c.trim()).filter(c => c);
                    }
                } else {
                    containersToDisplay = String(order['住驻专 转'] || '');
                    containerNumbersForHistory = containersToDisplay.split(',').map(c => c.trim()).filter(c => c);
                }

                if (containerNumbersForHistory.length > 0) {
                    containersCell.innerHTML = containerNumbersForHistory.map(containerNum => {
                        let displayPrefix = '';
                        if (order['住 驻注'] === '驻') {
                            if ((String(order['住驻专  专'] || '')).includes(containerNum)) displayPrefix = '专: ';
                            if ((String(order['住驻专  注转'] || '')).includes(containerNum)) displayPrefix = '注转: ';
                        }
                        return `
                            <span class="container-pill"
                                  onclick="event.stopPropagation(); openContainerHistoryModal('${containerNum}')">
                                <i class="fas fa-box"></i> ${displayPrefix}${containerNum}
                            </span>
                        `;
                    }).join(', ');

                } else {
                    containersCell.textContent = '';
                }

                const statusCell = row.insertCell();
                statusCell.setAttribute('data-label', '住住');
                let statusClass = '';
                switch (order['住住']) {
                    case '驻转': statusClass = 'status-open'; break;
                    case '住专': statusClass = 'status-closed'; break;
                    case '专': statusClass = 'status-overdue'; break;
                    case '转/ 转拽': statusClass = 'status-pending'; break;
                    default: statusClass = 'status-warning'; break;
                }
                statusCell.innerHTML = `<span class="${statusClass}">${order['住住'] || ''}</span>`;

                row.insertCell().setAttribute('data-label', '注专转');
                row.cells[8].textContent = order['注专转'] || '';

                row.insertCell().setAttribute('data-label', '转专 住 爪驻');
                row.cells[9].textContent = formatDate(order['转专 住 爪驻']);

                row.insertCell().setAttribute('data-label', '注专转 住');
                row.cells[10].textContent = order['注专转 住'] || '';

                row.insertCell().setAttribute('data-label', '转专 住专');
                row.cells[11].textContent = formatDate(order['转专 住专']);

                row.insertCell().setAttribute('data-label', ' 砖注专 (注转)');
                row.cells[12].textContent = order[' 砖注专 (注转)'] !== undefined ? order[' 砖注专 (注转)'] : '';


                const actionsCell = row.insertCell();
                actionsCell.setAttribute('data-label', '驻注转');
                actionsCell.className = 'flex gap-1 justify-center items-center actions-cell';
                actionsCell.innerHTML = `
                    <button class="action-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})">
                        <i class="fas fa-edit"></i>
                        <span class="custom-tooltip">注专 </span>
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})">
                        <i class="fas fa-copy"></i>
                        <span class="custom-tooltip">砖驻 </span>
                    </button>
                    ${order['住住'] !== '住专' ? `
                    <button class="action-btn" onclick="event.stopPropagation(); openCloseOrderModal(${order.sheetRow}, '${order['转注']}')">
                        <i class="fas fa-check-circle text-green-600"></i>
                        <span class="custom-tooltip">住专 </span>
                    </button>` : ''}
                    <button class="action-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['转注']}')">
                        <i class="fas fa-trash-alt text-red-600"></i>
                        <span class="custom-tooltip">拽 </span>
                    </button>
                `;
            });
        }

        /**
         * Formats date for display.
         * @param {Date|string} dateInput Date or date string.
         * @returns {string} Date in DD/MM/YYYY format.
         */
        function formatDate(dateInput) {
            if (!dateInput) return '';
            const date = new Date(dateInput);
            if (isNaN(date.getTime())) return dateInput;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        /**
         * Opens the add/edit modal and populates data if needed.
         * @param {'add'|'edit'} mode Operation mode (add or edit).
         * @param {number} [sheetRow] Row number in the sheet for editing.
         */
        function openOrderModal(mode, sheetRow = null) {
            const modal = document.getElementById('order-modal');
            const form = document.getElementById('order-form');
            const modalTitle = document.getElementById('modal-title');
            form.reset();
            autoFillData = null;
            currentEditingOrder = null;

            // Clear previous validation messages
            document.querySelectorAll('.form-input, .form-select, .form-textarea').forEach(input => {
                input.setCustomValidity('');
            });

            if (mode === 'add') {
                modalTitle.textContent = '住祝  砖';
                form.onsubmit = (e) => { e.preventDefault(); addOrder(); };
                document.getElementById('转专 ').valueAsDate = new Date();
            } else if (mode === 'edit' && sheetRow) {
                modalTitle.textContent = '注专 ';
                currentEditingOrder = allOrders.find(order => order.sheetRow === sheetRow);
                if (currentEditingOrder) {
                    for (const key in currentEditingOrder) {
                        const input = document.getElementById(key);
                        if (input) {
                            if (input.type === 'date' && currentEditingOrder[key]) {
                                const date = new Date(currentEditingOrder[key]);
                                if (!isNaN(date.getTime())) {
                                    input.value = date.toISOString().split('T')[0];
                                }
                            } else {
                                input.value = currentEditingOrder[key];
                            }
                        }
                    }
                    document.getElementById('住驻专  专').value = currentEditingOrder['住驻专  专'] || '';
                    document.getElementById('住驻专  注转').value = currentEditingOrder['住驻专  注转'] || '';
                    handleActionTypeChange();

                    form.onsubmit = (e) => { e.preventDefault(); editOrder(sheetRow); };
                } else {
                    showAlert(' 注专  爪.', 'error');
                    return;
                }
            }
            handleActionTypeChange();
            modal.classList.add('active');
        }

        /**
         * Closes the add/edit modal.
         */
        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
            document.getElementById('order-form').reset();
            currentEditingOrder = null;
            autoFillData = null;
            handleActionTypeChange();
        }

        /**
         * Checks for customer/address existence in the system and offers autofill.
         */
        function checkCustomerExistenceAndAutofill() {
            const customerNameInput = document.getElementById('砖 拽');
            const addressInput = document.getElementById('转转');
            const customerName = customerNameInput.value.trim();
            const address = addressInput.value.trim();

            if (!customerName && !address) {
                return;
            }

            const matchingOrders = allOrders.filter(order =>
                order['住住'] !== '住专' &&
                (order['砖 拽'] || '').trim() === customerName &&
                (order['转转'] || '').trim() === address
            );

            const latestOrder = allOrders
                .filter(order => (order['砖 拽'] || '').trim() === customerName && (order['转转'] || '').trim() === address)
                .sort((a, b) => new Date(b['转专 ']) - new Date(a['转专 ']))[0];

            if (latestOrder && !currentEditingOrder) {
                autoFillData = latestOrder;
                document.getElementById('autofill-confirm-modal').classList.add('active');
            }

            if (matchingOrders.length > 1) {
                showAlert(`专: 拽转 ${matchingOrders.length} 转 驻注转 注专 拽 "${customerName}" 转转 "${address}".`, 'warning');
            }
        }

        /**
         * Handles user response regarding autofill.
         * @param {boolean} confirm Whether the user confirmed autofill.
         */
        function confirmAutofill(confirm) {
            hideAutofillConfirmModal();
            if (confirm && autoFillData) {
                document.getElementById('转注').value = autoFillData['转注'] || '';
                document.getElementById('砖 住').value = autoFillData['砖 住'] || '';
                document.getElementById('住 驻注').value = autoFillData['住 驻注'] || '专';
                document.getElementById('转专 住 爪驻').value = autoFillData['转专 住 爪驻'] ? new Date(autoFillData['转专 住 爪驻']).toISOString().split('T')[0] : '';
                document.getElementById('注专转').value = autoFillData['注专转'] || '';
                document.getElementById('住驻专  专').value = autoFillData['住驻专  专'] || '';
                document.getElementById('住驻专  注转').value = autoFillData['住驻专  注转'] || '';
                handleActionTypeChange();

                showAlert('转  专  转.', 'success');
            } else {
                showAlert('  .', 'info');
            }
            autoFillData = null;
        }

        function hideAutofillConfirmModal() {
            document.getElementById('autofill-confirm-modal').classList.remove('active');
        }


        /**
         * Handles action type change in the add/edit form.
         * Shows/hides and makes required the relevant container number fields.
         */
        function handleActionTypeChange() {
            const actionType = document.getElementById('住 驻注').value;
            const containerTakenDiv = document.getElementById('container-taken-div');
            const containerBroughtDiv = document.getElementById('container-brought-div');
            const containerTakenInput = document.getElementById('住驻专  专');
            const containerBroughtInput = document.getElementById('住驻专  注转');

            containerTakenDiv.classList.add('hidden');
            containerBroughtDiv.classList.add('hidden');
            containerTakenInput.required = false;
            containerBroughtInput.required = false;
            containerTakenInput.value = '';
            containerBroughtInput.value = '';

            if (actionType === '专') {
                containerTakenDiv.classList.remove('hidden');
                containerTakenInput.required = true;
                containerTakenInput.name = '住驻专  专';
                document.querySelector('#container-taken-div label').textContent = '住驻专  专';
            } else if (actionType === '注') {
                containerBroughtDiv.classList.remove('hidden');
                containerBroughtInput.required = true;
                containerBroughtInput.name = '住驻专  注转';
            } else if (actionType === '驻') {
                containerTakenDiv.classList.remove('hidden');
                containerBroughtDiv.classList.remove('hidden');
                containerTakenInput.required = true;
                containerBroughtInput.required = true;
                containerTakenInput.name = '住驻专  专';
                document.querySelector('#container-taken-div label').textContent = '住驻专  专';
                containerBroughtInput.name = '住驻专  注转';
            }
        }

        /**
         * Validates the document ID for uniqueness (excluding current order if in edit mode).
         */
        async function validateDocumentId() {
            const docIdInput = document.getElementById('转注');
            const docId = docIdInput.value.trim();
            if (!docId) {
                docIdInput.setCustomValidity('砖 转注 专砖.');
                docIdInput.reportValidity();
                return;
            }

            const isDuplicate = allOrders.some(order =>
                order['转注'].trim() === docId &&
                order['住住'] !== '住专' &&
                (currentEditingOrder ? order.sheetRow !== currentEditingOrder.sheetRow : true)
            );
            
            if (isDuplicate) {
                docIdInput.setCustomValidity('住驻专 转注  专 拽 注专  驻注.');
                docIdInput.reportValidity();
            } else {
                docIdInput.setCustomValidity('');
            }
        }

        /**
         * Validates that the order date is not in the future.
         */
        function validateOrderDate() {
            const orderDateInput = document.getElementById('转专 ');
            const orderDate = new Date(orderDateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (orderDate > today) {
                orderDateInput.setCustomValidity('转专    转 注转.');
                orderDateInput.reportValidity();
            } else {
                orderDateInput.setCustomValidity('');
            }
        }

        /**
         * Adds a new order to the sheet.
         */
        async function addOrder() {
            const form = document.getElementById('order-form');
            // Run all validations before attempting to submit
            validateOrderDate();
            await validateDocumentId(); // Await async validation

            if (!form.checkValidity()) {
                showAlert('  转  砖转 专砖 专.', 'error');
                return;
            }

            const formData = new FormData(form);
            const orderData = {};
            for (const [key, value] of formData.entries()) {
                if (key === '住驻专  专' && document.getElementById('container-taken-div').classList.contains('hidden')) continue;
                if (key === '住驻专  注转' && document.getElementById('container-brought-div').classList.contains('hidden')) continue;
                
                orderData[key] = value;
            }

            if (orderData['转专 ']) {
                const date = new Date(orderData['转专 ']);
                orderData['转专 '] = date.toLocaleDateString('en-CA');
            }
            if (orderData['转专 住 爪驻']) {
                const date = new Date(orderData['转专 住 爪驻']);
                orderData['转专 住 爪驻'] = date.toLocaleDateString('en-CA');
            }

            const response = await fetchData('add', { data: JSON.stringify(orderData) });
            if (response.success) {
                showAlert(response.message, 'success');
                closeOrderModal();
                loadOrders();
            }
        }

        /**
         * Edits an existing order in the sheet.
         * @param {number} sheetRow The row number in the sheet to edit.
         */
        async function editOrder(sheetRow) {
            const form = document.getElementById('order-form');
            validateOrderDate();
            await validateDocumentId();

            if (!form.checkValidity()) {
                showAlert('  转  砖转 专砖 专.', 'error');
                return;
            }

            const formData = new FormData(form);
            const updateData = {};
            for (const [key, value] of formData.entries()) {
                let originalValue = currentEditingOrder[key];

                if (key === '住驻专  专') {
                    if (!document.getElementById('container-taken-div').classList.contains('hidden') && value !== originalValue) {
                         updateData[key] = value;
                    } else if (document.getElementById('container-taken-div').classList.contains('hidden') && originalValue !== '') {
                        updateData[key] = '';
                    }
                } else if (key === '住驻专  注转') {
                    if (!document.getElementById('container-brought-div').classList.contains('hidden') && value !== originalValue) {
                        updateData[key] = value;
                    } else if (document.getElementById('container-brought-div').classList.contains('hidden') && originalValue !== '') {
                         updateData[key] = '';
                    }
                } else if (originalValue !== value) {
                    updateData[key] = value;
                }
            }

            if (updateData['转专 ']) {
                const date = new Date(updateData['转专 ']);
                updateData['转专 '] = date.toLocaleDateString('en-CA');
            }
            if (updateData['转专 住 爪驻']) {
                const date = new Date(updateData['转专 住 爪驻']);
                updateData['转专 住 爪驻'] = date.toLocaleDateString('en-CA');
            }

            const response = await fetchData('edit', { id: sheetRow, data: JSON.stringify(updateData) });
            if (response.success) {
                showAlert(response.message, 'success');
                closeOrderModal();
                loadOrders();
            }
        }

        /**
         * Opens the close order modal.
         * @param {number} sheetRow The row number in the sheet to close.
         * @param {string} orderId The order ID.
         */
        function openCloseOrderModal(sheetRow, orderId) {
            document.getElementById('close-order-id').textContent = orderId;
            document.getElementById('close-notes').value = '';
            document.getElementById('confirm-close-btn').onclick = () => confirmCloseOrder(sheetRow);
            document.getElementById('close-order-modal').classList.add('active');
        }

        /**
         * Closes the close order modal.
         */
        function closeCloseOrderModal() {
            document.getElementById('close-order-modal').classList.remove('active');
        }

        /**
         * Confirms and closes an order.
         * @param {number} sheetRow The row number in the sheet to close.
         */
        async function confirmCloseOrder(sheetRow) {
            const notes = document.getElementById('close-notes').value;
            const response = await fetchData('close', { id: sheetRow, notes: notes });
            if (response.success) {
                showAlert(response.message, 'success');
                closeCloseOrderModal();
                loadOrders();
            }
        }

        /**
         * Opens the delete confirmation modal.
         * @param {number} sheetRow The row number in the sheet to delete.
         * @param {string} orderId The order ID.
         */
        function openDeleteConfirmModal(sheetRow, orderId) {
            document.getElementById('delete-order-id').textContent = orderId;
            document.getElementById('confirm-delete-btn').onclick = () => deleteOrder(sheetRow);
            document.getElementById('delete-confirm-modal').classList.add('active');
        }

        /**
         * Closes the delete confirmation modal.
         */
        function closeDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').classList.remove('active');
        }

        /**
         * Deletes an order from the sheet.
         * @param {number} sheetRow The row number in the sheet to delete.
         */
        async function deleteOrder(sheetRow) {
            const response = await fetchData('delete', { id: sheetRow });
            if (response.success) {
                showAlert(response.message, 'success');
                closeDeleteConfirmModal();
                loadOrders();
            }
        }

        /**
         * Duplicates an existing order.
         * @param {number} sheetRow The row number in the sheet to duplicate.
         */
        async function duplicateOrder(sheetRow) {
            const response = await fetchData('duplicate', { id: sheetRow });
            if (response.success) {
                showAlert(response.message, 'success');
                loadOrders();
            }
        }

        /**
         * Filters the main table (desktop only).
         * @param {string} [statusFilterParam] Status to filter by (optional, will override select value).
         * @param {string} [actionTypeFilterParam] Action type to filter by (optional, will override select value).
         */
        function filterTable(statusFilterParam = null, actionTypeFilterParam = null) {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            
            const filterStatus = statusFilterParam !== null ? statusFilterParam : document.getElementById('filter-status').value;
            const filterActionType = actionTypeFilterParam !== null ? actionTypeFilterParam : document.getElementById('filter-action-type').value;

            document.getElementById('filter-status').value = filterStatus;
            document.getElementById('filter-action-type').value = filterActionType;


            const filtered = allOrders.filter(order => {
                const matchesSearch =
                    (order['砖 拽'] || '').toLowerCase().includes(searchText) ||
                    (order['转注'] || '').toLowerCase().includes(searchText) ||
                    (order['转转'] || '').toLowerCase().includes(searchText) ||
                    (order['注专转'] || '').toLowerCase().includes(searchText) ||
                    (String(order['住驻专  专'] || '')).toLowerCase().includes(searchText) || 
                    (String(order['住驻专  注转'] || '')).toLowerCase().includes(searchText);


                const matchesStatus = filterStatus === 'all' || order['住住'] === filterStatus;
                const matchesActionType = filterActionType === 'all' || order['住 驻注'] === filterActionType;

                return matchesSearch && matchesStatus && matchesActionType;
            });

            renderOrdersTable(filtered);
        }

        /**
         * Resets all filters in the table.
         */
        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-status').value = 'all';
            document.getElementById('filter-action-type').value = 'all';
            filterTable();
        }

        /**
         * Checks for duplicates and overdue items and displays pop-up alerts.
         * @param {Array<Object>} orders The current list of orders.
         */
        function checkAlerts(orders) {
            document.getElementById('alert-container').innerHTML = '';

            const activeOrders = orders.filter(o => o['住住'] !== '住专');
            const customerNameAddressCombinations = {};
            const docIdCounts = {};
            const containerActiveUsage = {};

            activeOrders.forEach(order => {
                const customerName = order['砖 拽'] ? order['砖 拽'].trim() : '';
                const address = order['转转'] ? order['转转'].trim() : '';
                const customerAddressKey = `${customerName}|${address}`;

                if (customerName && address) {
                    if (!customerNameAddressCombinations[customerAddressKey]) {
                        customerNameAddressCombinations[customerAddressKey] = [];
                    }
                    customerNameAddressCombinations[customerAddressKey].push(order);
                }

                const docId = order['转注'] ? order['转注'].trim() : '';
                if (docId) {
                    if (!docIdCounts[docId]) {
                        docIdCounts[docId] = [];
                    }
                    docIdCounts[docId].push(order);
                }

                if ((order['住 驻注'] === '专' || order['住 驻注'] === '驻') && String(order['住驻专  专'] || '')) {
                    (String(order['住驻专  专'] || '')).split(',').forEach(container => {
                        const trimmedContainer = container.trim();
                        if (trimmedContainer) {
                            if (!containerActiveUsage[trimmedContainer]) {
                                containerActiveUsage[trimmedContainer] = [];
                            }
                            containerActiveUsage[trimmedContainer].push(order);
                        }
                    });
                }

                if (order['住住'] === '专') {
                    showAlert(` 专转: 转注 ${order['转注']} 砖 拽 ${order['砖 拽']} 专转 转专 爪驻.`, 'warning');
                }
            });

            for (const key in customerNameAddressCombinations) {
                if (customerNameAddressCombinations[key].length > 1) {
                    const [customerName, address] = key.split('|');
                    showAlert(`专: 拽转 ${customerNameAddressCombinations[key].length} 转 驻注转 注专 拽 "${customerName}" 转转 "${address}".`, 'warning');
                }
            }

            for (const docId in docIdCounts) {
                if (docIdCounts[docId].length > 1) {
                    const conflictingOrders = docIdCounts[docId].map(o => o['砖 拽'] ? o['砖 拽'].trim() : '').join(', ');
                    showAlert(`专: 住驻专 转注 '${docId}' 驻注 -${docIdCounts[docId].length} 转 驻转转 (拽转: ${conflictingOrders}).`, 'error');
                }
            }

            for (const container in containerActiveUsage) {
                if (containerActiveUsage[container].length > 1) {
                    const conflictingOrders = containerActiveUsage[container].map(o => o['转注']).join(', ');
                    showAlert(` '${container}' 爪转 砖砖 转专  转 驻注: ${conflictingOrders}`, 'error');
                }
            }
        }

        /**
         * Draws the containers in use by customer chart.
         * @param {Array<Object>} orders Order data.
         */
        function drawContainersByCustomerChart(orders) {
            const chartDiv = d3.select("#chart-containers-by-customer");
            chartDiv.select("svg").remove();

            const activeOrders = orders.filter(o => o['住住'] !== '住专' && o['住住'] !== '转/ 转拽');
            const customerContainerCounts = {};
            activeOrders.forEach(order => {
                const customerName = order['砖 拽'];
                let numContainers = 0;
                if (order['住 驻注'] === '专' || order['住 驻注'] === '驻') {
                     numContainers = (String(order['住驻专  专'] || order['住驻专 转'] || '')).split(',').filter(c => c.trim() !== '').length;
                } else if (order['住 驻注'] === '注' && String(order['住驻专  注转'] || '')) {
                } else {
                    numContainers = (String(order['住驻专 转'] || '')).split(',').filter(c => c.trim() !== '').length;
                }

                if (numContainers > 0) {
                     customerContainerCounts[customerName] = (customerContainerCounts[customerName] || 0) + numContainers;
                }
            });

            const data = Object.entries(customerContainerCounts).map(([customer, count]) => ({ customer, count }));
            data.sort((a, b) => b.count - a.count);

            if (data.length === 0) {
                 chartDiv.append("p").attr("class", "text-gray-500").text(" 转 转 砖砖 爪.");
                 return;
            }

            const margin = { top: 20, right: 20, bottom: 80, left: 60 };
            const bounds = chartDiv.node().getBoundingClientRect();
            const width = bounds.width - margin.left - margin.right;
            const height = bounds.height - margin.top - margin.bottom;

            const svg = chartDiv.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.customer))
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(data, d => d.count) * 1.1]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .call(d3.axisLeft(y));

            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.customer))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d.count))
                .attr("height", d => height - y(d.count))
                .attr("fill", "var(--color-primary)");
        }

        /**
         * Draws the status distribution pie chart.
         * @param {Array<Object>} orders Order data.
         */
        function drawStatusPieChart(orders) {
            const chartDiv = d3.select("#chart-status-pie");
            chartDiv.select("svg").remove();

            const statusCounts = {};
            orders.forEach(order => {
                const status = order['住住'] || ' 注';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const data = Object.entries(statusCounts).map(([status, count]) => ({ status, count }));

            if (data.length === 0) {
                chartDiv.append("p").attr("class", "text-gray-500").text(" 转 住住 爪.");
                return;
            }

            const bounds = chartDiv.node().getBoundingClientRect();
            const radius = Math.min(bounds.width, bounds.height) / 2 - 20;

            const svg = chartDiv.append("svg")
                .attr("width", bounds.width)
                .attr("height", bounds.height)
                .append("g")
                .attr("transform", `translate(${bounds.width / 2},${bounds.height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.status))
                .range(d3.schemeCategory10);

            const pie = d3.pie()
                .value(d => d.count);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const arcs = svg.selectAll("arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.status));

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("text-anchor", "middle")
                .text(d => `${d.data.status} (${((d.data.count / orders.length) * 100).toFixed(1)}%)`)
                .style("fill", "white")
                .style("font-size", "12px")
                .style("pointer-events", "none");

            const legend = svg.selectAll(".legend")
                .data(color.domain())
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(${radius + 20},${-radius / 2 + i * 20})`);

            legend.append("rect")
                .attr("x", 0)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", color);

            legend.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "start")
                .text(d => d);
        }

        /**
         * Draws all charts.
         * @param {Array<Object>} orders Order data.
         */
        function drawCharts(orders) {
            drawContainersByCustomerChart(orders);
            drawStatusPieChart(orders);
        }

        /**
         * Toggles full-screen mode for a chart.
         * @param {string} chartId The div ID of the chart.
         */
        function toggleFullscreen(chartId) {
            const chartElement = document.getElementById(chartId);
            chartElement.classList.toggle('chart-fullscreen');

            if (chartElement.classList.contains('chart-fullscreen')) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-fullscreen-btn';
                closeBtn.innerHTML = '<i class="fas fa-compress-alt"></i>';
                closeBtn.onclick = () => toggleFullscreen(chartId);
                chartElement.appendChild(closeBtn);
            } else {
                const closeBtn = chartElement.querySelector('.close-fullscreen-btn');
                if (closeBtn) {
                    closeBtn.remove();
                }
            }
            drawCharts(allOrders);
        }

        /**
         * Exports the displayed table data to an Excel (CSV) file.
         */
        function exportToExcel() {
            const table = document.getElementById('orders-table');
            const rows = Array.from(table.querySelectorAll('tr'));

            if (rows.length <= 1) {
                showAlert(' 转 爪.', 'warning');
                return;
            }

            const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim());
            const filteredHeaders = headers.filter(header => header !== '驻注转');

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += filteredHeaders.join(',') + '\n';

            for (let i = 1; i < rows.length; i++) {
                const rowCells = Array.from(rows[i].querySelectorAll('td'));
                const rowData = filteredHeaders.map(header => {
                    const headerIndex = headers.indexOf(header);
                    let value = rowCells[headerIndex] ? rowCells[headerIndex].textContent.trim() : '';

                    if (rows[i].classList.contains('closed-order-row')) {
                        value = value.replace(/[\u0305\u0336]/g, '');
                    }

                    value = value.replace(/"/g, '""');
                    if (value.includes(',')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvContent += rowData.join(',') + '\n';
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "orders_table_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAlert('转 爪 拽住 爪!', 'success');
        }

        /**
         * Prints the displayed orders table.
         */
        function printTable() {
            const currentTableBody = document.querySelector('#orders-table tbody');
            if (currentTableBody.rows.length === 0) {
                showAlert(' 转 驻住.', 'warning');
                return;
            }
            window.print();
        }

        /**
         * Opens the overdue customers modal.
         */
        function openOverdueCustomersModal() {
            const modal = document.getElementById('overdue-customers-modal');
            const tableBody = document.querySelector('#overdue-customers-table tbody');
            const noCustomersMsg = document.getElementById('no-overdue-customers');
            tableBody.innerHTML = '';
            noCustomersMsg.classList.add('hidden');

            const overdueCustomers = allOrders.filter(o => o['住住'] === '专');

            if (overdueCustomers.length === 0) {
                noCustomersMsg.classList.remove('hidden');
            } else {
                overdueCustomers.sort((a, b) => (parseInt(b[' 砖注专']) || 0) - (parseInt(a[' 砖注专']) || 0));

                overdueCustomers.forEach(order => {
                    const row = tableBody.insertRow();
                    row.insertCell().setAttribute('data-label', '砖 拽');
                    row.cells[0].textContent = order['砖 拽'] || '';
                    row.insertCell().setAttribute('data-label', '转注');
                    row.cells[1].textContent = order['转注'] || '';
                    row.insertCell().setAttribute('data-label', '转转');
                    row.cells[2].textContent = order['转转'] || '';
                    row.insertCell().setAttribute('data-label', ' 砖注专');
                    row.cells[3].textContent = order[' 砖注专'] || '';
                    
                    row.insertCell().setAttribute('data-label', '住驻专 转');
                    let containersText = '';
                    if (order['住 驻注'] === '驻') {
                        const taken = String(order['住驻专  专'] || '');
                        const brought = String(order['住驻专  注转'] || '');
                        if (taken && brought) containersText = `专: ${taken}, 注转: ${brought}`;
                        else if (taken) containersText = `专: ${taken}`;
                        else if (brought) containersText = `注转: ${brought}`;
                    } else if (order['住 驻注'] === '专') {
                        containersText = String(order['住驻专  专'] || '');
                    } else if (order['住 驻注'] === '注') {
                        containersText = String(order['住驻专  注转'] || '');
                    } else {
                        containersText = String(order['住驻专 转'] || '');
                    }
                    row.cells[4].textContent = containersText;

                    row.insertCell().setAttribute('data-label', '注专转');
                    row.cells[5].textContent = order['注专转'] || '';
                });
            }
            modal.classList.add('active');
        }

        /**
         * Closes the overdue customers modal.
         */
        function closeOverdueCustomersModal() {
            document.getElementById('overdue-customers-modal').classList.remove('active');
        }

        /**
         * Displays order card in POPUP.
         * @param {Object} orderData The selected order data.
         */
        function showOrderDetails(orderData) {
            const modal = document.getElementById('order-details-modal');
            const orderCard = document.getElementById('current-order-card');
            
            let containersDisplay = '';
            if (orderData['住 驻注'] === '专') {
                containersDisplay = String(orderData['住驻专  专'] || orderData['住驻专 转'] || '');
            } else if (orderData['住 驻注'] === '注') {
                containersDisplay = String(orderData['住驻专  注转'] || orderData['住驻专 转'] || '');
            } else if (orderData['住 驻注'] === '驻') {
                const taken = String(orderData['住驻专  专'] || '');
                const brought = String(orderData['住驻专  注转'] || '');
                if (taken && brought) {
                    containersDisplay = `专: ${taken}, 注转: ${brought}`;
                } else if (taken) {
                    containersDisplay = `专: ${taken}`;
                } else if (brought) {
                    containersDisplay = `注转: ${brought}`;
                }
            } else {
                containersDisplay = String(orderData['住驻专 转'] || '');
            }

            orderCard.innerHTML = `
                <p><i class="fas fa-id-card icon"></i> <strong>转注:</strong> ${orderData['转注'] || ''}</p>
                <p><i class="fas fa-calendar-alt icon"></i> <strong>转专 :</strong> ${formatDate(orderData['转专 '])}</p>
                <p><i class="fas fa-user-tie icon"></i> <strong>砖 住:</strong> ${orderData['砖 住'] || ''}</p>
                <p><i class="fas fa-user-circle icon"></i> <strong>砖 拽:</strong> ${orderData['砖 拽'] || ''}</p>
                <p><i class="fas fa-map-marker-alt icon"></i> <strong>转转:</strong> ${orderData['转转'] || ''}</p>
                <p><i class="fas fa-exchange-alt icon"></i> <strong>住 驻注:</strong> ${orderData['住 驻注'] || ''}</p>
                <p><i class="fas fa-boxes icon"></i> <strong>转 拽砖专转:</strong> ${containersDisplay}</p>
                <p><i class="fas fa-info-circle icon"></i> <strong>住住:</strong> <span class="${orderData['住住'] === '驻转' ? 'status-open' : orderData['住住'] === '专' ? 'status-overdue' : 'status-closed'}">${orderData['住住'] || ''}</span></p>
                <p><i class="fas fa-hourglass-half icon"></i> <strong> 砖注专:</strong> ${orderData[' 砖注专'] !== undefined ? orderData[' 砖注专'] : ''}</p>
                <p><i class="fas fa-calendar-check icon"></i> <strong>转专 住 爪驻:</strong> ${formatDate(orderData['转专 住 爪驻'])}</p>
                <p><i class="fas fa-comment-dots icon"></i> <strong>注专转:</strong> ${orderData['注专转'] || ''}</p>
                <p><i class="fas fa-calendar-times icon"></i> <strong>转专 住专:</strong> ${formatDate(orderData['转专 住专'])}</p>
                <p><i class="fas fa-history icon"></i> <strong>注专转 住:</strong> ${orderData['注专转 住'] || ''}</p>
            `;

            document.getElementById('customer-history-section').classList.remove('active');
            document.getElementById('history-toggle-text').textContent = '爪 住专转 拽';
            document.querySelector('.history-section-toggle .fas').classList.remove('fa-chevron-up');
            document.querySelector('.history-section-toggle .fas').classList.add('fa-chevron-down');


            renderCustomerHistoryTable(orderData['砖 拽'], orderData['转转']);

            modal.classList.add('active');
        }

        /**
         * Closes the order details modal.
         */
        function closeOrderDetailsModal() {
            document.getElementById('order-details-modal').classList.remove('active');
        }

        /**
         * Shows/hides the customer history section within the order details modal.
         */
        function toggleCustomerHistorySection() {
            const historySection = document.getElementById('customer-history-section');
            const toggleText = document.getElementById('history-toggle-text');
            const toggleIcon = document.querySelector('.history-section-toggle .fas');

            if (historySection.classList.contains('active')) {
                historySection.classList.remove('active');
                toggleText.textContent = '住转专 住专转 拽';
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            } else {
                historySection.classList.add('active');
                toggleText.textContent = '爪 住专转 拽';
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            }
        }

        /**
         * Renders the customer history table.
         * @param {string} customerName Customer name.
         * @param {string} customerAddress Customer address.
         */
        function renderCustomerHistoryTable(customerName, customerAddress) {
            const tableBody = document.querySelector('#customer-history-table tbody');
            const noHistoryMsg = document.getElementById('no-customer-history');
            tableBody.innerHTML = '';
            noHistoryMsg.classList.add('hidden');

            const customerHistory = allOrders.filter(order =>
                (order['砖 拽'] || '').trim() === customerName.trim() &&
                (order['转转'] || '').trim() === customerAddress.trim()
            ).sort((a, b) => new Date(b['转专 ']) - new Date(a['转专 ']));

            if (customerHistory.length === 0) {
                noHistoryMsg.classList.remove('hidden');
            } else {
                customerHistory.forEach(order => {
                    const row = tableBody.insertRow();
                    if (order['住住'] === '住专') {
                        row.classList.add('closed-order-row');
                    }
                    row.insertCell().setAttribute('data-label', '转专 ');
                    row.cells[0].textContent = formatDate(order['转专 ']);

                    row.insertCell().setAttribute('data-label', '转注');
                    row.cells[1].textContent = order['转注'] || '';

                    row.insertCell().setAttribute('data-label', '住 驻注');
                    row.cells[2].textContent = order['住 驻注'] || '';
                    
                    row.insertCell().setAttribute('data-label', '住驻专  专');
                    row.cells[3].textContent = String(order['住驻专  专'] || order['住驻专 转'] || '');

                    row.insertCell().setAttribute('data-label', '住驻专  注转');
                    row.cells[4].textContent = String(order['住驻专  注转'] || '');

                    row.insertCell().setAttribute('data-label', '住住');
                    row.cells[5].innerHTML = `<span class="${order['住住'] === '驻转' ? 'status-open' : order['住住'] === '专' ? 'status-overdue' : 'status-closed'}">${order['住住'] || ''}</span>`;

                    row.insertCell().setAttribute('data-label', ' 砖注专');
                    row.cells[6].textContent = order[' 砖注专'] || '';

                    row.insertCell().setAttribute('data-label', '转专 住专');
                    row.cells[7].textContent = formatDate(order['转专 住专']);
                });
            }
        }


        /**
         * Opens the container history modal.
         * @param {string} containerNum The container number.
         */
        function openContainerHistoryModal(containerNum) {
            const modal = document.getElementById('container-history-modal');
            const tableBody = document.querySelector('#container-history-table tbody');
            const noHistoryMsg = document.getElementById('no-container-history');
            document.getElementById('history-container-number').textContent = containerNum;
            tableBody.innerHTML = '';
            noHistoryMsg.classList.add('hidden');

            const containerHistory = allOrders.filter(order =>
                (String(order['住驻专  专'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim()) ||
                (String(order['住驻专  注转'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim()) ||
                (String(order['住驻专 转'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim())
            ).sort((a, b) => new Date(a['转专 ']) - new Date(b['转专 ']));

            if (containerHistory.length === 0) {
                noHistoryMsg.classList.remove('hidden');
            } else {
                containerHistory.forEach(order => {
                    const row = tableBody.insertRow();
                    row.insertCell().setAttribute('data-label', '转专 ');
                    row.cells[0].textContent = formatDate(order['转专 ']);

                    row.insertCell().setAttribute('data-label', '转注');
                    row.cells[1].textContent = order['转注'] || '';

                    row.insertCell().setAttribute('data-label', '砖 拽');
                    row.cells[2].textContent = order['砖 拽'] || '';

                    row.insertCell().setAttribute('data-label', '住 驻注');
                    row.cells[3].textContent = order['住 驻注'] || '';
                    
                    row.insertCell().setAttribute('data-label', '住驻专  专');
                    row.cells[4].textContent = String(order['住驻专  专'] || order['住驻专 转'] || '');

                    row.insertCell().setAttribute('data-label', '住驻专  注转');
                    row.cells[5].textContent = String(order['住驻专  注转'] || '');


                    let statusClass = '';
                    switch (order['住住']) {
                        case '驻转': statusClass = 'status-open'; break;
                        case '住专': statusClass = 'status-closed'; break;
                        case '专': statusClass = 'status-overdue'; break;
                        case '转/ 转拽': statusClass = 'status-pending'; break;
                        default: statusClass = 'status-warning'; break;
                    }
                    row.insertCell().setAttribute('data-label', '住住 ');
                    row.cells[6].innerHTML = `<span class="${statusClass}">${order['住住'] || ''}</span>`;

                    row.insertCell().setAttribute('data-label', '转专 住 爪驻');
                    row.cells[7].textContent = formatDate(order['转专 住 爪驻']);
                });
            }
            modal.classList.add('active');
        }

        /**
         * Closes the container history modal.
         */
        function closeContainerHistoryModal() {
            document.getElementById('container-history-modal').classList.remove('active');
        }

        /**
         * Returns data for the containers in use table.
         * This function was added so we can pass the data to the generic modal.
         * @returns {Array<Object>} List of containers in use.
         */
        function getContainersInUseData() {
            const containerStates = {};
            const sortedOrders = [...allOrders].sort((a, b) => {
                const dateA = new Date(a['转专 ']);
                const dateB = new Date(b['转专 ']);
                if (dateA.getTime() !== dateB.getTime()) { return dateA - dateB; }
                if (a['住 驻注'] === '专' && b['住 驻注'] === '注') return 1;
                if (a['住 驻注'] === '注' && b['住 驻注'] === '专') return -1;
                return 0;
            });

            sortedOrders.forEach(order => {
                const containersTaken = (String(order['住驻专  专'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const containersBrought = (String(order['住驻专  注转'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const orderDate = new Date(order['转专 ']);

                containersTaken.forEach(container => {
                    const currentState = containerStates[container] || { status: '驻', relatedOrder: null, latestEventDate: new Date('1970-01-01') };
                    if (orderDate.getTime() >= currentState.latestEventDate.getTime()) {
                        currentState.latestEventDate = orderDate;
                        currentState.relatedOrder = order;
                        if (order['住住'] !== '住专') {
                            currentState.status = '砖砖';
                        } else {
                            currentState.status = '驻';
                        }
                    }
                    containerStates[container] = currentState;
                });

                containersBrought.forEach(container => {
                    const currentState = containerStates[container] || { status: '驻', relatedOrder: null, latestEventDate: new Date('1970-01-01') };
                    if (orderDate.getTime() >= currentState.latestEventDate.getTime()) {
                        currentState.latestEventDate = orderDate;
                        currentState.relatedOrder = order;
                        if (order['住住'] !== '住专') {
                            currentState.status = '转 专';
                        } else {
                            currentState.status = '驻';
                        }
                    }
                    containerStates[container] = currentState;
                });
            });

            const inUseContainers = [];
            Object.entries(containerStates).forEach(([containerNum, state]) => {
                if (state.status === '砖砖' || state.status === '转 专') {
                    inUseContainers.push({
                        containerNum,
                        customer: state.relatedOrder ? state.relatedOrder['砖 拽'] : '',
                        orderDate: state.relatedOrder ? state.relatedOrder['转专 '] : '',
                        docId: state.relatedOrder ? state.relatedOrder['转注'] : '',
                        status: state.status
                    });
                }
            });
            return inUseContainers.sort((a, b) => a.containerNum.localeCompare(b.containerNum));
        }

        /**
         * Returns data for the available containers table.
         * This function was added so we can pass the data to the generic modal.
         * @returns {Array<Object>} List of available containers.
         */
        function getContainersAvailableData() {
            const containerStates = {};
            const sortedOrders = [...allOrders].sort((a, b) => {
                const dateA = new Date(a['转专 ']);
                const dateB = new Date(b['转专 ']);
                if (dateA.getTime() !== dateB.getTime()) { return dateA - dateB; }
                if (a['住 驻注'] === '专' && b['住 驻注'] === '注') return 1;
                if (a['住 驻注'] === '注' && b['住 驻注'] === '专') return -1;
                return 0;
            });

            sortedOrders.forEach(order => {
                const containersTaken = (String(order['住驻专  专'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const containersBrought = (String(order['住驻专  注转'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const orderDate = new Date(order['转专 ']);

                containersTaken.forEach(container => {
                    const currentState = containerStates[container] || { status: '驻', relatedOrder: null, latestEventDate: new Date('1970-01-01') };
                    if (orderDate.getTime() >= currentState.latestEventDate.getTime()) {
                        currentState.latestEventDate = orderDate;
                        currentState.relatedOrder = order;
                        if (order['住住'] !== '住专') {
                            currentState.status = '砖砖';
                        } else {
                            currentState.status = '驻';
                        }
                    }
                    containerStates[container] = currentState;
                });

                containersBrought.forEach(container => {
                    const currentState = containerStates[container] || { status: '驻', relatedOrder: null, latestEventDate: new Date('1970-01-01') };
                    if (orderDate.getTime() >= currentState.latestEventDate.getTime()) {
                        currentState.latestEventDate = orderDate;
                        currentState.relatedOrder = order;
                        if (order['住住'] !== '住专') {
                            currentState.status = '转 专';
                        } else {
                            currentState.status = '驻';
                        }
                    }
                    containerStates[container] = currentState;
                });
            });

            const availableContainers = [];
            const allContainerNumbers = new Set(allOrders.flatMap(order => {
                let containers = [];
                if (order['住驻专  专']) containers = containers.concat((String(order['住驻专  专'])).split(',').map(c => c.trim()).filter(c => c));
                if (order['住驻专  注转']) containers = containers.concat((String(order['住驻专  注转'])).split(',').map(c => c.trim()).filter(c => c));
                if (order['住驻专 转']) containers = containers.concat((String(order['住驻专 转'])).split(',').map(c => c.trim()).filter(c => c));
                return containers;
            }));

            allContainerNumbers.forEach(containerNum => {
                if (!containerStates[containerNum]) {
                    containerStates[containerNum] = { status: '驻', relatedOrder: null, latestEventDate: null };
                }
            });

            Object.entries(containerStates).forEach(([containerNum, state]) => {
                if (state.status === '驻') {
                    availableContainers.push({
                        containerNum,
                        returnDate: state.relatedOrder ? (state.relatedOrder['转专 住专'] || state.relatedOrder['转专 ']) : '',
                        relatedDocId: state.relatedOrder ? state.relatedOrder['转注'] : ''
                    });
                }
            });
            return availableContainers.sort((a, b) => a.containerNum.localeCompare(b.containerNum));
        }

        /**
         * Updates the container inventory page.
         */
        function updateContainerInventory() {
            const inUseTableBody = document.querySelector('#containers-in-use-table tbody');
            const availableTableBody = document.querySelector('#containers-available-table tbody');
            
            const noInUseMsg = document.getElementById('no-containers-in-use');
            const noAvailableMsg = document.getElementById('no-containers-available');
            

            inUseTableBody.innerHTML = '';
            availableTableBody.innerHTML = '';
            

            noInUseMsg.classList.add('hidden');
            noAvailableMsg.classList.add('hidden');
            
            const inUseContainers = getContainersInUseData();
            const availableContainers = getContainersAvailableData();

            // Render "In Use" table
            if (inUseContainers.length === 0) {
                noInUseMsg.classList.remove('hidden');
            } else {
                inUseContainers.forEach(item => {
                    const row = inUseTableBody.insertRow();
                    row.insertCell().setAttribute('data-label', '住驻专 ');
                    row.cells[0].textContent = item.containerNum;

                    row.insertCell().setAttribute('data-label', '拽');
                    row.cells[1].textContent = item.customer;

                    row.insertCell().setAttribute('data-label', '转专 驻注');
                    row.cells[2].textContent = formatDate(item.orderDate);

                    row.insertCell().setAttribute('data-label', '转注');
                    row.cells[3].textContent = item.docId;

                    row.insertCell().setAttribute('data-label', '住住');
                    let statusClass = '';
                    if (item.status === '砖砖') { statusClass = 'status-overdue'; }
                    else if (item.status === '转 专') { statusClass = 'status-warning'; }
                    row.cells[4].innerHTML = `<span class="${statusClass}">${item.status}</span>`;
                });
            }

            // Render "Available" table
            if (availableContainers.length === 0) {
                noAvailableMsg.classList.remove('hidden');
            } else {
                availableContainers.forEach(item => {
                    const row = availableTableBody.insertRow();
                    row.insertCell().setAttribute('data-label', '住驻专 ');
                    row.cells[0].textContent = item.containerNum;

                    row.insertCell().setAttribute('data-label', '转专 驻');
                    row.cells[1].textContent = formatDate(item.returnDate);

                    row.insertCell().setAttribute('data-label', ' 拽砖专');
                    row.cells[2].textContent = item.relatedDocId;
                });
            }
        }

        /**
         * Returns data for the treatment board table.
         * This function was added so we can pass the data to the generic modal.
         * @returns {Array<Object>} List of orders for treatment.
         */
        function getTreatmentData() {
            const ordersForTreatment = allOrders.filter(o => o['住住'] === '专' || (o['
