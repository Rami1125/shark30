// Function to handle POST requests (for adding and updating data)
function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetName = "נתונים"; // Adjust to your sheet name
  var sheet = ss.getSheetByName(sheetName);

  var result = {};
  try {
    var data = JSON.parse(e.postData.contents);
    var action = e.parameter.action;

    if (action === 'addOrder') {
      // Logic for adding a new order (already exists in your current GAS)
      // Example:
      var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      var newRow = [];
      for (var i = 0; i < headers.length; i++) {
        newRow.push(data[headers[i]] !== undefined ? data[headers[i]] : '');
      }
      sheet.appendRow(newRow);
      result = { success: true, message: "Order added successfully" };

    } else if (action === 'updateOrder') {
      // NEW LOGIC FOR UPDATING AN ORDER
      var docIdToUpdate = data['תעודה'];
      if (!docIdToUpdate) {
        throw new Error("Missing 'תעודה' for update operation.");
      }

      var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      var dataRange = sheet.getDataRange();
      var values = dataRange.getValues();
      var rowIndex = -1;

      // Find the row by 'תעודה' (Document ID)
      for (var i = 1; i < values.length; i++) { // Start from 1 to skip headers
        if (String(values[i][headers.indexOf('תעודה')]) === String(docIdToUpdate)) {
          rowIndex = i;
          break;
        }
      }

      if (rowIndex !== -1) {
        // Update the row with new data
        var updatedRow = values[rowIndex]; // Get current row to modify
        for (var i = 0; i < headers.length; i++) {
          var header = headers[i];
          if (data[header] !== undefined) {
            updatedRow[i] = data[header];
          }
        }
        sheet.getRange(rowIndex + 1, 1, 1, updatedRow.length).setValues([updatedRow]);
        result = { success: true, message: "Order updated successfully" };
      } else {
        throw new Error("Order with 'תעודה' " + docIdToUpdate + " not found.");
      }

    } else if (action === 'getData') {
        // Logic for getting data (already exists in your current GAS)
        // Example:
        var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
        var dataValues = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).getValues();

        var parsedData = dataValues.map(function(row) {
            var obj = {};
            for (var i = 0; i < headers.length; i++) {
                obj[headers[i]] = row[i];
            }
            return obj;
        });
        result = { success: true, data: parsedData };

    } else if (action === 'logWhatsAppMessage') {
        // Logic for logging WhatsApp messages (already exists in your current GAS)
        // Example:
        var logsSheet = ss.getSheetByName("WhatsApp Logs"); // Ensure you have this sheet
        if (!logsSheet) {
            logsSheet = ss.insertSheet("WhatsApp Logs");
            logsSheet.appendRow(["Timestamp", "Doc ID", "Message"]);
        }
        var docId = e.parameter.docId;
        var message = e.parameter.message;
        logsSheet.appendRow([new Date(), docId, message]);
        result = { success: true, message: "WhatsApp message logged successfully." };
    }
     else {
      throw new Error("Invalid action: " + action);
    }
  } catch (error) {
    result = { success: false, message: error.message };
  }

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}
